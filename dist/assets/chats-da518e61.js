import{H as Ne,h as g,i as ue,I as pe,j as D,J as I,D as ge,g as N,o as u,c as $,a as e,n as l,u as s,F as he,r as ve,d as j,e as y,t as h,f as _,b as me,k as T,p as Ue,m as Ie,_ as ke,C as Oe,l as Ae,G as Me,U as Be,q as we,K as Fe,L as Pe}from"./index-59f8091d.js";import{u as Re}from"./chat-ea56bb5e.js";import{c as $e,P as We}from"./Messages.vue_vue_type_style_index_0_scoped_09e7a26a_lang-8323c448.js";/* empty css                                                             */import Je from"./Messages-2f26107f.js";const ye=R=>(Ue("data-v-8335594d"),R=R(),Ie(),R),Ke={class:"sidebar-container",style:{position:"relative"}},qe={class:"header"},He=ye(()=>e("strong",null," Notificaciones ",-1)),Ge=[He],Xe=["onClick"],Ye={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},Ze={style:{display:"flex","flex-direction":"column",width:"100%"}},Qe=ye(()=>e("h3",null,[e("b",null," Buscar un usuario")],-1)),et=["onClick"],tt={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},at={style:{"grid-area":"check",display:"flex","justify-content":"end",gap:".5rem"}},st={key:0,style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold"}},ot={style:{color:"white"}},it=ye(()=>e("i",{style:{color:"greenyellow"},class:"fa-solid fa-check-double"},null,-1)),rt={key:1,style:{"text-align":"center",padding:".5rem",color:"#ffffff80"}},nt={class:"flex align-items-center"},lt=["src"],ct={class:"flex align-items-center"},dt=["src"],ut={style:{display:"flex",gap:"1rem"}},pt={style:{color:"white"}},mt={class:"statuses"},ft={key:0,style:{display:"flex","justify-content":"end",margin:"0rem 0",gap:"1rem",padding:"1rem 1rem"}},_t=["onClick"],ht={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},vt={style:{"grid-area":"check",display:"flex","justify-content":"end",gap:".5rem"}},gt={key:0,style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold"}},yt={style:{color:"white"}},bt=ye(()=>e("i",{style:{color:"greenyellow"},class:"fa-solid fa-check-double"},null,-1)),xt={style:{display:"flex","justify-content":"center",margin:"2rem 0",gap:"1rem"}},wt={key:1,style:{"text-align":"center",padding:".5rem",color:"#ffffff80"}},je=1e3,kt=Ne({__name:"Sidebar",props:{restaurant:Object},setup(R){const w=g(!1),P=g(!1),oe=g(""),ne=g(!1),V=g(100),G=g(0),X=()=>{V.value>=100&&(V.value-=100,G.value-=100)},x=t=>{t.target.closest(".notifications")||(w.value=!1)};ue(()=>{document.addEventListener("click",x)}),pe(()=>{document.removeEventListener("click",x)});const m=$e(),Y=R,p=Re(),O=[{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"},{id:7,name:"Distrimoster",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"}],d=g(Y.restaurant||O[0]);g([{label:"Todos",textColor:"#4CAF50"},{label:"Sin leer",textColor:"#2196F3"},{label:"Favoritos",textColor:"#FFC107"},{label:"Preocupantes",textColor:"#F44336"},{label:"Top",textColor:"#9C27B0"}]);const Z=async t=>{p.current_user=t,P.value=!1,w.value=!1;try{await D.post(`${I}/read-message/${t.user_id}/${d.value.id}`,!1)}catch(r){console.error("No se pudo marcar como leído",r)}t.unreaded=0},fe=async t=>{var r;p.current_user=t.user_info,w.value=!1;try{await D.post(`${I}/read-message/${t.user_info.user_id}/${d.value.id}`,!1),await D.post(`${I}/view_notification/${t.id}`,!1),p.notifications[d.value.id]=await D.get(`${I}/notifications/${d.value.id}`);const n=(r=p.sidebars[d.value.id])==null?void 0:r.findIndex(b=>b.user_id==t.user_info.user_id);console.log(n),n!==-1&&(p.sidebars[d.value.id][n].unreaded=0)}catch(n){console.error("No se pudo marcar como leído",n)}},Q=[{label:"SIN LEER",bg:"#f39c12",icon:"fa-solid fa-envelope-open"},{label:"LEIDOS",bg:"#16a085",icon:"fa-solid fa-envelope-circle-check"}],A=g({label:"SIN LEER",bg:"#f39c12",icon:"fa-solid fa-envelope-open"}),le=g(0);let C=0;const L=g(!1),W=g(!1),E=g(null),ee=(t="")=>{const r=t.trim().split(" ");return(Array.from(r[0]||"")[0]||"")+(r[1]?Array.from(r[1])[0]:"")};ue(async()=>{p.notifications[d.value.id]=await D.get(`${I}/notifications/${d.value.id}`)});const M=t=>t==="9+"?10:Number(t??0),be=(t,r)=>{const n=p.sidebars[t]||[];r.forEach(b=>{const S=n.findIndex(k=>k.wa_id===b.wa_id);if(S===-1)n.push(b);else{const k=n[S],B=k.ultimo_mensaje_id!==b.ultimo_mensaje_id,re=k.color!==b.color,te=k.nombre!==b.nombre,ae=b.unreaded!=k.unreaded;(B||ae||re||te)&&(n[S]=b)}}),p.sidebars[t]=n,le.value=n.reduce((b,S)=>b+M(S.unreaded),0)},_e=g(!1),ce=async()=>{if(L.value||W.value)return;L.value=!0;const t=`${I}/last-contact-messages/${d.value.id}?limit=${je}&offset=${C}&clasificacion=${A.value.label}`,r=await D.get(t,!1);r.length<je&&(W.value=!0),C+=r.length,be(d.value.id,r),L.value=!1};let J=g(!0);const K=async()=>{var n;const t=E.value;if(!t||L.value||W.value||!J)return;if(t.scrollTop+t.clientHeight>=t.scrollHeight-100){if(_e.value=!0,V.value,J.value)if(G.value+100>=((n=p.sidebars[d.value])==null?void 0:n.length)){V.value=1e3;return}else V.value+=100,J.value=!1;setTimeout(()=>{J.value=!0},1e3)}};ge(A,()=>{E.value.scrollTo({top:0}),V.value=100});const xe=t=>{const r=d.value.id,n=p.sidebars[r]||[],b=n.findIndex(S=>S.wa_id===t.wa_id);b!==-1?(n.splice(b,1),p.sidebars[r]=[t,...n]):p.sidebars[r]=[t,...n],le.value=p.sidebars[r].reduce((S,k)=>S+Number(k.unreaded||0),0)};let z=null;const ie=()=>{const t=`wss://sockets-service.salchimonster.com/ws/salchimonster-${d.value.id}`;z=new WebSocket(t),z.onopen=()=>console.log("WebSocket conectado a",t),z.onerror=r=>console.error("WebSocket error",r),z.onclose=()=>setTimeout(ie,5e3),z.onmessage=async r=>{const n=JSON.parse(r.data);n!=null&&n.user_id&&xe(n)}};let q=null;const i=()=>{const t=`wss://sockets-service.salchimonster.com/ws/salchimonster-notifications-${d.value.id}`;q=new WebSocket(t),q.onopen=()=>console.log("WebSocket conectado a",t),q.onerror=r=>console.error("WebSocket error",r),q.onclose=()=>setTimeout(i,5e3),q.onmessage=async r=>{p.notifications[d.value.id]=await D.get(`${I}/notifications/${d.value.id}`),ne.value=!0,setTimeout(()=>{ne.value=!1},1e3),JSON.parse(r.data)}};ge(d,async t=>{C=0,W.value=!1,p.sidebars[t.id]=[],z&&z.close(),ie(),i(),await ce(),o.value=!1,setTimeout(()=>{o.value=!0},0)}),ue(async()=>{var t;await ce(),(t=E.value)==null||t.addEventListener("scroll",K),ie(),i()}),pe(()=>{var t;(t=E.value)==null||t.removeEventListener("scroll",K),z&&z.close()});const o=g(!0),c=t=>{A.value=t,o.value=!1,setTimeout(()=>{o.value=!0},0)};return(t,r)=>{var te,ae,v,U,H,se,de;const n=N("RouterLink"),b=N("InputText"),S=N("ProgressSpinner"),k=N("Button"),B=N("Dialog"),re=N("Dropdown");return u(),$("div",Ke,[e("div",qe,[e("div",{class:"notifications",style:l([w.value?{height:"calc(100vh - 8rem)",top:"4rem",boxShadow:"0 1rem 1rem #00000040"}:{height:0,overflow:"hidden",top:"-2rem"},{width:"100%","max-width":"90%","background-color":"#ffffff90","max-height":"90vh",overflow:"auto",position:"absolute","z-index":"9",transition:"all linear .2s","border-radius":".5rem",right:"0","backdrop-filter":"blur(5px)",display:"flex","flex-direction":"column"}])},[e("h4",{class:"my-3 px-3",style:l(s(m).current_chat_theme.text)},Ge,4),(u(!0),$(he,null,ve((ae=(te=s(p))==null?void 0:te.notifications)==null?void 0:ae[d.value.id],(a,f)=>(u(),j(n,{"active-class":s(m).current_chat_theme.name==="dark"?"active":"active-light",key:f,to:`/chat/chats/messages/${d.value.id}/${a.user_info.wa_id}/${(a.user_info.nombre||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^A-Za-z0-9_-]/g,"")||"n"}/${a.user_info.color}?expirado=${a.user_info.expirado}&expira-en=${a.user_info.tiempo_para_expirar}`},{default:y(()=>[e("div",{class:"chat2",onClick:()=>fe(a),style:l(a.resolved?"background-color: #fff":"background-color: #b6f8ff59")},[e("div",Ye,[e("div",{style:l([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${a.user_info.color||"black"}`])},h(ee(a.user_info.nombre)),5)]),e("div",{style:l([{"grid-area":"nombre"},`${s(m).current_chat_theme.text} ; ${a.resolved?"":"font-weight: bold;"}`])},h(a.description),5),e("span",{style:l([{"grid-area":"mensaje",color:"#ffffff80",opacity:".5"},s(m).current_chat_theme.text])},h(a.user_info.nombre.slice(0,20))+"... ",5),e("p",{class:"p-0 m-0",style:l([{"grid-area":"fecha","text-align":"end","min-width":"max-content"},s(m).current_chat_theme.text])},h(a.user_info.hora_ultimo_mensaje),5)],12,Xe)]),_:2},1032,["active-class","to"]))),128))],4),_(B,{closable:!1,header:"Buscar un usuario",visible:P.value,"onUpdate:visible":r[2]||(r[2]=a=>P.value=a),style:{width:"50rem"},modal:""},{header:y(()=>[e("div",Ze,[Qe,_(b,{modelValue:oe.value,"onUpdate:modelValue":r[0]||(r[0]=a=>oe.value=a),style:{width:"100%"},placeholder:"Escriba el nombre o numero del usuario"},null,8,["modelValue"])])]),default:y(()=>{var a;return[e("div",{class:me(["",o.value?"chats active-new":"chats"]),style:{height:"67vh"},ref_key:"chatsContainer",ref:E,onScroll:K},[(u(!0),$(he,null,ve(((a=s(p).sidebars[d.value.id])==null?void 0:a.filter(f=>{var Ce,Ee,Te,Le;const F=((Ee=(Ce=oe.value)==null?void 0:Ce.toLowerCase())==null?void 0:Ee.trim())||"";if(F==="")return!1;const ze=((Te=f.nombre)==null?void 0:Te.toLowerCase())||"",Ve=((Le=f.wa_id)==null?void 0:Le.toLowerCase())||"";return ze.includes(F)||Ve.includes(F)}))||[],(f,F)=>(u(),j(n,{"active-class":s(m).current_chat_theme.name=="dark"?"active":"active-light",key:F,to:`/chat/chats/messages/${d.value.id}/${f.wa_id}/${f.nombre}/${f.color}?expirado=${f.expirado}&?expira-en?=${f.tiempo_para_expirar}`},{default:y(()=>[e("div",{class:"chat",onClick:()=>Z(f)},[e("div",tt,[e("div",{style:l([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${f.color||"black"}`])},h(ee(f.nombre)),5)]),e("div",{style:l([{"grid-area":"nombre","text-transform":"capitalize","font-weight":"500"},s(m).current_chat_theme.text])},h(f.nombre),5),e("div",{style:l([{"grid-area":"numero","text-transform":"capitalize",opacity:".7"},s(m).current_chat_theme.text])},"+"+h(f.wa_id),5),e("span",{style:l([{"grid-area":"mensaje",color:"#ffffff80",opacity:".5"},s(m).current_chat_theme.text])},h(f.mensaje_truncado),5),e("span",{style:l([{"grid-area":"fecha","text-align":"end"},s(m).current_chat_theme.text])},h(f.abreviatura||f.fecha_ultimo_mensaje),5),e("span",{style:l([{"grid-area":"hora",color:"#ffffff80",opacity:".5","text-align":"end"},s(m).current_chat_theme.text])},h(f.hora_ultimo_mensaje),5),e("div",at,[f.unreaded>0?(u(),$("div",st,[e("span",ot,h(f.unreaded),1)])):T("",!0),it])],8,et)]),_:2},1032,["active-class","to"]))),128)),L.value?(u(),$("div",{key:0,style:l(`bottom:0;padding-bottom:1rem; background:linear-gradient(to bottom , transparent 3%, ${s(m).current_chat_theme.gradient});display:flex; position: absolute; z-index: 100;width:100%; color: white`)},[(u(),j(S,{key:0,style:{width:"50px",height:"50px"},strokeWidth:"8",fill:"transparent",animationDuration:".3s","aria-label":"Custom ProgressSpinner"}))],4)):T("",!0),W.value?(u(),$("div",rt,"No hay más chats.")):T("",!0)],34),_(k,{rounded:"",onClick:r[1]||(r[1]=f=>P.value=!1),icon:"pi pi-times  text-xl",style:{position:"absolute",top:"-1rem",right:"-1rem"},severity:"danger"})]}),_:1},8,["visible"]),_(re,{modelValue:d.value,"onUpdate:modelValue":r[3]||(r[3]=a=>d.value=a),options:O,optionLabel:"name",style:l([{"background-color":"#ffffff20",outline:"none","box-shadow":"none"},s(m).current_chat_theme.border])},{option:y(a=>[e("div",nt,[e("img",{src:a.option.img,alt:"Logo",style:{width:"24px",height:"24px","margin-right":"8px","object-fit":"contain"}},null,8,lt),e("span",null,[e("b",null,h(a.option.name),1)])])]),value:y(a=>[e("div",ct,[a.value?(u(),$("img",{key:0,src:a.value.img,alt:"Logo",style:{width:"24px",height:"24px","margin-right":"8px","object-fit":"contain"}},null,8,dt)):T("",!0),e("span",{style:l(s(m).current_chat_theme.text)},h(a.value?a.value.name:"Selecciona"),5)])]),_:1},8,["modelValue","style"]),e("div",ut,[_(k,{class:"options",text:""},{default:y(()=>[e("i",{class:"pi pi-search text-2xl",onClick:r[4]||(r[4]=a=>P.value=!0),style:l(s(m).current_chat_theme.text)},null,4)]),_:1}),e("div",{class:"notifications",style:{position:"relative",cursor:"pointer"},onClick:r[5]||(r[5]=a=>w.value=!w.value)},[_(k,{class:"options",text:"",style:{opacity:".5"}},{default:y(()=>[e("i",{class:"pi pi-bell text-2xl notifications",style:l(s(m).current_chat_theme.text)},null,4)]),_:1}),e("div",{class:me(ne.value?"load":""),style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",position:"absolute",top:"-1rem",right:"-.7rem",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold",padding:".8rem"}},[e("span",pt,h(((H=(U=(v=s(p))==null?void 0:v.notifications)==null?void 0:U[d.value.id])==null?void 0:H.length)||0),1)],2)]),_(k,{class:"options",text:""},{default:y(()=>[e("i",{class:"pi pi-bars text-2xl",style:l(s(m).current_chat_theme.text)},null,4)]),_:1})])]),e("div",mt,[(u(),$(he,null,ve(Q,(a,f)=>_(k,{style:l([{"border-radius":".3rem",padding:"0.3rem","text-transform":"capitalize"},a.label===A.value.label?{backgroundColor:a.bg,color:"#fff"}:{backgroundColor:"#ffffff20",color:a.bg}]),text:"",icon:a.icon,key:f,onClick:()=>c(a),class:"status",label:a.label.toLowerCase()},null,8,["icon","onClick","label","style"])),64))]),G.value>0?(u(),$("div",ft,[_(k,{disabled:L.value,icon:L.value?"pi pi-spin pi-spinner":"pi pi-angle-left",onClick:X,severity:"help",label:L.value?"cargando...":"atras"},null,8,["disabled","icon","label"])])):T("",!0),e("div",{class:me(["",o.value?"chats active-new":"chats"]),ref_key:"chatsContainer",ref:E,onScroll:K},[(u(!0),$(he,null,ve(((se=s(p).sidebars[d.value.id])==null?void 0:se.filter(a=>{if(A.value.label==="TODO")return!0;if(A.value.label==="SIN LEER")return a.unreaded>0;if(A.value.label==="LEIDOS")return a.unreaded==0}).slice(G.value,V.value))||[],(a,f)=>(u(),j(n,{"active-class":s(m).current_chat_theme.name=="dark"?"active":"active-light",key:f,to:`/chat/chats/messages/${d.value.id}/${a.wa_id}/${a.nombre}/${a.color}?expirado=${a.expirado}&?expira-en?=${a.tiempo_para_expirar}`},{default:y(()=>[e("div",{class:"chat",onClick:()=>Z(a)},[e("div",ht,[e("div",{style:l([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${a.color||"black"}`])},h(ee(a.nombre)),5)]),e("div",{style:l([{"grid-area":"nombre","text-transform":"capitalize","font-weight":"500"},s(m).current_chat_theme.text])},h(a.nombre),5),e("div",{style:l([{"grid-area":"numero","text-transform":"capitalize",opacity:".7"},s(m).current_chat_theme.text])},"+"+h(a.wa_id),5),e("span",{style:l([{"grid-area":"mensaje",color:"#ffffff80",opacity:".5"},s(m).current_chat_theme.text])},h(a.mensaje_truncado),5),e("span",{style:l([{"grid-area":"fecha","text-align":"end"},s(m).current_chat_theme.text])},h(a.abreviatura||a.fecha_ultimo_mensaje),5),e("span",{style:l([{"grid-area":"hora",color:"#ffffff80",opacity:".5","text-align":"end"},s(m).current_chat_theme.text])},h(a.hora_ultimo_mensaje),5),e("div",vt,[a.unreaded>0?(u(),$("div",gt,[e("span",yt,h(a.unreaded),1)])):T("",!0),bt])],8,_t)]),_:2},1032,["active-class","to"]))),128)),L.value&&((de=s(p).sidebars[d.value.id])==null?void 0:de.length)<2?(u(),$("div",{key:0,style:l(`bottom:0;padding-bottom:1rem; background:linear-gradient(to bottom , transparent 3%, ${s(m).current_chat_theme.gradient});display:flex; position: absolute; z-index: 100;width:100%; color: white`)},[(u(),j(S,{key:0,style:{width:"50px",height:"50px"},strokeWidth:"8",fill:"transparent",animationDuration:".3s","aria-label":"Custom ProgressSpinner"}))],4)):T("",!0),e("div",xt,[_(k,{disabled:L.value,icon:L.value?"pi pi-spin pi-spinner":"",onClick:ce,severity:"help",label:L.value?"cargando...":"Cargar mas"},null,8,["disabled","icon","label"])]),W.value?(u(),$("div",wt,"No hay más chats.")):T("",!0)],34)])}}}),De=ke(kt,[["__scopeId","data-v-8335594d"]]),Se=R=>(Ue("data-v-ed74fb8a"),R=R(),Ie(),R),$t={class:"top-bar-left"},St={style:{height:"3rem",width:"3rem",display:"flex","align-items":"center"}},Ct={class:"top-bar-info"},Et={style:{display:"flex","flex-direction":"column"}},Tt={style:{display:"flex","align-items":"center",gap:"1rem"}},Lt={style:{height:"100%",overflow:"auto"}},jt={class:"message-area"},Dt=Se(()=>e("i",{class:"fas fa-laugh-wink emoji-picker"},null,-1)),Nt=["onKeydown"],Ut=["src"],It={style:{position:"relative",transition:".2s"}},Rt=Se(()=>e("i",{class:"pi pi-send text-2xl"},null,-1)),zt={style:{display:"flex",gap:"1rem"}},Vt=["src"],Ot={class:"flex gap-2"},At=Se(()=>e("div",{style:{width:"100%",display:"flex","justify-content":"end"}},null,-1)),Mt=Ne({__name:"Main",setup(R){const w=$e();function P(i){return{APPROVED:"success",PENDING:"warning",REJECTED:"danger"}[i]||"info"}const oe=i=>{ne(i),X.value=!1};async function ne(i){const o=i,c=new FormData;c.append("messaging_product","whatsapp"),c.append("employer_id",m.rawUserData.id.toString()),c.append("context_message_id",""),c.append("restaurant_id",x.params.restaurant_id),c.append("to",x.params.user_id),c.append("type","template"),c.append("template",JSON.stringify(o));try{C.sending=!0,await D.post(`${I}/webhook/send/template/`,c,!1),console.log(`✅ Template enviado a ${to}`)}catch(t){console.error(`✗ Error al enviar template a ${to}`,t)}finally{C.sending=!1}}const V=g([{}]),G=i=>{i.target.closest(".emoji-picker")||(Y.value=!1)};ue(()=>{document.addEventListener("click",G),q()}),pe(()=>{document.removeEventListener("click",G)});const X=g(!1);g([]);const x=Oe(),m=Ae(),Y=g(!1),p=g(""),O=g(!1),d=g(null),Z=g(!1),fe=g(!0),Q=Me(()=>{var i,o;return fe.value&&(((i=x.query)==null?void 0:i.expirado)==="true"||((o=x.query)==null?void 0:o.expirado)===!0)}),A=i=>{fe.value=i};ge(()=>{var i;return(i=x.params)==null?void 0:i.restaurant_id},()=>{q()}),ge(Q,i=>{p.value=i?"Conversación expirada":""},{immediate:!0});const le={"SIN DATOS":{bg:"#7f8c8d",icon:"fa-circle-question"},PREOCUPANTE:{bg:"#e74c3c",icon:"fa-triangle-exclamation"},CASUAL:{bg:"#e67e22",icon:"fa-person-walking"},FRECUENTE:{bg:"#27ae60",icon:"fa-repeat"},TOP:{bg:"#2980b9",icon:"fa-ranking-star"},ESTRELLA:{bg:"#8e44ad",icon:"fa-star"}},C=Re();g([{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"},{id:7,name:"Distrimoster",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"}]);const L=(i="")=>{const o=i.trim().split(" ");return(Array.from(o[0]||"")[0]||"")+(o[1]?Array.from(o[1])[0]:"")},W=i=>{p.value+=i.i,Y.value=!1};let E=null,ee=[],M=null;const be=async()=>{if(O.value&&E){E.stop();return}try{M=await navigator.mediaDevices.getUserMedia({audio:!0});const i=MediaRecorder.isTypeSupported("audio/ogg;codecs=opus")?"audio/ogg;codecs=opus":"audio/webm;codecs=opus";E=new MediaRecorder(M,{mimeType:i}),E.ondataavailable=o=>o.data.size&&ee.push(o.data),E.onstop=()=>{const o=new Blob(ee,{type:i.split(";")[0]});ee=[],M.getTracks().forEach(t=>t.stop());const c=i.startsWith("audio/ogg")?"ogg":"webm";d.value={file:new File([o],`audio_${Date.now()}.${c}`,{type:o.type}),url:URL.createObjectURL(o)},O.value=!1},E.start(),O.value=!0}catch(i){console.error("No se pudo abrir el micrófono:",i.name,i.message),O.value=!1,M&&M.getTracks().forEach(o=>o.stop())}},_e=()=>{d.value&&URL.revokeObjectURL(d.value.url),d.value=null};pe(()=>{E&&O.value&&E.stop(),M&&M.getTracks().forEach(i=>i.stop())});const ce={messaging_product:"whatsapp",employer_id:m.rawUserData.id,context_message_id:null},J=async(i,o=null)=>{var t,r;if(Q.value||!i.trim())return;const c=new FormData;c.append("messaging_product","whatsapp"),c.append("employer_id",m.rawUserData.id),c.append("context_message_id",((t=o==null?void 0:o.message_data)==null?void 0:t.wa_id)||null),c.append("restaurant_id",(r=x.params.restaurant_id)==null?void 0:r.toString()),c.append("to",x.params.user_id),c.append("type","text"),c.append("text",JSON.stringify({body:i})),p.value="";try{C.sending=!0,await D.post(`${I}/webhook/send/text/`,c,!1)}catch(n){console.error("Error al enviar texto",n)}C.sending=!1},K=async()=>{var t;if(Q.value||!d.value||Z.value)return;const i=d.value;_e(),Z.value=!0;const o=new FormData;o.append("files",i.file);const c={...ce,restaurant_id:(t=x.params.restaurant_id)==null?void 0:t.toString(),to:x.params.user_id,type:"audio",text:{body:""},file_index:0};o.append("payloads",JSON.stringify(c));try{await D.post(`${I}/webhook/send`,o,!1)}catch(r){console.error("Error al enviar audio",r)}Z.value=!1},xe=async i=>{var r;if(Q.value||!(i!=null&&i.length))return;const o=new FormData,c={restaurant_id:(r=x.params.restaurant_id)==null?void 0:r.toString(),to:x.params.user_id,messaging_product:"whatsapp",employer_id:m.rawUserData.id,context_message_id:null},t=n=>{var B;const{type:b,name:S}=n;if(b.startsWith("image/"))return"image";if(b.startsWith("audio/"))return"audio";if(b.startsWith("video/"))return"video";if(b==="application/pdf")return"document";const k=(B=S.split(".").pop())==null?void 0:B.toLowerCase();return["jpg","jpeg","png","webp"].includes(k)?"image":["mp3","wav","ogg","opus"].includes(k)?"audio":"document"};i.forEach((n,b)=>{o.append("files",n.file),o.append("payloads",JSON.stringify({...c,type:t(n.file),text:{body:n.caption||""},file_index:b}))}),C.sending=!0;try{await D.post(`${I}/webhook/send`,o,!1)}catch(n){console.error("Error al enviar archivos",n)}C.sending=!1},z=i=>{i.key==="Enter"&&(i.preventDefault(),p.value.trim()&&J(p.value))},ie=i=>{i.key==="Enter"&&d.value&&(i.preventDefault(),K())};ue(()=>window.addEventListener("keydown",ie)),pe(()=>window.removeEventListener("keydown",ie));async function q(){if(x.params.restaurant_id){const o=(await D.get(`${Be}/restaurants`)||[]).find(c=>{var t;return c.id==((t=x.params)==null?void 0:t.restaurant_id)})||null;o&&(V.value=await D.get(`${I}/wabas/${o.waba_id}/templates/`))}}return(i,o)=>{var B,re,te,ae;const c=N("Button"),t=N("RouterView"),r=N("Textarea"),n=N("Column"),b=N("Tag"),S=N("DataTable"),k=N("Dialog");return u(),$("div",{class:"main-container",style:l([s(w).current_chat_theme.bg_image,{}])},[(B=s(x).params)!=null&&B.user_id?(u(),$("div",{key:0,tabindex:"0",class:"top-bar",style:l([{"border-radius":".5rem",gap:"1rem"},s(w).current_chat_theme.bg_bars])},[e("div",$t,[e("div",St,[e("div",{class:"cliente-img",style:l([`background-color:${s(x).params.color}`,{height:"100%",color:"white",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"}])},h(L(s(x).params.user_name)),5)]),e("div",Ct,[e("div",Et,[e("strong",null,[e("h5",{style:l([{"text-transform":"capitalize",margin:"0"},s(w).current_chat_theme.text])},h((re=s(x).params.user_name)==null?void 0:re.substring(0,20)),5)]),e("span",null,"+"+h(s(x).params.user_id),1)]),e("div",null,[s(C).current_user.clasification?(u(),j(c,{key:0,style:l({height:"2.3rem",display:"flex",alignItems:"center",textTransform:"capitalize",gap:"0.35rem",backgroundColor:((te=le[s(C).current_user.clasification])==null?void 0:te.bg)||"#7f8c8d",color:"#fff"})},{default:y(()=>{var v,U;return[e("i",{class:me(["fa-solid",(v=le[s(C).current_user.clasification])==null?void 0:v.icon]),"aria-hidden":"true",style:{"font-size":"0.9rem"}},null,2),we(" "+h((U=s(C).current_user.clasification)==null?void 0:U.toLowerCase())+" "+h(s(C).current_user.times_purchased)+" compras ",1)]}),_:1},8,["style"])):T("",!0)])])]),e("div",Tt,[_(c,{icon:"pi pi-shopping-cart",class:"p-2",style:{color:"white","min-width":"max-content"},severity:"warning",label:"Ing. Ped"}),_(c,{text:"",class:"p-2"},{default:y(()=>[e("i",{style:l(s(w).current_chat_theme.text),class:"pi pi-search text-2xl"},null,4)]),_:1}),_(c,{text:"",class:"p-2"},{default:y(()=>[e("i",{style:l(s(w).current_chat_theme.text),class:"pi pi-bars text-2xl"},null,4)]),_:1})])],4)):T("",!0),e("div",Lt,[_(t,null,{default:y(()=>[s(x).params.user_id?(u(),j(Je,{key:0,send_function:xe,send_text:J,change_expiration:A,ref:"Messages_element"},null,512)):T("",!0)]),_:1})]),(ae=s(x).params)!=null&&ae.user_id?(u(),$("div",{key:1,class:"chat-bar",tabindex:"0",style:l(s(w).current_chat_theme.bg_bars)},[Y.value?(u(),j(s(We),{key:0,native:!0,style:{position:"absolute",bottom:"4rem","z-index":"1000"},onSelect:W,class:"emoji-picker"})):T("",!0),e("div",jt,[_(c,{text:"",style:{"font-size":"2rem","padding-left":"0"},onClick:o[0]||(o[0]=v=>Y.value=!Y.value)},{default:y(()=>[Dt]),_:1}),d.value?(u(),$("div",{key:1,class:"audio-chip",onKeydown:Fe(Pe(K,["prevent"]),["enter"])},[e("audio",{style:{width:"100%","min-width":"28rem","max-width":"42rem"},src:d.value.url,controls:""},null,8,Ut),_(c,{text:"",class:"btn-audio-trash p-2",onClick:_e},{default:y(()=>[e("i",{style:l(s(w).current_chat_theme.text),class:"pi pi-trash text-2xl p-0"},null,4)]),_:1})],40,Nt)):(u(),j(r,{key:0,modelValue:p.value,"onUpdate:modelValue":o[1]||(o[1]=v=>p.value=v),autoResize:"",class:"message",disabled:Q.value,onKeydown:z,style:l(`${s(w).current_chat_theme.text} ; ${s(w).current_chat_theme.border} `)},null,8,["modelValue","disabled","style"]))]),e("div",It,[!d.value&&p.value.trim()===""?(u(),j(c,{key:0,text:"",style:{height:"100%"},onClick:be},{default:y(()=>[e("i",{style:l(s(w).current_chat_theme.text),class:me(O.value?"pi pi-stop text-2xl text-red-500":"pi pi-microphone text-2xl ")},null,6)]),_:1})):d.value?(u(),j(c,{key:1,disabled:Z.value,text:"",onClick:K},{default:y(()=>[e("i",{style:l(s(w).current_chat_theme.text),class:"pi pi-send text-2xl"},null,4)]),_:1},8,["disabled"])):(u(),j(c,{key:2,style:l(s(w).current_chat_theme.text),text:"",onClick:o[2]||(o[2]=v=>J(p.value))},{default:y(()=>[Rt]),_:1},8,["style"]))]),e("div",zt,[_(c,{severity:"danger",style:{},icon:"pi pi-clock",class:"p-2",onClick:o[3]||(o[3]=()=>X.value=!0)}),s(x).query.expirado?(u(),j(c,{key:0,icon:"pi pi-bolt",severity:"warning",style:{},class:"p-2",onClick:o[4]||(o[4]=()=>X.value=!0)})):T("",!0)])],4)):T("",!0),_(k,{visible:X.value,"onUpdate:visible":o[5]||(o[5]=v=>X.value=v),modal:"",header:"Envio de plantilla",style:{width:"90rem"}},{default:y(()=>[_(S,{value:V.value,dataKey:"id",paginator:"",rows:10,responsiveLayout:"scroll",class:"shadow-md rounded-xl overflow-hidden"},{default:y(()=>[_(n,{class:"my-1 py-1",field:"name",header:"Nombre",bodyClass:"font-medium"}),_(n,{class:"my-1 py-1",header:"Texto"},{body:y(({data:v})=>{var U,H;return[we(h((H=(U=v==null?void 0:v.components)==null?void 0:U.find(se=>se.type=="BODY"))==null?void 0:H.text),1)]}),_:1}),_(n,{class:"my-1 py-1",header:"Imagen"},{body:y(({data:v})=>{var U,H,se,de,a,f;return[(se=(H=(U=v==null?void 0:v.components)==null?void 0:U.find(F=>F.type=="HEADER"))==null?void 0:H.example)!=null&&se.header_handle[0]?(u(),$("img",{key:0,style:{height:"10rem",width:"10rem","aspect-ratio":"1 / 1","object-fit":"cover","border-radius":".5rem",border:"1px solid"},src:(f=(a=(de=v==null?void 0:v.components)==null?void 0:de.find(F=>F.type=="HEADER"))==null?void 0:a.example)==null?void 0:f.header_handle[0],alt:""},null,8,Vt)):T("",!0)]}),_:1}),_(n,{class:"my-1 py-1",header:"Estado"},{body:y(({data:v})=>[_(b,{severity:P(v.status)},{default:y(()=>[we(h(v.status),1)]),_:2},1032,["severity"])]),_:1}),_(n,{class:"my-1 py-1",headerStyle:"width:8rem",header:"Acciones"},{body:y(({data:v})=>[e("div",Ot,[_(c,{icon:"pi pi-send",label:"Enviar",severity:"help",onClick:U=>oe(v)},null,8,["onClick"])])]),_:1})]),_:1},8,["value"]),At]),_:1},8,["visible"])],4)}}}),Bt=ke(Mt,[["__scopeId","data-v-ed74fb8a"]]);const Ft={__name:"chats",setup(R){const w=$e();return(P,oe)=>(u(),$("div",{class:"chat-container",style:l(s(w).current_chat_theme.bg)},[_(De,{style:{"box-shadow":".5rem 0 1rem #00000010"},class:"sidebar-left",restaurant:{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"}}),_(Bt),_(De,{style:{"box-shadow":"-.5rem 0 1rem #00000010"},class:"sidebar-right",restaurant:{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"}})],4))}},Ht=ke(Ft,[["__scopeId","data-v-ef52e81a"]]);export{Ht as default};
