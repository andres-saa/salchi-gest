import{H as Te,h as v,i as me,I as pe,j as L,J as I,D as we,g as D,o as p,c as x,a as e,n as c,u as o,F as _e,r as he,d as T,e as g,t as f,f as h,b as fe,k as $,p as Le,m as De,_ as ke,C as Ne,l as Ue,G as Ie,U as Re,q as xe,K as Oe,L as Ae}from"./index-c6672384.js";import{u as je}from"./chat-7f576312.js";import{c as $e,P as ze}from"./Messages.vue_vue_type_style_index_0_scoped_09e7a26a_lang-b02bd79e.js";/* empty css                                                             */import Ve from"./Messages-d0abd731.js";const ge=R=>(Le("data-v-34b02823"),R=R(),De(),R),Me={class:"sidebar-container",style:{position:"relative"}},Pe={class:"header"},Be=ge(()=>e("strong",null," Notificaciones ",-1)),Fe=[Be],We=["onClick"],Je={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},Ke={style:{display:"flex","flex-direction":"column",width:"100%"}},qe=ge(()=>e("h3",null,[e("b",null," Buscar un usuario")],-1)),He=["onClick"],Ge={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},Xe={style:{"grid-area":"check",display:"flex","justify-content":"end",gap:".5rem"}},Ye={key:0,style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold"}},Ze={style:{color:"white"}},Qe=ge(()=>e("i",{style:{color:"greenyellow"},class:"fa-solid fa-check-double"},null,-1)),et={key:1,style:{"text-align":"center",padding:".5rem",color:"#ffffff80"}},tt={class:"flex align-items-center"},at=["src"],st={class:"flex align-items-center"},ot=["src"],it={style:{display:"flex",gap:"1rem"}},rt={style:{color:"white"}},nt={class:"statuses"},lt=["onClick"],ct={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},dt={style:{"grid-area":"check",display:"flex","justify-content":"end",gap:".5rem"}},ut={key:0,style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold"}},mt={style:{color:"white"}},pt=ge(()=>e("i",{style:{color:"greenyellow"},class:"fa-solid fa-check-double"},null,-1)),ft={key:1,style:{"text-align":"center",padding:".5rem",color:"#ffffff80"}},Ee=100,_t=Te({__name:"Sidebar",props:{restaurant:Object},setup(R){const y=v(!1),P=v(!1),Q=v(""),ae=v(!1),se=n=>{n.target.closest(".notifications")||(y.value=!1)};me(()=>{document.addEventListener("click",se)}),pe(()=>{document.removeEventListener("click",se)});const _=$e(),q=R,d=je(),H=[{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"},{id:7,name:"Distrimoster",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"}],u=v(q.restaurant||H[0]);v([{label:"Todos",textColor:"#4CAF50"},{label:"Sin leer",textColor:"#2196F3"},{label:"Favoritos",textColor:"#FFC107"},{label:"Preocupantes",textColor:"#F44336"},{label:"Top",textColor:"#9C27B0"}]);const j=async n=>{d.current_user=n,P.value=!1,y.value=!1;try{await L.post(`${I}/read-message/${n.user_id}/${u.value.id}`,!1)}catch(l){console.error("No se pudo marcar como leído",l)}n.unreaded=0},B=async n=>{var l;d.current_user=n.user_info,y.value=!1;try{await L.post(`${I}/read-message/${n.user_info.user_id}/${u.value.id}`,!1),await L.post(`${I}/view_notification/${n.id}`,!1),d.notifications[u.value.id]=await L.get(`${I}/notifications/${u.value.id}`);const t=(l=d.sidebars[u.value.id])==null?void 0:l.findIndex(a=>a.user_id==n.user_info.user_id);console.log(t),t!==-1&&(d.sidebars[u.value.id][t].unreaded=0)}catch(t){console.error("No se pudo marcar como leído",t)}},S=[{label:"SIN LEER",bg:"#f39c12",icon:"fa-solid fa-envelope-open"},{label:"LEIDOS",bg:"#16a085",icon:"fa-solid fa-envelope-circle-check"},{label:"TODO",bg:"#34495e",icon:"fa-solid fa-inbox"},{label:"SIN DATOS",bg:"#95a5a6",icon:"fa-solid fa-circle-question"},{label:"PREOCUPANTE",bg:"#e74c3c",icon:"fa-solid fa-triangle-exclamation"},{label:"CASUAL",bg:"#e67e22",icon:"fa-solid fa-person-walking"},{label:"FRECUENTE",bg:"#27ae60",icon:"fa-solid fa-repeat"},{label:"TOP",bg:"#2980b9",icon:"fa-solid fa-ranking-star"},{label:"ESTRELLA",bg:"#8e44ad",icon:"fa-solid fa-star"}],O=v({label:"SIN LEER",bg:"#f39c12",icon:"fa-solid fa-envelope-open"}),oe=v(0);let z=0;const F=v(!1),V=v(!1),w=v(null),ie=(n="")=>{const l=n.trim().split(" ");return(Array.from(l[0]||"")[0]||"")+(l[1]?Array.from(l[1])[0]:"")};me(async()=>{d.notifications[u.value.id]=await L.get(`${I}/notifications/${u.value.id}`)});const ve=n=>n==="9+"?10:Number(n??0),A=(n,l)=>{const t=d.sidebars[n]||[];l.forEach(a=>{const i=t.findIndex(m=>m.wa_id===a.wa_id);if(i===-1)t.push(a);else{const m=t[i],E=m.ultimo_mensaje_id!==a.ultimo_mensaje_id,b=m.color!==a.color,C=m.nombre!==a.nombre,J=a.unreaded!=m.unreaded;(E||J||b||C)&&(t[i]=a)}}),d.sidebars[n]=t,oe.value=t.reduce((a,i)=>a+ve(i.unreaded),0)},G=async()=>{if(F.value||V.value)return;F.value=!0;const n=`${I}/last-contact-messages/${u.value.id}?limit=${Ee}&offset=${z}`,l=await L.get(n,!1);l.length<Ee&&(V.value=!0),z+=l.length,A(u.value.id,l),F.value=!1},N=()=>{const n=w.value;if(!n||F.value||V.value)return;n.scrollTop+n.clientHeight>=n.scrollHeight-120&&G()},ye=n=>{const l=u.value.id,t=d.sidebars[l]||[],a=t.findIndex(i=>i.wa_id===n.wa_id);a!==-1?(t.splice(a,1),d.sidebars[l]=[n,...t]):d.sidebars[l]=[n,...t],oe.value=d.sidebars[l].reduce((i,m)=>i+Number(m.unreaded||0),0)};let U=null;const re=()=>{const n=`wss://sockets-service.salchimonster.com/ws/salchimonster-${u.value.id}`;U=new WebSocket(n),U.onopen=()=>console.log("WebSocket conectado a",n),U.onerror=l=>console.error("WebSocket error",l),U.onclose=()=>setTimeout(re,5e3),U.onmessage=async l=>{const t=JSON.parse(l.data);t!=null&&t.user_id&&ye(t)}};let M=null;const X=()=>{const n=`wss://sockets-service.salchimonster.com/ws/salchimonster-notifications-${u.value.id}`;M=new WebSocket(n),M.onopen=()=>console.log("WebSocket conectado a",n),M.onerror=l=>console.error("WebSocket error",l),M.onclose=()=>setTimeout(X,5e3),M.onmessage=async l=>{d.notifications[u.value.id]=await L.get(`${I}/notifications/${u.value.id}`),ae.value=!0,setTimeout(()=>{ae.value=!1},1e3),JSON.parse(l.data)}};we(u,async n=>{z=0,V.value=!1,d.sidebars[n.id]=[],U&&U.close(),re(),X(),await G(),W.value=!1,setTimeout(()=>{W.value=!0},0)}),me(async()=>{var n;await G(),(n=w.value)==null||n.addEventListener("scroll",N),re(),X()}),pe(()=>{var n;(n=w.value)==null||n.removeEventListener("scroll",N),U&&U.close()});const W=v(!0),be=n=>{O.value=n,W.value=!1,setTimeout(()=>{W.value=!0},0)};return(n,l)=>{var C,J,Y,K,ne,le;const t=D("RouterLink"),a=D("InputText"),i=D("ProgressSpinner"),m=D("Button"),E=D("Dialog"),b=D("Dropdown");return p(),x("div",Me,[e("div",Pe,[e("div",{class:"notifications",style:c([y.value?{height:"calc(100vh - 8rem)",top:"4rem",boxShadow:"0 1rem 1rem #00000040"}:{height:0,overflow:"hidden",top:"-2rem"},{width:"100%","max-width":"90%","background-color":"#ffffff90","max-height":"90vh",overflow:"auto",position:"absolute","z-index":"9",transition:"all linear .2s","border-radius":".5rem",right:"0","backdrop-filter":"blur(5px)",display:"flex","flex-direction":"column"}])},[e("h4",{class:"my-3 px-3",style:c(o(_).current_chat_theme.text)},Fe,4),(p(!0),x(_e,null,he((J=(C=o(d))==null?void 0:C.notifications)==null?void 0:J[u.value.id],(s,r)=>(p(),T(t,{"active-class":o(_).current_chat_theme.name==="dark"?"active":"active-light",key:r,to:`/chat/chats/messages/${u.value.id}/${s.user_info.wa_id}/${(s.user_info.nombre||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^A-Za-z0-9_-]/g,"")||"n"}/${s.user_info.color}?expirado=${s.user_info.expirado}&expira-en=${s.user_info.tiempo_para_expirar}`},{default:g(()=>[e("div",{class:"chat2",onClick:()=>B(s),style:c(s.resolved?"background-color: #fff":"background-color: #b6f8ff59")},[e("div",Je,[e("div",{style:c([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${s.user_info.color||"black"}`])},f(ie(s.user_info.nombre)),5)]),e("div",{style:c([{"grid-area":"nombre"},`${o(_).current_chat_theme.text} ; ${s.resolved?"":"font-weight: bold;"}`])},f(s.description),5),e("span",{style:c([{"grid-area":"mensaje",color:"#ffffff80",opacity:".5"},o(_).current_chat_theme.text])},f(s.user_info.nombre.slice(0,20))+"... ",5),e("p",{class:"p-0 m-0",style:c([{"grid-area":"fecha","text-align":"end","min-width":"max-content"},o(_).current_chat_theme.text])},f(s.user_info.hora_ultimo_mensaje),5)],12,We)]),_:2},1032,["active-class","to"]))),128))],4),h(E,{closable:!1,header:"Buscar un usuario",visible:P.value,"onUpdate:visible":l[2]||(l[2]=s=>P.value=s),style:{width:"50rem"},modal:""},{header:g(()=>[e("div",Ke,[qe,h(a,{modelValue:Q.value,"onUpdate:modelValue":l[0]||(l[0]=s=>Q.value=s),style:{width:"100%"},placeholder:"Escriba el nombre o numero del usuario"},null,8,["modelValue"])])]),default:g(()=>{var s;return[e("div",{class:fe(["",W.value?"chats active-new":"chats"]),style:{height:"67vh"},ref_key:"chatsContainer",ref:w,onScroll:N},[(p(!0),x(_e,null,he(((s=o(d).sidebars[u.value.id])==null?void 0:s.filter(r=>{var ce,de,ue,te;const k=((de=(ce=Q.value)==null?void 0:ce.toLowerCase())==null?void 0:de.trim())||"";if(k==="")return!1;const Z=((ue=r.nombre)==null?void 0:ue.toLowerCase())||"",ee=((te=r.wa_id)==null?void 0:te.toLowerCase())||"";return Z.includes(k)||ee.includes(k)}))||[],(r,k)=>(p(),T(t,{"active-class":o(_).current_chat_theme.name=="dark"?"active":"active-light",key:k,to:`/chat/chats/messages/${u.value.id}/${r.wa_id}/${r.nombre}/${r.color}?expirado=${r.expirado}&?expira-en?=${r.tiempo_para_expirar}`},{default:g(()=>[e("div",{class:"chat",onClick:()=>j(r)},[e("div",Ge,[e("div",{style:c([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${r.color||"black"}`])},f(ie(r.nombre)),5)]),e("div",{style:c([{"grid-area":"nombre","text-transform":"capitalize","font-weight":"500"},o(_).current_chat_theme.text])},f(r.nombre),5),e("div",{style:c([{"grid-area":"numero","text-transform":"capitalize",opacity:".7"},o(_).current_chat_theme.text])},"+"+f(r.wa_id),5),e("span",{style:c([{"grid-area":"mensaje",color:"#ffffff80",opacity:".5"},o(_).current_chat_theme.text])},f(r.mensaje_truncado),5),e("span",{style:c([{"grid-area":"fecha","text-align":"end"},o(_).current_chat_theme.text])},f(r.abreviatura||r.fecha_ultimo_mensaje),5),e("span",{style:c([{"grid-area":"hora",color:"#ffffff80",opacity:".5","text-align":"end"},o(_).current_chat_theme.text])},f(r.hora_ultimo_mensaje),5),e("div",Xe,[r.unreaded>0?(p(),x("div",Ye,[e("span",Ze,f(r.unreaded),1)])):$("",!0),Qe])],8,He)]),_:2},1032,["active-class","to"]))),128)),F.value?(p(),x("div",{key:0,style:c(`bottom:0;padding-bottom:1rem; background:linear-gradient(to bottom , transparent 3%, ${o(_).current_chat_theme.gradient});display:flex; position: absolute; z-index: 100;width:100%; color: white`)},[(p(),T(i,{key:0,style:{width:"50px",height:"50px"},strokeWidth:"8",fill:"transparent",animationDuration:".3s","aria-label":"Custom ProgressSpinner"}))],4)):$("",!0),V.value?(p(),x("div",et,"No hay más chats.")):$("",!0)],34),h(m,{rounded:"",onClick:l[1]||(l[1]=r=>P.value=!1),icon:"pi pi-times  text-xl",style:{position:"absolute",top:"-1rem",right:"-1rem"},severity:"danger"})]}),_:1},8,["visible"]),h(b,{modelValue:u.value,"onUpdate:modelValue":l[3]||(l[3]=s=>u.value=s),options:H,optionLabel:"name",style:c([{"background-color":"#ffffff20",outline:"none","box-shadow":"none"},o(_).current_chat_theme.border])},{option:g(s=>[e("div",tt,[e("img",{src:s.option.img,alt:"Logo",style:{width:"24px",height:"24px","margin-right":"8px","object-fit":"contain"}},null,8,at),e("span",null,[e("b",null,f(s.option.name),1)])])]),value:g(s=>[e("div",st,[s.value?(p(),x("img",{key:0,src:s.value.img,alt:"Logo",style:{width:"24px",height:"24px","margin-right":"8px","object-fit":"contain"}},null,8,ot)):$("",!0),e("span",{style:c(o(_).current_chat_theme.text)},f(s.value?s.value.name:"Selecciona"),5)])]),_:1},8,["modelValue","style"]),e("div",it,[h(m,{class:"options",text:""},{default:g(()=>[e("i",{class:"pi pi-search text-2xl",onClick:l[4]||(l[4]=s=>P.value=!0),style:c(o(_).current_chat_theme.text)},null,4)]),_:1}),e("div",{class:"notifications",style:{position:"relative",cursor:"pointer"},onClick:l[5]||(l[5]=s=>y.value=!y.value)},[h(m,{class:"options",text:"",style:{opacity:".5"}},{default:g(()=>[e("i",{class:"pi pi-bell text-2xl notifications",style:c(o(_).current_chat_theme.text)},null,4)]),_:1}),e("div",{class:fe(ae.value?"load":""),style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",position:"absolute",top:"-1rem",right:"-.7rem",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold",padding:".8rem"}},[e("span",rt,f(((ne=(K=(Y=o(d))==null?void 0:Y.notifications)==null?void 0:K[u.value.id])==null?void 0:ne.length)||0),1)],2)]),h(m,{class:"options",text:""},{default:g(()=>[e("i",{class:"pi pi-bars text-2xl",style:c(o(_).current_chat_theme.text)},null,4)]),_:1})])]),e("div",nt,[(p(),x(_e,null,he(S,(s,r)=>h(m,{style:c([{"border-radius":".3rem",padding:"0.3rem","text-transform":"capitalize"},s.label===O.value.label?{backgroundColor:s.bg,color:"#fff"}:{backgroundColor:"#ffffff20",color:s.bg}]),text:"",icon:s.icon,key:r,onClick:()=>be(s),class:"status",label:s.label.toLowerCase()},null,8,["icon","onClick","label","style"])),64))]),e("div",{class:fe(["",W.value?"chats active-new":"chats"]),ref_key:"chatsContainer",ref:w,onScroll:N},[(p(!0),x(_e,null,he(((le=o(d).sidebars[u.value.id])==null?void 0:le.filter(s=>O.value.label==="TODO"?!0:O.value.label==="SIN LEER"?s.unreaded>0:O.value.label==="LEIDOS"?s.unreaded==0:s.clasification===O.value.label).slice(0,100))||[],(s,r)=>(p(),T(t,{"active-class":o(_).current_chat_theme.name=="dark"?"active":"active-light",key:r,to:`/chat/chats/messages/${u.value.id}/${s.wa_id}/${s.nombre}/${s.color}?expirado=${s.expirado}&?expira-en?=${s.tiempo_para_expirar}`},{default:g(()=>[e("div",{class:"chat",onClick:()=>j(s)},[e("div",ct,[e("div",{style:c([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${s.color||"black"}`])},f(ie(s.nombre)),5)]),e("div",{style:c([{"grid-area":"nombre","text-transform":"capitalize","font-weight":"500"},o(_).current_chat_theme.text])},f(s.nombre),5),e("div",{style:c([{"grid-area":"numero","text-transform":"capitalize",opacity:".7"},o(_).current_chat_theme.text])},"+"+f(s.wa_id),5),e("span",{style:c([{"grid-area":"mensaje",color:"#ffffff80",opacity:".5"},o(_).current_chat_theme.text])},f(s.mensaje_truncado),5),e("span",{style:c([{"grid-area":"fecha","text-align":"end"},o(_).current_chat_theme.text])},f(s.abreviatura||s.fecha_ultimo_mensaje),5),e("span",{style:c([{"grid-area":"hora",color:"#ffffff80",opacity:".5","text-align":"end"},o(_).current_chat_theme.text])},f(s.hora_ultimo_mensaje),5),e("div",dt,[s.unreaded>0?(p(),x("div",ut,[e("span",mt,f(s.unreaded),1)])):$("",!0),pt])],8,lt)]),_:2},1032,["active-class","to"]))),128)),F.value?(p(),x("div",{key:0,style:c(`bottom:0;padding-bottom:1rem; background:linear-gradient(to bottom , transparent 3%, ${o(_).current_chat_theme.gradient});display:flex; position: absolute; z-index: 100;width:100%; color: white`)},[(p(),T(i,{key:0,style:{width:"50px",height:"50px"},strokeWidth:"8",fill:"transparent",animationDuration:".3s","aria-label":"Custom ProgressSpinner"}))],4)):$("",!0),V.value?(p(),x("div",ft,"No hay más chats.")):$("",!0)],34)])}}}),Ce=ke(_t,[["__scopeId","data-v-34b02823"]]),Se=R=>(Le("data-v-ed74fb8a"),R=R(),De(),R),ht={class:"top-bar-left"},gt={style:{height:"3rem",width:"3rem",display:"flex","align-items":"center"}},vt={class:"top-bar-info"},yt={style:{display:"flex","flex-direction":"column"}},bt={style:{display:"flex","align-items":"center",gap:"1rem"}},xt={style:{height:"100%",overflow:"auto"}},wt={class:"message-area"},kt=Se(()=>e("i",{class:"fas fa-laugh-wink emoji-picker"},null,-1)),$t=["onKeydown"],St=["src"],Et={style:{position:"relative",transition:".2s"}},Ct=Se(()=>e("i",{class:"pi pi-send text-2xl"},null,-1)),Tt={style:{display:"flex",gap:"1rem"}},Lt=["src"],Dt={class:"flex gap-2"},jt=Se(()=>e("div",{style:{width:"100%",display:"flex","justify-content":"end"}},null,-1)),Nt=Te({__name:"Main",setup(R){const y=$e();function P(t){return{APPROVED:"success",PENDING:"warning",REJECTED:"danger"}[t]||"info"}const Q=t=>{ae(t),q.value=!1};async function ae(t){const a=t,i=new FormData;i.append("messaging_product","whatsapp"),i.append("employer_id",H.rawUserData.id.toString()),i.append("context_message_id",""),i.append("restaurant_id",d.params.restaurant_id),i.append("to",d.params.user_id),i.append("type","template"),i.append("template",JSON.stringify(a));try{w.sending=!0,await L.post(`${I}/webhook/send/template/`,i,!1),console.log(`✅ Template enviado a ${to}`)}catch(m){console.error(`✗ Error al enviar template a ${to}`,m)}finally{w.sending=!1}}const se=v([{}]),_=t=>{t.target.closest(".emoji-picker")||(u.value=!1)};me(()=>{document.addEventListener("click",_),l()}),pe(()=>{document.removeEventListener("click",_)});const q=v(!1);v([]);const d=Ne(),H=Ue(),u=v(!1),j=v(""),B=v(!1),S=v(null),O=v(!1),oe=v(!0),z=Ie(()=>{var t,a;return oe.value&&(((t=d.query)==null?void 0:t.expirado)==="true"||((a=d.query)==null?void 0:a.expirado)===!0)}),F=t=>{oe.value=t};we(()=>{var t;return(t=d.params)==null?void 0:t.restaurant_id},()=>{l()}),we(z,t=>{j.value=t?"Conversación expirada":""},{immediate:!0});const V={"SIN DATOS":{bg:"#7f8c8d",icon:"fa-circle-question"},PREOCUPANTE:{bg:"#e74c3c",icon:"fa-triangle-exclamation"},CASUAL:{bg:"#e67e22",icon:"fa-person-walking"},FRECUENTE:{bg:"#27ae60",icon:"fa-repeat"},TOP:{bg:"#2980b9",icon:"fa-ranking-star"},ESTRELLA:{bg:"#8e44ad",icon:"fa-star"}},w=je();v([{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"},{id:7,name:"Distrimoster",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"}]);const ie=(t="")=>{const a=t.trim().split(" ");return(Array.from(a[0]||"")[0]||"")+(a[1]?Array.from(a[1])[0]:"")},ve=t=>{j.value+=t.i,u.value=!1};let A=null,G=[],N=null;const ye=async()=>{if(B.value&&A){A.stop();return}try{N=await navigator.mediaDevices.getUserMedia({audio:!0});const t=MediaRecorder.isTypeSupported("audio/ogg;codecs=opus")?"audio/ogg;codecs=opus":"audio/webm;codecs=opus";A=new MediaRecorder(N,{mimeType:t}),A.ondataavailable=a=>a.data.size&&G.push(a.data),A.onstop=()=>{const a=new Blob(G,{type:t.split(";")[0]});G=[],N.getTracks().forEach(m=>m.stop());const i=t.startsWith("audio/ogg")?"ogg":"webm";S.value={file:new File([a],`audio_${Date.now()}.${i}`,{type:a.type}),url:URL.createObjectURL(a)},B.value=!1},A.start(),B.value=!0}catch(t){console.error("No se pudo abrir el micrófono:",t.name,t.message),B.value=!1,N&&N.getTracks().forEach(a=>a.stop())}},U=()=>{S.value&&URL.revokeObjectURL(S.value.url),S.value=null};pe(()=>{A&&B.value&&A.stop(),N&&N.getTracks().forEach(t=>t.stop())});const re={messaging_product:"whatsapp",employer_id:H.rawUserData.id,context_message_id:null},M=async(t,a=null)=>{var m,E;if(z.value||!t.trim())return;const i=new FormData;i.append("messaging_product","whatsapp"),i.append("employer_id",H.rawUserData.id),i.append("context_message_id",((m=a==null?void 0:a.message_data)==null?void 0:m.wa_id)||null),i.append("restaurant_id",(E=d.params.restaurant_id)==null?void 0:E.toString()),i.append("to",d.params.user_id),i.append("type","text"),i.append("text",JSON.stringify({body:t})),j.value="";try{w.sending=!0,await L.post(`${I}/webhook/send/text/`,i,!1)}catch(b){console.error("Error al enviar texto",b)}w.sending=!1},X=async()=>{var m;if(z.value||!S.value||O.value)return;const t=S.value;U(),O.value=!0;const a=new FormData;a.append("files",t.file);const i={...re,restaurant_id:(m=d.params.restaurant_id)==null?void 0:m.toString(),to:d.params.user_id,type:"audio",text:{body:""},file_index:0};a.append("payloads",JSON.stringify(i));try{await L.post(`${I}/webhook/send`,a,!1)}catch(E){console.error("Error al enviar audio",E)}O.value=!1},W=async t=>{var E;if(z.value||!(t!=null&&t.length))return;const a=new FormData,i={restaurant_id:(E=d.params.restaurant_id)==null?void 0:E.toString(),to:d.params.user_id,messaging_product:"whatsapp",employer_id:H.rawUserData.id,context_message_id:null},m=b=>{var K;const{type:C,name:J}=b;if(C.startsWith("image/"))return"image";if(C.startsWith("audio/"))return"audio";if(C.startsWith("video/"))return"video";if(C==="application/pdf")return"document";const Y=(K=J.split(".").pop())==null?void 0:K.toLowerCase();return["jpg","jpeg","png","webp"].includes(Y)?"image":["mp3","wav","ogg","opus"].includes(Y)?"audio":"document"};t.forEach((b,C)=>{a.append("files",b.file),a.append("payloads",JSON.stringify({...i,type:m(b.file),text:{body:b.caption||""},file_index:C}))}),w.sending=!0;try{await L.post(`${I}/webhook/send`,a,!1)}catch(b){console.error("Error al enviar archivos",b)}w.sending=!1},be=t=>{t.key==="Enter"&&(t.preventDefault(),j.value.trim()&&M(j.value))},n=t=>{t.key==="Enter"&&S.value&&(t.preventDefault(),X())};me(()=>window.addEventListener("keydown",n)),pe(()=>window.removeEventListener("keydown",n));async function l(){if(d.params.restaurant_id){const a=(await L.get(`${Re}/restaurants`)||[]).find(i=>{var m;return i.id==((m=d.params)==null?void 0:m.restaurant_id)})||null;a&&(se.value=await L.get(`${I}/wabas/${a.waba_id}/templates/`))}}return(t,a)=>{var K,ne,le,s;const i=D("Button"),m=D("RouterView"),E=D("Textarea"),b=D("Column"),C=D("Tag"),J=D("DataTable"),Y=D("Dialog");return p(),x("div",{class:"main-container",style:c([o(y).current_chat_theme.bg_image,{}])},[(K=o(d).params)!=null&&K.user_id?(p(),x("div",{key:0,tabindex:"0",class:"top-bar",style:c([{"border-radius":".5rem",gap:"1rem"},o(y).current_chat_theme.bg_bars])},[e("div",ht,[e("div",gt,[e("div",{class:"cliente-img",style:c([`background-color:${o(d).params.color}`,{height:"100%",color:"white",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"}])},f(ie(o(d).params.user_name)),5)]),e("div",vt,[e("div",yt,[e("strong",null,[e("h5",{style:c([{"text-transform":"capitalize",margin:"0"},o(y).current_chat_theme.text])},f((ne=o(d).params.user_name)==null?void 0:ne.substring(0,20)),5)]),e("span",null,"+"+f(o(d).params.user_id),1)]),e("div",null,[o(w).current_user.clasification?(p(),T(i,{key:0,style:c({height:"2.3rem",display:"flex",alignItems:"center",textTransform:"capitalize",gap:"0.35rem",backgroundColor:((le=V[o(w).current_user.clasification])==null?void 0:le.bg)||"#7f8c8d",color:"#fff"})},{default:g(()=>{var r,k;return[e("i",{class:fe(["fa-solid",(r=V[o(w).current_user.clasification])==null?void 0:r.icon]),"aria-hidden":"true",style:{"font-size":"0.9rem"}},null,2),xe(" "+f((k=o(w).current_user.clasification)==null?void 0:k.toLowerCase())+" "+f(o(w).current_user.times_purchased)+" compras ",1)]}),_:1},8,["style"])):$("",!0)])])]),e("div",bt,[h(i,{icon:"pi pi-shopping-cart",class:"p-2",style:{color:"white","min-width":"max-content"},severity:"warning",label:"Ing. Ped"}),h(i,{text:"",class:"p-2"},{default:g(()=>[e("i",{style:c(o(y).current_chat_theme.text),class:"pi pi-search text-2xl"},null,4)]),_:1}),h(i,{text:"",class:"p-2"},{default:g(()=>[e("i",{style:c(o(y).current_chat_theme.text),class:"pi pi-bars text-2xl"},null,4)]),_:1})])],4)):$("",!0),e("div",xt,[h(m,null,{default:g(()=>[o(d).params.user_id?(p(),T(Ve,{key:0,send_function:W,send_text:M,change_expiration:F,ref:"Messages_element"},null,512)):$("",!0)]),_:1})]),(s=o(d).params)!=null&&s.user_id?(p(),x("div",{key:1,class:"chat-bar",tabindex:"0",style:c(o(y).current_chat_theme.bg_bars)},[u.value?(p(),T(o(ze),{key:0,native:!0,style:{position:"absolute",bottom:"4rem","z-index":"1000"},onSelect:ve,class:"emoji-picker"})):$("",!0),e("div",wt,[h(i,{text:"",style:{"font-size":"2rem","padding-left":"0"},onClick:a[0]||(a[0]=r=>u.value=!u.value)},{default:g(()=>[kt]),_:1}),S.value?(p(),x("div",{key:1,class:"audio-chip",onKeydown:Oe(Ae(X,["prevent"]),["enter"])},[e("audio",{style:{width:"100%","min-width":"28rem","max-width":"42rem"},src:S.value.url,controls:""},null,8,St),h(i,{text:"",class:"btn-audio-trash p-2",onClick:U},{default:g(()=>[e("i",{style:c(o(y).current_chat_theme.text),class:"pi pi-trash text-2xl p-0"},null,4)]),_:1})],40,$t)):(p(),T(E,{key:0,modelValue:j.value,"onUpdate:modelValue":a[1]||(a[1]=r=>j.value=r),autoResize:"",class:"message",disabled:z.value,onKeydown:be,style:c(`${o(y).current_chat_theme.text} ; ${o(y).current_chat_theme.border} `)},null,8,["modelValue","disabled","style"]))]),e("div",Et,[!S.value&&j.value.trim()===""?(p(),T(i,{key:0,text:"",style:{height:"100%"},onClick:ye},{default:g(()=>[e("i",{style:c(o(y).current_chat_theme.text),class:fe(B.value?"pi pi-stop text-2xl text-red-500":"pi pi-microphone text-2xl ")},null,6)]),_:1})):S.value?(p(),T(i,{key:1,disabled:O.value,text:"",onClick:X},{default:g(()=>[e("i",{style:c(o(y).current_chat_theme.text),class:"pi pi-send text-2xl"},null,4)]),_:1},8,["disabled"])):(p(),T(i,{key:2,style:c(o(y).current_chat_theme.text),text:"",onClick:a[2]||(a[2]=r=>M(j.value))},{default:g(()=>[Ct]),_:1},8,["style"]))]),e("div",Tt,[h(i,{severity:"danger",style:{},icon:"pi pi-clock",class:"p-2",onClick:a[3]||(a[3]=()=>q.value=!0)}),o(d).query.expirado?(p(),T(i,{key:0,icon:"pi pi-bolt",severity:"warning",style:{},class:"p-2",onClick:a[4]||(a[4]=()=>q.value=!0)})):$("",!0)])],4)):$("",!0),h(Y,{visible:q.value,"onUpdate:visible":a[5]||(a[5]=r=>q.value=r),modal:"",header:"Envio de plantilla",style:{width:"90rem"}},{default:g(()=>[h(J,{value:se.value,dataKey:"id",paginator:"",rows:10,responsiveLayout:"scroll",class:"shadow-md rounded-xl overflow-hidden"},{default:g(()=>[h(b,{class:"my-1 py-1",field:"name",header:"Nombre",bodyClass:"font-medium"}),h(b,{class:"my-1 py-1",header:"Texto"},{body:g(({data:r})=>{var k,Z;return[xe(f((Z=(k=r==null?void 0:r.components)==null?void 0:k.find(ee=>ee.type=="BODY"))==null?void 0:Z.text),1)]}),_:1}),h(b,{class:"my-1 py-1",header:"Imagen"},{body:g(({data:r})=>{var k,Z,ee,ce,de,ue;return[(ee=(Z=(k=r==null?void 0:r.components)==null?void 0:k.find(te=>te.type=="HEADER"))==null?void 0:Z.example)!=null&&ee.header_handle[0]?(p(),x("img",{key:0,style:{height:"10rem",width:"10rem","aspect-ratio":"1 / 1","object-fit":"cover","border-radius":".5rem",border:"1px solid"},src:(ue=(de=(ce=r==null?void 0:r.components)==null?void 0:ce.find(te=>te.type=="HEADER"))==null?void 0:de.example)==null?void 0:ue.header_handle[0],alt:""},null,8,Lt)):$("",!0)]}),_:1}),h(b,{class:"my-1 py-1",header:"Estado"},{body:g(({data:r})=>[h(C,{severity:P(r.status)},{default:g(()=>[xe(f(r.status),1)]),_:2},1032,["severity"])]),_:1}),h(b,{class:"my-1 py-1",headerStyle:"width:8rem",header:"Acciones"},{body:g(({data:r})=>[e("div",Dt,[h(i,{icon:"pi pi-send",label:"Enviar",severity:"help",onClick:k=>Q(r)},null,8,["onClick"])])]),_:1})]),_:1},8,["value"]),jt]),_:1},8,["visible"])],4)}}}),Ut=ke(Nt,[["__scopeId","data-v-ed74fb8a"]]);const It={__name:"chats",setup(R){const y=$e();return(P,Q)=>(p(),x("div",{class:"chat-container",style:c(o(y).current_chat_theme.bg)},[h(Ce,{style:{"box-shadow":".5rem 0 1rem #00000010"},class:"sidebar-left",restaurant:{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"}}),h(Ut),h(Ce,{style:{"box-shadow":"-.5rem 0 1rem #00000010"},class:"sidebar-right",restaurant:{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"}})],4))}},Mt=ke(It,[["__scopeId","data-v-ef52e81a"]]);export{Mt as default};
