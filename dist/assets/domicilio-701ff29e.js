import{_ as fe,B as me,z as ve,C as be,h as r,s as ge,i as he,D as R,x as ye,U as p,g as m,o as L,c as S,a as l,f as t,e as n,b as I,F as j,q as _e,r as G,u as O,ac as K,t as we,p as Ce,m as ke}from"./index-ef292654.js";import{g as Ee}from"./dropDownAux-072a0316.js";const P=U=>(Ce("data-v-5376e901"),U=U(),ke(),U),Le={class:"dialog-container"},Se=P(()=>l("p",null,"¿Estás seguro de que quieres eliminar este barrio?",-1)),Ue={class:"dialog-container"},Ve={class:"dropdowns-wrapper"},xe={class:"barrio-fields"},De={class:"add-barrio-button-wrapper"},$e={class:"dialog-container"},Pe={class:"download-dialog-content"},Ne=P(()=>l("label",{for:"sedes"},[l("strong",null,"Selecciona las sedes")],-1)),Te={class:"selected-sites-list"},Be=["src"],Re={class:"dialog-container"},Ie=P(()=>l("p",{class:"upload-instructions"}," Selecciona el archivo Excel con la información de barrios que deseas actualizar. ",-1)),je={class:"neighborhoods-container"},Oe={class:"actions-bar"},Me={class:"table-header"},ze={class:"p-input-icon-left"},Fe=P(()=>l("i",{class:"pi pi-search"},null,-1)),qe={__name:"domicilio",setup(U){const d=me(),f=ve(),M=be(),_=r(!1),y=r(!1),N=r(!1),w=r(!1),b=r(0),V=r(0),g=r([{}]),C=r(null),z=r([]),k=r([]),h=r([]),x=r(null),F=r([]),q=r({}),D=r([]);r(!1),r(!1),r(!1),r(!1),r(!1);const Q=r([]),W=r([]);r({});const X=r(!0);r([]),ge(()=>{d.setLoading(!1),Y(),Ee().then(o=>k.value=o)}),he(async()=>{const o=await Z();o&&(z.value=o);const e=await E();e&&(h.value=e),await de(),await ce()}),R(b,async(o,e)=>{if(o!==e){const s=await ee();s&&(k.value=s,V.value=k.value[0])}}),R(y,o=>{o&&(b.value={},g.value=[{}])}),R(()=>M.path,()=>{E().then(o=>{h.value=o})});function Y(){x.value={global:{value:null,matchMode:ye.CONTAINS}}}async function Z(){try{const o=await fetch(`${p}/cities`);if(o.ok)return await o.json()}catch(o){console.error("Error fetching cities:",o)}}async function E(){const o=M.params.site_id;try{d.setLoading(!0,"cargando barrios");const e=await fetch(`${p}/neighborhoods/by-site/${o}`);if(e.ok||d.setLoading(!1,"cargando barrios"),e.ok){const s=await e.json();return d.setLoading(!1,"cargando barrios"),s}}catch(e){d.setLoading(!1,"cargando barrios"),console.error("Error fetching neighborhoods:",e)}}async function ee(){var e;if(!((e=b.value)!=null&&e.city_id))return;const o=b.value.city_id;try{d.setLoading(!0,"cargando barrios");const s=await fetch(`${p}/sites/city/${o}`);if(s.ok){const c=await s.json();return d.setLoading(!1,"cargando barrios"),c}}catch(s){d.setLoading(!1,"cargando barrios"),console.error("Error fetching sites by city:",s)}}async function oe(){y.value=!1,d.setLoading(!0,"guardando barrios");try{await Promise.all(g.value.map(async e=>{if(e.site_id=V.value.site_id,e.city_id=b.value.city_id,!(await fetch(`${p}/neighborhood`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok)throw new Error(`Error creando el barrio: ${e.name}`)})),f.add({severity:"success",summary:"Creado",detail:"Barrios creados con éxito",life:3e3}),g.value=[{}];const o=await E();h.value=o}catch(o){console.error("Request error:",o),f.add({severity:"error",summary:"Error",detail:"No se pudo crear alguno de los barrios",life:3e3})}finally{d.setLoading(!1,"guardando barrios")}}async function A(o){const e={method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)};try{const s=await fetch(`${p}/neighborhood/${o.neighborhood_id}`,e);if(!s.ok)throw new Error("La petición ha fallado");const c=await s.json();console.log("Respuesta del servidor:",c)}catch(s){console.error("Error en la petición:",s)}}async function ae(){const o={method:"DELETE"};try{if(!(await fetch(`${p}/neighborhood/${q.value.neighborhood_id}`,o)).ok)throw new Error("Error al eliminar el barrio");await E().then(s=>h.value=s),_.value=!1,f.add({severity:"success",summary:"Eliminado",detail:"Barrio eliminado con éxito",life:3e3})}catch(e){console.error("Error en la petición:",e),f.add({severity:"error",summary:"Error",detail:"No se pudo eliminar el barrio",life:3e3})}}function se(o){q.value=o,_.value=!0}function te(o){g.value.length>1&&g.value.splice(o,1)}async function re(){d.setLoading(!0,"descargando informe");try{const o=D.value.map(v=>v.site_id),e=await fetch(`${p}/get-neigborhoods-report`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({site_ids:o})});if(!e.ok)throw new Error("Error al descargar el informe");const s=await e.blob(),c=window.URL.createObjectURL(s),u=document.createElement("a");u.href=c,u.download="barrios_informe.xlsx",document.body.appendChild(u),u.click(),document.body.removeChild(u),window.URL.revokeObjectURL(c),f.add({severity:"success",summary:"Éxito",detail:"Informe descargado con éxito",life:3e3})}catch(o){console.error("Error al descargar el informe:",o),f.add({severity:"error",summary:"Error",detail:"No se pudo descargar el informe",life:3e3})}finally{d.setLoading(!1,"descargando informe")}}function le(o){C.value=o.target.files[0]||null}function ie(){w.value=!1,C.value=null}async function ne(){if(!C.value){f.add({severity:"error",summary:"Error",detail:"No se ha seleccionado ningún archivo",life:3e3});return}d.setLoading(!0,"subiendo informe");try{const o=new FormData;if(o.append("file",C.value),!(await fetch(`${p}/update-neigborhoods`,{method:"POST",body:o})).ok)throw new Error("Error al subir el informe");f.add({severity:"success",summary:"Éxito",detail:"Informe subido con éxito",life:3e3}),w.value=!1,C.value=null;const s=await E();s&&(h.value=s)}catch(o){console.error("Error subiendo informe:",o),f.add({severity:"error",summary:"Error",detail:"No se pudo subir el informe",life:3e3})}finally{d.setLoading(!1,"subiendo informe")}}async function de(){try{const o=await fetch(`${p}/employers/grouped-by-site`);if(!o.ok)throw new Error(`HTTP error! Status: ${o.status}`);let e=await o.json();e=e.map(s=>{const c=s.employers.reduce((u,v)=>(u[v.position]=u[v.position]||[],u[v.position].push(v),u),{});return{...s,positions:c}}),Q.value=e,X.value=!1}catch(o){console.error("Error al obtener usuarios agrupados por sede:",o)}}async function ce(){try{const o=await fetch(`${p}/employers/grouped-by-position`);if(!o.ok)throw new Error(`HTTP error! Status: ${o.status}`);W.value=await o.json()}catch(o){console.error("Error al obtener usuarios agrupados por posición:",o)}}return(o,e)=>{const s=m("Button"),c=m("Dialog"),u=m("Dropdown"),v=m("Divider"),T=m("InputText"),H=m("InputNumber"),ue=m("MultiSelect"),B=m("Column"),pe=m("DataTable");return L(),S(j,null,[l("div",Le,[t(c,{visible:_.value,"onUpdate:visible":e[1]||(e[1]=a=>_.value=a),header:"Confirmar eliminación",modal:!0,closable:!1,class:"confirm-delete-dialog"},{default:n(()=>[Se,t(s,{label:"Cancelar",onClick:e[0]||(e[0]=a=>_.value=!1),class:"p-button-text"}),t(s,{label:"Eliminar",onClick:ae,class:"p-button-danger"})]),_:1},8,["visible"])]),l("div",Ue,[t(c,{visible:y.value,"onUpdate:visible":e[6]||(e[6]=a=>y.value=a),header:"Crear Nuevo Barrio",modal:!0,closable:!1,class:"create-neighborhood-dialog"},{footer:n(()=>[t(s,{severity:"danger",label:"Cancelar",onClick:e[5]||(e[5]=a=>y.value=!1),class:"p-button-text"}),t(s,{severity:"help",label:"Crear",onClick:oe,class:"p-button"})]),default:n(()=>{var a;return[l("div",Ve,[t(u,{modelValue:b.value,"onUpdate:modelValue":e[2]||(e[2]=i=>b.value=i),options:z.value,optionLabel:"city_name",placeholder:"Ciudad",class:"dropdown-field"},null,8,["modelValue","options"]),t(u,{modelValue:V.value,"onUpdate:modelValue":e[3]||(e[3]=i=>V.value=i),options:(a=k.value)==null?void 0:a.filter(i=>i.show_on_web),optionLabel:"site_name",placeholder:"Sede",class:"dropdown-field"},null,8,["modelValue","options"])]),t(v,null,{default:n(()=>[_e("Nuevos barrios")]),_:1}),(L(!0),S(j,null,G(g.value,(i,J)=>(L(),S("div",{key:J,class:"barrio-to-add-item"},[l("div",xe,[t(T,{modelValue:i.name,"onUpdate:modelValue":$=>i.name=$,placeholder:"Nombre del Barrio",class:"barrio-name-input"},null,8,["modelValue","onUpdate:modelValue"]),t(H,{prefix:"$",modelValue:i.delivery_price,"onUpdate:modelValue":$=>i.delivery_price=$,placeholder:"Precio del Domicilio",class:"barrio-delivery-input"},null,8,["modelValue","onUpdate:modelValue"]),t(s,{icon:"pi pi-trash",text:"",class:"delete-barrio-button",size:"small",severity:"danger",onClick:$=>te(J)},null,8,["onClick"])])]))),128)),l("div",De,[t(s,{text:"",class:"add-barrio-button",onClick:e[4]||(e[4]=()=>{g.value.push({})})},{default:n(()=>[l("i",{class:I(O(K).PLUS_CIRCLE)},null,2)]),_:1})])]}),_:1},8,["visible"])]),l("div",$e,[t(c,{header:"Descargar informe de barrios",class:"download-dialog",modal:"",visible:N.value,"onUpdate:visible":e[8]||(e[8]=a=>N.value=a)},{footer:n(()=>[t(s,{icon:"pi pi-download",severity:"help",label:"Descargar Informe",onClick:re})]),default:n(()=>[l("div",Pe,[Ne,t(ue,{id:"sedes",modelValue:D.value,"onUpdate:modelValue":e[7]||(e[7]=a=>D.value=a),filter:"",filterPlaceholder:"Busca una sede...",options:k.value.filter(a=>a.show_on_web),optionLabel:"site_name",class:"multiselect-field"},null,8,["modelValue","options"]),l("div",Te,[(L(!0),S(j,null,G(D.value,a=>(L(),S("div",{key:a==null?void 0:a.site_id,class:"selected-site-item"},[l("img",{src:`${O(p)}/read-product-image/96/site-${a==null?void 0:a.site_id}`,alt:"Imagen sede",class:"site-image"},null,8,Be),l("strong",null,we(a.site_name),1)]))),128))])])]),_:1},8,["visible"])]),l("div",Re,[t(c,{visible:w.value,"onUpdate:visible":e[9]||(e[9]=a=>w.value=a),header:"Subir Informe de Barrios",class:"upload-dialog",modal:!0,closable:!1},{footer:n(()=>[t(s,{label:"Cancelar",class:"p-button-text",onClick:ie}),t(s,{label:"Subir",class:"p-button-help",onClick:ne})]),default:n(()=>[Ie,l("input",{type:"file",accept:".xlsx, .xls",onChange:le,class:"file-input"},null,32)]),_:1},8,["visible"])]),l("div",je,[l("div",Oe,[t(s,{raised:"",severity:"help",size:"small",label:"Nuevo Barrio",onClick:e[10]||(e[10]=a=>y.value=!0)}),t(s,{raised:"",icon:"pi pi-download",severity:"danger",size:"small",label:"Descargar informe",class:"ml",onClick:e[11]||(e[11]=a=>N.value=!0)}),t(s,{raised:"",icon:"pi pi-upload",severity:"warning",size:"small",label:"Subir informe",class:"ml",onClick:e[12]||(e[12]=a=>w.value=!0)})]),t(pe,{class:I(h.value.length>0?"apear":"hide"),stripedRows:"",ref:"dt",value:h.value,selection:F.value,"onUpdate:selection":e[14]||(e[14]=a=>F.value=a),dataKey:"id",paginator:!0,rows:10,filters:x.value,paginatorTemplate:"FirstPageLink PrevPageLink PageLinks NextPageLink LastPageLink CurrentPageReport RowsPerPageDropdown",rowsPerPageOptions:[5,10,25,100],currentPageReportTemplate:"Mostrando {first} a {last} de {totalRecords} barrios",responsiveLayout:"scroll"},{header:n(()=>[l("div",Me,[l("span",ze,[Fe,t(T,{modelValue:x.value.global.value,"onUpdate:modelValue":e[13]||(e[13]=a=>x.value.global.value=a),placeholder:"Buscar..."},null,8,["modelValue"])])])]),default:n(()=>[t(B,{field:"name",header:"Barrio",sortable:!0,class:"barrio-column py-1 px-1"},{body:n(a=>[t(T,{onchange:()=>A(a.data),modelValue:a.data.name,"onUpdate:modelValue":i=>a.data.name=i,class:"table-input"},null,8,["onchange","modelValue","onUpdate:modelValue"])]),_:1}),t(B,{field:"delivery_price",header:"Precio del domicilio",sortable:!0,class:"delivery-price-column py-1 px-1"},{body:n(a=>[t(H,{inputStyle:{border:0,outline:0,borderRadius:0},prefix:"$",modelValue:a.data.delivery_price,"onUpdate:modelValue":[i=>a.data.delivery_price=i,()=>A(a.data)],class:"table-input-number"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),t(B,{field:"actions",header:"Eliminar",class:"actions-column py-1"},{body:n(a=>[t(s,{class:"p-button-rounded p-button-danger delete-button",onClick:i=>se(a.data)},{default:n(()=>[l("i",{class:I(O(K).TRASH)},null,2)]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["class","value","selection","filters"])])],64)}}},Je=fe(qe,[["__scopeId","data-v-5376e901"]]);export{Je as default};
