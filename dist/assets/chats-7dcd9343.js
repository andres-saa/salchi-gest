import{_ as Q,h as f,D as ie,i as ne,G,g as L,o as r,c as y,a as t,f as h,e as _,t as b,k as M,F as ee,r as te,d as E,n as H,u as k,H as K,j as J,p as re,m as le,C as de,l as ue,I as pe,b as ae,q as me,J as _e,K as fe}from"./index-ef292654.js";import{u as ce}from"./Messages.vue_vue_type_style_index_0_scoped_107b22c0_lang-c052f23d.js";import{P as he}from"./Main.vue_vue_type_style_index_0_scoped_389ee78e_lang-e03e7d05.js";import ge from"./Messages-e42fb85b.js";const Y=S=>(re("data-v-d96dc37f"),S=S(),le(),S),ve={class:"sidebar-container",style:{position:"relative"}},ye={class:"header"},be={class:"flex align-items-center"},xe=["src"],we={class:"flex align-items-center"},ke=["src"],Se={style:{color:"white"}},$e={style:{display:"flex",gap:"1rem"}},Ee=Y(()=>t("i",{class:"pi pi-bars text-2xl text-white"},null,-1)),Ce={style:{position:"relative"}},Te=Y(()=>t("i",{class:"pi pi-bell text-2xl text-white"},null,-1)),Le={style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",position:"absolute",top:"-1rem",right:"-.7rem",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold"}},Ue={style:{color:"white"}},De={class:"busqueda"},Ie={class:"statuses"},Re=["onClick"],je={style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},Oe={style:{"grid-area":"nombre","text-transform":"capitalize"}},Ne={key:0,style:{"grid-area":"expiration","text-align":"end","text-transform":"capitalize",color:"#ffffff80"}},Ae={key:1,style:{"grid-area":"expiration","text-align":"end","text-transform":"capitalize",color:"#ff000080"}},ze={style:{"grid-area":"mensaje",color:"#ffffff80"}},Fe={style:{"grid-area":"fecha","text-align":"end"}},Me={style:{"grid-area":"check",display:"flex","justify-content":"end",gap:".5rem"}},Ve={key:0,style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold"}},Be={style:{color:"white"}},Pe=Y(()=>t("i",{style:{color:"greenyellow"},class:"fa-solid fa-check-double"},null,-1)),We={key:0,style:{bottom:"0","padding-bottom":"1rem",background:"linear-gradient(to bottom , transparent 3%, black)",display:"flex",position:"absolute","z-index":"100",width:"100%",color:"white"}},qe={key:1,style:{"text-align":"center",padding:".5rem",color:"#ffffff80"}},se=1e3,Ke={__name:"Sidebar",props:{restaurant:Object},setup(S){const p=S,g=ce(),R=[{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"},{id:7,name:"Distrimoster",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"}],l=f(p.restaurant||R[0]);f([{label:"Todos",textColor:"#4CAF50"},{label:"Sin leer",textColor:"#2196F3"},{label:"Favoritos",textColor:"#FFC107"},{label:"Preocupantes",textColor:"#F44336"},{label:"Top",textColor:"#9C27B0"}]);const U=f([{label:"TODO",bg:"#8e44ad",icon:"fa-star"},{label:"SIN DATOS",bg:"#7f8c8d",icon:"fa-circle-question"},{label:"PREOCUPANTE",bg:"#e74c3c",icon:"fa-triangle-exclamation"},{label:"CASUAL",bg:"#e67e22",icon:"fa-person-walking"},{label:"FRECUENTE",bg:"#27ae60",icon:"fa-repeat"},{label:"TOP",bg:"#2980b9",icon:"fa-ranking-star"},{label:"ESTRELLA",bg:"#8e44ad",icon:"fa-star"}]),u=f({label:"TODO",bg:"#8e44ad",icon:"fa-star"}),D=f(0);let F=0;const $=f(!1),j=f(!1),O=f(null),N=o=>{var i;if(!o)return"";const n=o.split(" ");return(n[0][0]||"")+(((i=n[1])==null?void 0:i[0])||"")},X=(o,n)=>{const i=g.sidebars[o]||[];n.forEach(d=>{const v=i.findIndex(A=>A.wa_id===d.wa_id);v===-1?i.push(d):i[v].ultimo_mensaje_id!==d.ultimo_mensaje_id&&(i[v]=d)}),g.sidebars[o]=i,D.value=i.reduce((d,v)=>d+Number(v.unreaded||0),0)},V=async()=>{if($.value||j.value)return;$.value=!0;const o=`${K}/last-contact-messages/${l.value.id}?limit=${se}&offset=${F}`,n=await J.get(o,!1);n.length<se&&(j.value=!0),F+=n.length,X(l.value.id,n),$.value=!1},x=()=>{const o=O.value;if(!o||$.value||j.value)return;o.scrollTop+o.clientHeight>=o.scrollHeight-120&&V()},B=o=>{const n=l.value.id,i=g.sidebars[n]||[],d=i.findIndex(v=>v.wa_id===o.wa_id);d!==-1?(i.splice(d,1),g.sidebars[n]=[o,...i]):g.sidebars[n]=[o,...i],D.value=g.sidebars[n].reduce((v,A)=>v+Number(A.unreaded||0),0)};let c=null;const P=()=>{const o=`wss://sockets-service.salchimonster.com/ws/salchimonster-${l.value.id}`;c=new WebSocket(o),c.onopen=()=>console.log("WebSocket conectado a",o),c.onerror=n=>console.error("WebSocket error",n),c.onclose=()=>setTimeout(P,5e3),c.onmessage=async n=>{const i=JSON.parse(n.data);i!=null&&i.user_id&&B(i)}};return ie(l,async o=>{F=0,j.value=!1,g.sidebars[o.id]=[],c&&c.close(),P(),await V()}),ne(async()=>{var o;await V(),(o=O.value)==null||o.addEventListener("scroll",x),P()}),G(()=>{var o;(o=O.value)==null||o.removeEventListener("scroll",x),c&&c.close()}),(o,n)=>{var s;const i=L("Dropdown"),d=L("Button"),v=L("InputText"),A=L("IconField"),q=L("RouterLink"),a=L("ProgressSpinner");return r(),y("div",ve,[t("div",ye,[h(i,{modelValue:l.value,"onUpdate:modelValue":n[0]||(n[0]=e=>l.value=e),options:R,optionLabel:"name",style:{"background-color":"#ffffff20",border:"none",color:"white",outline:"none","box-shadow":"none"}},{option:_(e=>[t("div",be,[t("img",{src:e.option.img,alt:"Logo",style:{width:"24px",height:"24px","margin-right":"8px","object-fit":"contain"}},null,8,xe),t("span",null,[t("b",null,b(e.option.name),1)])])]),value:_(e=>[t("div",we,[e.value?(r(),y("img",{key:0,src:e.value.img,alt:"Logo",style:{width:"24px",height:"24px","margin-right":"8px","object-fit":"contain"}},null,8,ke)):M("",!0),t("span",Se,b(e.value?e.value.name:"Selecciona"),1)])]),_:1},8,["modelValue"]),t("div",$e,[h(d,{class:"options",text:""},{default:_(()=>[Ee]),_:1}),t("div",Ce,[h(d,{class:"options",text:"",style:{opacity:".5"}},{default:_(()=>[Te]),_:1}),t("div",Le,[t("span",Ue,b(D.value),1)])])])]),t("div",De,[h(A,{style:{display:"flex"}},{default:_(()=>[h(v,{style:{color:"white"},class:"search",placeholder:"Buscar..."})]),_:1})]),t("div",Ie,[(r(!0),y(ee,null,te(U.value,(e,m)=>(r(),E(d,{style:H([{height:"2.3rem","border-radius":".3rem",padding:".5rem"},e.label===u.value.label?{backgroundColor:e.bg,color:"#fff"}:{backgroundColor:"#ffffff20",color:e.bg}]),text:"",key:m,onClick:()=>u.value=e,class:"status",label:e.label},null,8,["onClick","label","style"]))),128))]),t("div",{class:"chats",ref_key:"chatsContainer",ref:O,onScroll:x},[(r(!0),y(ee,null,te(((s=k(g).sidebars[l.value.id])==null?void 0:s.filter(e=>e.clasification==u.value.label||u.value.label=="TODO"))||[],(e,m)=>(r(),E(q,{"active-class":"active",key:m,to:`/chat/chats/messages/${l.value.id}/${e.wa_id}/${e.nombre}/${e.color}?expirado=${e.expirado}&?expira-en?=${e.tiempo_para_expirar}`},{default:_(()=>[t("div",{class:"chat",onClick:()=>k(g).current_user=e},[t("div",je,[t("div",{style:H([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${e.color}`])},b(N(e.nombre)),5)]),t("div",Oe,b(e.nombre),1),e.tiempo_para_expirar||!e.expirado?(r(),y("div",Ne," Expira en "+b(e.tiempo_para_expirar),1)):(r(),y("div",Ae," Expirado ")),t("span",ze,b(e.mensaje_truncado),1),t("span",Fe,b(e.abreviatura||e.fecha_ultimo_mensaje),1),t("div",Me,[e.unreaded>0?(r(),y("div",Ve,[t("span",Be,b(e.unreaded),1)])):M("",!0),Pe])],8,Re)]),_:2},1032,["to"]))),128)),$.value?(r(),y("div",We,[(r(),E(a,{key:0,style:{width:"50px",height:"50px"},strokeWidth:"8",fill:"transparent",animationDuration:".3s","aria-label":"Custom ProgressSpinner"}))])):M("",!0),j.value?(r(),y("div",qe,"No hay más chats.")):M("",!0)],544)])}}},oe=Q(Ke,[["__scopeId","data-v-d96dc37f"]]),z=S=>(re("data-v-389ee78e"),S=S(),le(),S),Je={class:"main-container"},He={class:"top-bar",style:{"border-radius":".5rem",gap:"1rem"}},Xe={class:"top-bar-left"},Ge={style:{height:"3rem",width:"3rem",display:"flex","align-items":"center"}},Qe={class:"top-bar-info"},Ye={style:{"text-transform":"capitalize",margin:"0"}},Ze={style:{display:"flex","align-items":"center",gap:"1rem"}},et=z(()=>t("i",{class:"pi pi-search text-2xl text-white"},null,-1)),tt=z(()=>t("i",{class:"pi pi-bars text-2xl text-white"},null,-1)),at={style:{height:"100%",overflow:"auto"}},st={key:1,style:{display:"flex","justify-content":"center","align-items":"center",height:"100%"}},ot=z(()=>t("h2",{style:{color:"white","font-size":"3rem",opacity:".5"}},"Selecciona un chat...",-1)),it=[ot],nt={class:"chat-bar",tabindex:"0"},rt={class:"message-area"},lt=z(()=>t("i",{class:"fas fa-laugh-wink"},null,-1)),ct=["onKeydown"],dt=["src"],ut=z(()=>t("i",{class:"pi pi-trash text-2xl p-0"},null,-1)),pt={style:{position:"relative",transition:".2s"}},mt=z(()=>t("i",{class:"pi pi-send text-2xl text-white"},null,-1)),_t=z(()=>t("i",{class:"pi pi-send text-2xl text-white"},null,-1)),ft={__name:"Main",setup(S){const p=de(),g=ue(),R=f(!1),l=f(""),U=f(!1),u=f(null),D=f(!1),F=f(!0),$=pe(()=>{var a,s;return F.value&&(((a=p.query)==null?void 0:a.expirado)==="true"||((s=p.query)==null?void 0:s.expirado)===!0)}),j=a=>{F.value=a};ie($,a=>{l.value=a?"Conversación expirada":""},{immediate:!0});const O={"SIN DATOS":{bg:"#7f8c8d",icon:"fa-circle-question"},PREOCUPANTE:{bg:"#e74c3c",icon:"fa-triangle-exclamation"},CASUAL:{bg:"#e67e22",icon:"fa-person-walking"},FRECUENTE:{bg:"#27ae60",icon:"fa-repeat"},TOP:{bg:"#2980b9",icon:"fa-ranking-star"},ESTRELLA:{bg:"#8e44ad",icon:"fa-star"}},N=ce();f([{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"},{id:7,name:"Distrimoster",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"}]);const X=(a="")=>{const s=a.trim().split(" ");return(Array.from(s[0]||"")[0]||"")+(s[1]?Array.from(s[1])[0]:"")},V=a=>{l.value+=a.i,R.value=!1};let x=null,B=[],c=null;const P=async()=>{if(U.value&&x){x.stop();return}try{c=await navigator.mediaDevices.getUserMedia({audio:!0});const a=MediaRecorder.isTypeSupported("audio/ogg;codecs=opus")?"audio/ogg;codecs=opus":"audio/webm;codecs=opus";x=new MediaRecorder(c,{mimeType:a}),x.ondataavailable=s=>s.data.size&&B.push(s.data),x.onstop=()=>{const s=new Blob(B,{type:a.split(";")[0]});B=[],c.getTracks().forEach(m=>m.stop());const e=a.startsWith("audio/ogg")?"ogg":"webm";u.value={file:new File([s],`audio_${Date.now()}.${e}`,{type:s.type}),url:URL.createObjectURL(s)},U.value=!1},x.start(),U.value=!0}catch(a){console.error("No se pudo abrir el micrófono:",a.name,a.message),U.value=!1,c&&c.getTracks().forEach(s=>s.stop())}},o=()=>{u.value&&URL.revokeObjectURL(u.value.url),u.value=null};G(()=>{x&&U.value&&x.stop(),c&&c.getTracks().forEach(a=>a.stop())});const n={messaging_product:"whatsapp",employer_id:g.rawUserData.id,context_message_id:null},i=async(a,s=null)=>{var m,C;if($.value||!a.trim())return;const e=new FormData;e.append("messaging_product","whatsapp"),e.append("employer_id",g.rawUserData.id),e.append("context_message_id",((m=s==null?void 0:s.message_data)==null?void 0:m.wa_id)||null),e.append("restaurant_id",(C=p.params.restaurant_id)==null?void 0:C.toString()),e.append("to",p.params.user_id),e.append("type","text"),e.append("text",JSON.stringify({body:a}));try{await J.post(`${K}/webhook/send/text/`,e,!1)}catch(w){console.error("Error al enviar texto",w)}l.value=""},d=async()=>{var m;if($.value||!u.value||D.value)return;const a=u.value;o(),D.value=!0;const s=new FormData;s.append("files",a.file);const e={...n,restaurant_id:(m=p.params.restaurant_id)==null?void 0:m.toString(),to:p.params.user_id,type:"audio",text:{body:""},file_index:0};s.append("payloads",JSON.stringify(e));try{await J.post(`${K}/webhook/send`,s,!1)}catch(C){console.error("Error al enviar audio",C)}D.value=!1},v=async a=>{var C;if($.value||!(a!=null&&a.length))return;const s=new FormData,e={restaurant_id:(C=p.params.restaurant_id)==null?void 0:C.toString(),to:p.params.user_id,messaging_product:"whatsapp",employer_id:g.rawUserData.id,context_message_id:null},m=w=>{var Z;const{type:T,name:I}=w;if(T.startsWith("image/"))return"image";if(T.startsWith("audio/"))return"audio";if(T.startsWith("video/"))return"video";if(T==="application/pdf")return"document";const W=(Z=I.split(".").pop())==null?void 0:Z.toLowerCase();return["jpg","jpeg","png","webp"].includes(W)?"image":["mp3","wav","ogg","opus"].includes(W)?"audio":"document"};a.forEach((w,T)=>{s.append("files",w.file),s.append("payloads",JSON.stringify({...e,type:m(w.file),text:{body:w.caption||""},file_index:T}))});try{await J.post(`${K}/webhook/send`,s,!1)}catch(w){console.error("Error al enviar archivos",w)}},A=a=>{a.key==="Enter"&&(a.preventDefault(),l.value.trim()&&i(l.value))},q=a=>{a.key==="Enter"&&u.value&&(a.preventDefault(),d())};return ne(()=>window.addEventListener("keydown",q)),G(()=>window.removeEventListener("keydown",q)),(a,s)=>{var w,T;const e=L("Button"),m=L("RouterView"),C=L("Textarea");return r(),y("div",Je,[t("div",He,[t("div",Xe,[t("div",Ge,[t("div",{class:"cliente-img",style:H([`background-color:${k(p).params.color}`,{height:"100%",width:"3rem",color:"white","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"}])},b(X(k(p).params.user_name)),5)]),t("div",Qe,[t("strong",null,[t("h5",Ye,b((w=k(p).params.user_name)==null?void 0:w.substring(0,20))+"... ",1)]),t("div",null,[k(N).current_user.clasification?(r(),E(e,{key:0,style:H({height:"2.3rem",display:"flex",alignItems:"center",textTransform:"capitalize",gap:"0.35rem",backgroundColor:((T=O[k(N).current_user.clasification])==null?void 0:T.bg)||"#7f8c8d",color:"#fff"})},{default:_(()=>{var I,W;return[t("i",{class:ae(["fa-solid",(I=O[k(N).current_user.clasification])==null?void 0:I.icon]),"aria-hidden":"true",style:{"font-size":"0.9rem"}},null,2),me(" "+b((W=k(N).current_user.clasification)==null?void 0:W.toLowerCase())+" "+b(k(N).current_user.times_purchased)+" compras ",1)]}),_:1},8,["style"])):M("",!0)])])]),t("div",Ze,[h(e,{icon:"pi pi-shopping-cart",class:"p-2",style:{color:"white","min-width":"max-content"},severity:"warning",label:"Ing. Ped"}),h(e,{text:"",class:"p-2"},{default:_(()=>[et]),_:1}),h(e,{text:"",class:"p-2"},{default:_(()=>[tt]),_:1})])]),t("div",at,[h(m,null,{default:_(()=>[k(p).params.user_id?(r(),E(ge,{key:0,send_function:v,send_text:i,change_expiration:j,ref:"Messages_element"},null,512)):(r(),y("div",st,it))]),_:1})]),t("div",nt,[R.value?(r(),E(k(he),{key:0,native:!0,style:{position:"absolute",bottom:"4rem","z-index":"1000"},onSelect:V})):M("",!0),t("div",rt,[h(e,{text:"",style:{color:"yellow","font-size":"2rem"},onClick:s[0]||(s[0]=I=>R.value=!R.value)},{default:_(()=>[lt]),_:1}),u.value?(r(),y("div",{key:1,class:"audio-chip",onKeydown:_e(fe(d,["prevent"]),["enter"])},[t("audio",{style:{width:"100%","min-width":"28rem","max-width":"42rem"},src:u.value.url,controls:""},null,8,dt),h(e,{text:"",class:"btn-audio-trash p-2",onClick:o},{default:_(()=>[ut]),_:1})],40,ct)):(r(),E(C,{key:0,modelValue:l.value,"onUpdate:modelValue":s[1]||(s[1]=I=>l.value=I),autoResize:"",class:"message",disabled:$.value,onKeydown:A},null,8,["modelValue","disabled"]))]),t("div",pt,[h(e,{class:"btn-descuento",icon:"pi pi-send btn-descuento",style:{transition:".2s"},label:"Enviar Descuento"}),!u.value&&l.value.trim()===""?(r(),E(e,{key:0,text:"",style:{height:"100%"},onClick:P},{default:_(()=>[t("i",{class:ae(U.value?"pi pi-stop text-2xl text-red-500":"pi pi-microphone text-2xl text-white")},null,2)]),_:1})):u.value?(r(),E(e,{key:1,disabled:D.value,text:"",onClick:d},{default:_(()=>[mt]),_:1},8,["disabled"])):(r(),E(e,{key:2,text:"",onClick:s[2]||(s[2]=I=>i(l.value))},{default:_(()=>[_t]),_:1}))])])])}}},ht=Q(ft,[["__scopeId","data-v-389ee78e"]]);const gt={class:"chat-container"},vt={__name:"chats",setup(S){return(p,g)=>(r(),y("div",gt,[h(oe,{restaurant:{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"}}),h(ht),h(oe,{restaurant:{id:7,name:"Distrimoster",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"}})]))}},kt=Q(vt,[["__scopeId","data-v-89df78fd"]]);export{kt as default};
