import{_ as Le,l as Ne,j as r,G as z,Z as De,k as Oe,m as C,U as Re,D as B,o as f,c as b,e as o,f as p,u as s,a as l,F,$ as h,h as k,t as w,i as H,b as J,g as Pe,n as Ae,a0 as ie,a1 as U,a2 as re,a3 as D,a4 as G,a5 as ue,a6 as je,a7 as Be,p as Fe,q as He,J as L}from"./index-ad3ca417.js";import{u as Ge}from"./chat-65d6cd5e.js";const c=O=>(Fe("data-v-f46a8681"),O=O(),He(),O),Ye={style:{height:"100%"}},Me={style:{display:"grid","grid-template-columns":"repeat(2, 1fr)","max-width":"max-content",gap:".5rem","align-items":"center"}},Ke=c(()=>l("h6",{class:"m-0 p-0"},[l("strong",null,"Id plantilla :")],-1)),qe={class:"m-0 p-0"},ze=c(()=>l("h6",{class:"m-0 p-0"},[l("strong",null,"Nombre plantilla :")],-1)),Je={class:"m-0 p-0"},Qe=c(()=>l("h6",{class:"m-0 p-0"},[l("strong",null,"Estado :")],-1)),We={class:"m-0 p-0"},Ze=c(()=>l("h6",{class:"m-0 p-0"},[l("strong",null,"Categoria :")],-1)),Xe={class:"m-0 p-0"},el=c(()=>l("h6",{class:"m-0 p-0"},[l("strong",null,"Mensaje :")],-1)),ll={class:"m-0",style:{"background-color":"#0a3744",padding:"1rem","border-radius":".5rem",color:"white"}},al=c(()=>l("h6",{class:"m-0 p-0"},[l("strong",null,"Foto :")],-1)),tl=["src"],sl=c(()=>l("h5",{class:"mt-4 mb-1"},[l("strong",null,"Imagen para este envío")],-1)),ol={style:{display:"flex",gap:"1rem","align-items":"center","flex-wrap":"wrap"}},nl=["src"],il=c(()=>l("h5",null,[l("strong",null,"Usuarios")],-1)),rl={class:"statuses",style:{display:"flex",gap:"1rem"}},ul={style:{width:"100%",height:"50vh","margin-top":"1rem"}},dl={class:"p-4 templates-container",style:{margin:"auto","background-color":"white","border-radius":"1rem",transition:"all .3s ease","max-height":"90vh"}},cl={style:{height:"100%"}},ml={class:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",style:{"align-items":"center"}},pl=c(()=>l("h2",{class:"text-2xl font-bold whitespace-nowrap m-0 p-0",style:{"min-width":"max-content"}},"Plantillas de WhatsApp",-1)),vl={class:"p-input-icon-left w-full md:w-80 my-3",style:{height:"100%"}},fl=c(()=>l("i",{class:"pi pi-search"},null,-1)),hl={key:0,style:{display:"flex","justify-content":"center"}},gl=["src"],yl={class:"flex gap-2"},_l={style:{display:"flex",width:"100%","justify-content":"end","margin-top":"1rem"}},bl={class:"space-y-4"},wl={class:"md:grid-cols-2 gap-3"},xl={class:"field"},El={key:0,style:{position:"relative",width:"300px","margin-top":".5rem"}},Ul=["src"],Tl={style:{display:"flex","justify-content":"center"}},Vl=["src"],Cl={class:"field"},kl=c(()=>l("label",{class:"font-medium"},"Nombre",-1)),$l={class:"field"},Sl=c(()=>l("label",{class:"font-medium"},"Categoría",-1)),Il={class:"field"},Ll=c(()=>l("label",{class:"font-medium"},"Idioma",-1)),Nl={class:"font-medium"},Dl={class:"opacity-70"},Ol={key:0,class:"",style:{display:"flex","flex-direction":"column",gap:"1rem","justify-content":"center"}},Rl=c(()=>l("h5",{class:"font-medium m-0 p-0 py-3"},"Ejemplos de variables",-1)),Pl={class:"space-y-2"},Al={class:"flex items-center my-4",style:{"align-items":"center",gap:"1rem"}},jl=c(()=>l("h5",{class:"m-0"},"Botones",-1)),Bl={style:{display:"flex","flex-direction":"column",gap:"1rem","max-width":"100%",overflow:"hidden"}},Fl={__name:"templates",setup(O){const de=Ne(),R=Ge();function ce(){N.value=null,K.value=""}const $=r("");async function me(t){var e,n;const a=(e=t.target.files)==null?void 0:e[0];if(a)try{const i=new FormData;i.append("file",a);const d=await C.postFormData(`${L}/upload-photo-product`,i),u=(((n=d==null?void 0:d.content)==null?void 0:n.file_id)??d).toString();$.value=`${L}/files/images/${u}`}catch(i){console.error("✗ Error subiendo imagen:",i)}}r(""),r(!1),r(R.templates);const x=r({}),Q=r(!1),P=r(""),S=r(!1),Y=r(!1),A=r(null),W=r([]),g=r({name:"",category:"UTILITY",language:"es_ES"}),I=r(""),T=r([]),m=r({}),pe=r(null),y=r({}),M=r([{}]);r({label:"PREOCUPANTE",bg:"#e74c3c",icon:"fa-triangle-exclamation"});const N=r(null),K=r(""),v=r([]),ve=r([{label:"SIN DATOS",bg:"#7f8c8d",icon:"fa-circle-question"},{label:"PREOCUPANTE",bg:"#e74c3c",icon:"fa-triangle-exclamation"},{label:"CASUAL",bg:"#e67e22",icon:"fa-person-walking"},{label:"FRECUENTE",bg:"#27ae60",icon:"fa-repeat"},{label:"TOP",bg:"#2980b9",icon:"fa-ranking-star"},{label:"ESTRELLA",bg:"#8e44ad",icon:"fa-star"}]);function fe(t){const a=t.label;if(a==="TODO"){v.value=[];return}const e=v.value.indexOf("TODO");e>-1&&v.value.splice(e,1);const n=v.value.indexOf(a);n===-1?v.value.push(a):v.value.splice(n,1)}const Z=z(()=>v.value.length===0?M.value:M.value.filter(t=>v.value.includes(t.clasification))),he=De(),V=r(!1),ge=[{label:"AUTHENTICATION",value:"AUTHENTICATION"},{label:"MARKETING",value:"MARKETING"},{label:"UTILITY",value:"UTILITY"}],ye=[{label:"Español (CO)",value:"es_CO"},{label:"Español (ES)",value:"es_ES"},{label:"English (US)",value:"en_US"}],_e=[{label:"URL",value:"URL"},{label:"QUICK_REPLY",value:"QUICK_REPLY"}],be=z(()=>{if(!P.value)return R.templates;const t=P.value.toLowerCase();return R.templates.filter(a=>`${a.name} ${a.category}`.toLowerCase().includes(t))});Oe(async()=>{const t=await C.get(`${Re}/restaurants`);W.value=t,y.value=t.find(a=>a.id==1),y.value});const we=t=>{x.value=t,V.value=!0};B(V,()=>{v.value=[]});const j=r([]);B(I,t=>{const a=Array.from(new Set((t.match(/{{\s*([^{}\s]+)\s*}}/g)||[]).map(e=>e.replace(/{{|}}/g,"").trim())));j.value=a,m.value=Object.fromEntries(Object.entries(m.value).filter(([e])=>a.includes(e))),a.forEach(e=>{e in m.value||(m.value[e]="")})});async function X(){Q.value=!0;try{R.templates=await C.get(`${L}/wabas/${y.value.waba_id}/templates/`)}finally{Q.value=!1}}const xe=async()=>{M.value=await C.get(`${L}/wabas/${y.value.waba_id}/templates/users/${y.value.id}`)};B(y,async t=>{t&&(X(),v.value=[],await xe())},{deep:!0});function Ee(t){return{APPROVED:"success",PENDING:"warning",REJECTED:"danger"}[t]||"info"}function ee(){g.value={name:"",category:"UTILITY",language:"es_ES"},I.value="",T.value=[],m.value={},A.value=null}function Ue(){ee(),S.value=!0}const le=r({}),Te=z(()=>pe.value?"Editar plantilla":"Nueva plantilla");function Ve(t){var i,d;A.value=t.id,g.value={name:t.name,category:t.category,language:t.language};const a=t.components.find(u=>u.type==="BODY")||{text:""};I.value=a.text,m.value={},(i=a.example)!=null&&i.body_text_named_params?a.example.body_text_named_params.forEach(({param_name:u,example:_})=>{m.value[u]=_}):(d=a.example)!=null&&d.body_text&&a.example.body_text[0].forEach((u,_)=>{m.value[String(_+1)]=u});const e=t.components.find(u=>u.type==="BUTTONS")||{buttons:[]};T.value=e.buttons.map(u=>({type:u.type,text:u.text,url:u.url||""}));const n=t.components.find(u=>u.type==="HEADER")||{type:"HEADER",format:"IMAGE",example:{header_handle:[]}};le.value=n==null?void 0:n.example.header_handle[0],S.value=!0}function Ce(){T.value.push({type:"URL",text:"",url:""})}function ke(){const t=j.value;return t.length?t.every(e=>/^\d+$/.test(e))?{body_text:[t.sort((n,i)=>+n-+i).map(n=>m.value[n]||"")]}:{body_text_named_params:t.map(e=>({param_name:e,example:m.value[e]||""}))}:void 0}async function $e(){if(g.value.name.trim()){Y.value=!0;try{const t=ke(),a=[{type:"BODY",data:{text:I.value,...t?{example:t}:{}}}];T.value.length&&a.push({type:"BUTTONS",data:{buttons:T.value}});const e={...g.value,components:a},n=`${L}/wabas/${y.value.waba_id}/templates`;if(N.value){const i=new FormData;i.append("template_json",JSON.stringify(e)),i.append("header_image",N.value);const d=`${n}/with-header`;await C.postFormData(d,i,"Guardando…")}else{const i=A.value?`${n}/${A.value}`:n;await C.post(i,e,"Guardando…")}await X(),S.value=!1,ee(),N.value=null,K.value=""}catch(t){console.error("✗ Error guardando plantilla:",t)}finally{Y.value=!1}}}const q=r(!1);async function Se(){if(!x.value)return;if(!$.value){he.require({message:"Debes seleccionar una imagen antes de difundir la plantilla.",header:"Imagen requerida",icon:"pi pi-exclamation-triangle",acceptLabel:"Ok",rejectVisible:!1});return}const t=Z.value.map(e=>e.wa_id).filter(e=>!!e&&e.trim().length>0);if(!t.length){console.warn("No hay destinatarios válidos para la difusión");return}const a={messaging_product:"whatsapp",employer_id:de.rawUserData.id.toString(),restaurant_id:`${y.value.id}`,template:x.value,template_header_url:$.value,recipients:["573226892988"]};q.value=!0;try{await C.post(`${L}/webhook/send/template/bulk/`,a,!1),console.log(`✅ Difusión iniciada para ${t.length} usuarios`),V.value=!1}catch(e){console.error("✗ Error en difusión masiva:",e)}finally{q.value=!1}}return B(V,t=>{t||($.value="")}),(t,a)=>(f(),b(F,null,[o(s(re),{visible:V.value,"onUpdate:visible":a[1]||(a[1]=e=>V.value=e),modal:"",header:"Difundir Plantilla",style:{width:"100vw","max-width":"80rem","background-color":"white"}},{footer:p(()=>[o(s(h),{label:"Cancelar",text:"",severity:"secondary",onClick:a[0]||(a[0]=e=>V.value=!1)}),o(s(h),{label:"Enviar a todos",severity:"help",icon:"pi pi-broadcast",loading:q.value,onClick:Se,autofocus:""},null,8,["loading"])]),default:p(()=>{var e,n,i,d,u,_,ae,te,se,oe,ne;return[l("div",Ye,[l("div",Me,[Ke,k(),l("h6",qe,w((e=x.value)==null?void 0:e.id),1),ze,k(),l("h6",Je,w((n=x.value)==null?void 0:n.name),1),Qe,k(),l("h6",We,w((i=x.value)==null?void 0:i.status),1),Ze,k(),l("h6",Xe,w((d=x.value)==null?void 0:d.category),1),el,l("h6",ll,w((ae=(_=(u=x.value)==null?void 0:u.components)==null?void 0:_.find(E=>E.type=="BODY"))==null?void 0:ae.text),1),al,l("img",{style:{height:"10rem",width:"10rem","aspect-ratio":"1 / 1","object-fit":"cover","border-radius":".5rem",border:"1px solid"},src:(ne=(oe=(se=(te=x.value)==null?void 0:te.components)==null?void 0:se.find(E=>E.type=="HEADER"))==null?void 0:oe.example)==null?void 0:ne.header_handle[0],alt:""},null,8,tl)]),sl,l("div",ol,[l("input",{type:"file",accept:"image/*",onChange:me},null,32),$.value?(f(),b("img",{key:0,src:$.value,alt:"preview",style:{height:"8rem",width:"8rem","object-fit":"cover","border-radius":".5rem",border:"1px solid"}},null,8,nl)):H("",!0)]),il,l("div",rl,[(f(!0),b(F,null,J(ve.value,(E,Ie)=>(f(),Pe(s(h),{key:Ie,style:Ae([{height:"2.3rem","border-radius":".3rem",padding:".5rem"},v.value.includes(E.label)?{backgroundColor:E.bg,color:"#fff"}:{backgroundColor:"#ffffff20",color:E.bg}]),text:"",onClick:Hl=>fe(E),class:"status",label:E.label},null,8,["onClick","label","style"]))),128))]),l("div",ul,[o(s(ie),{rows:10,paginator:"",stripedRows:"",showGridlines:"",paginatorTemplate:"FirstPageLink PrevPageLink PageLinks NextPageLink LastPageLink CurrentPageReport RowsPerPageDropdown",rowsPerPageOptions:[5,10,15,25,100],currentPageReportTemplate:"Mostrando {first} a {last} de {totalRecords} clientes",responsiveLayout:"scroll",scrollable:"",value:Z.value,header:"clientes"},{default:p(()=>[o(s(U),{class:"py-1",header:"Nombre",field:"nombre"}),o(s(U),{class:"py-1",header:"Número",field:"wa_id"}),o(s(U),{class:"py-1",header:"Clasificación",field:"clasification"})]),_:1},8,["value"])])])]}),_:1},8,["visible"]),l("div",dl,[l("div",cl,[l("div",ml,[pl,l("span",vl,[fl,o(s(D),{modelValue:P.value,"onUpdate:modelValue":a[2]||(a[2]=e=>P.value=e),modelModifiers:{trim:!0},placeholder:"Buscar…",class:"w-full"},null,8,["modelValue"])]),o(s(G),{modelValue:y.value,"onUpdate:modelValue":a[3]||(a[3]=e=>y.value=e),options:W.value.filter(e=>e.exist),optionLabel:"name",placeholder:"Selecciona un restaurante",class:"w-full md:w-80 my-3"},null,8,["modelValue","options"])]),o(s(ie),{style:{"max-width":"80rem",width:"100%",overflow:"auto"},value:be.value,dataKey:"id",scrollable:"","scroll-height":"65vh",paginator:"",rows:10,responsiveLayout:"scroll",globalFilterFields:["name","category"],class:"shadow-md rounded-xl overflow-hidden"},{default:p(()=>[o(s(U),{class:"my-1 py-1",field:"name",header:"Nombre",bodyClass:"font-medium"}),o(s(U),{class:"my-1 py-1",header:"Texto"},{body:p(({data:e})=>{var n;return[l("span",null,w((n=e==null?void 0:e.components.find(i=>i.type=="BODY"))==null?void 0:n.text),1)]}),_:1}),o(s(U),{class:"my-1 py-1",header:"Texto"},{body:p(({data:e})=>{var n,i,d,u;return[(i=(n=e==null?void 0:e.components.find(_=>_.type=="HEADER"))==null?void 0:n.example)!=null&&i.header_handle[0]?(f(),b("div",hl,[l("img",{style:{height:"10rem",width:"10rem","aspect-ratio":"1 / 1","object-fit":"cover","border-radius":".5rem",border:"1px solid"},src:(u=(d=e==null?void 0:e.components.find(_=>_.type=="HEADER"))==null?void 0:d.example)==null?void 0:u.header_handle[0]},null,8,gl)])):H("",!0)]}),_:1}),o(s(U),{class:"my-1 py-1",header:"Estado"},{body:p(({data:e})=>[o(s(ue),{severity:Ee(e.status)},{default:p(()=>[k(w(e.status),1)]),_:2},1032,["severity"])]),_:1}),o(s(U),{class:"my-1 py-1",headerStyle:"width:8rem",header:"Acciones"},{body:p(({data:e})=>[l("div",yl,[o(s(h),{icon:"pi pi-eye",severity:"warning",onClick:n=>Ve(e)},null,8,["onClick"]),o(s(h),{icon:"pi pi-sync",label:"Difundir",severity:"help",onClick:n=>we(e)},null,8,["onClick"])])]),_:1})]),_:1},8,["value"]),l("div",_l,[o(s(h),{label:"Nueva plantilla",icon:"pi pi-plus",severity:"help",class:"w-full md:w-auto",onClick:Ue})]),o(s(re),{visible:S.value,"onUpdate:visible":a[9]||(a[9]=e=>S.value=e),header:Te.value,modal:"",class:"",style:{width:"90vw","max-width":"20rem","min-width":"40rem"}},{footer:p(()=>[o(s(h),{label:"cerrar",text:"",severity:"secondary",onClick:a[8]||(a[8]=e=>S.value=!1)}),o(s(h),{label:"Guardar",severity:"help",icon:"pi pi-check",onClick:$e,loading:Y.value,autofocus:""},null,8,["loading"])]),default:p(()=>[l("div",bl,[l("div",wl,[l("div",xl,[N.value?(f(),b("div",El,[l("img",{src:K.value,style:{width:"100%",height:"100%","object-fit":"cover","border-radius":".5rem"}},null,8,Ul),o(s(h),{icon:"pi pi-times",severity:"danger",size:"small",style:{position:"absolute",top:".1rem",right:".1rem"},onClick:ce})])):H("",!0)]),l("div",Tl,[l("img",{src:le.value,style:{"max-width":"20rem",margin:"","aspect-ratio":"1 / 1","object-fit":"contain"},alt:""},null,8,Vl)]),l("div",Cl,[kl,o(s(D),{modelValue:g.value.name,"onUpdate:modelValue":a[4]||(a[4]=e=>g.value.name=e),class:"w-full"},null,8,["modelValue"])]),l("div",$l,[Sl,o(s(G),{modelValue:g.value.category,"onUpdate:modelValue":a[5]||(a[5]=e=>g.value.category=e),options:ge,optionLabel:"label",optionValue:"value",class:"w-full"},null,8,["modelValue"])]),l("div",Il,[Ll,o(s(G),{modelValue:g.value.language,"onUpdate:modelValue":a[6]||(a[6]=e=>g.value.language=e),options:ye,optionLabel:"label",optionValue:"value",class:"w-full"},null,8,["modelValue"])])]),l("div",null,[l("h6",Nl,[k("Cuerpo del mensaje "),l("small",Dl,"(usa "+w(t.param)+" o "+w(1)+")",1)]),o(s(je),{"auto-resize":"",modelValue:I.value,"onUpdate:modelValue":a[7]||(a[7]=e=>I.value=e),rows:"6",class:"w-full"},null,8,["modelValue"])]),j.value.length?(f(),b("div",Ol,[Rl,(f(!0),b(F,null,J(j.value,e=>(f(),b("div",{key:e,style:{"align-items":"center",display:"flex",gap:"1rem"},class:""},[o(s(ue),{severity:"info",style:{padding:"0 1rem",height:"2.8rem","min-width":"2.8rem"},class:"min-w-[5rem] text-center text-xl"},{default:p(()=>[k(w(e),1)]),_:2},1024),o(s(D),{modelValue:m.value[e],"onUpdate:modelValue":n=>m.value[e]=n,placeholder:`Ejemplo para ${e}`,class:"flex-1"},null,8,["modelValue","onUpdate:modelValue","placeholder"])]))),128))])):H("",!0),l("div",Pl,[l("div",Al,[jl,o(s(h),{icon:"pi pi-plus",severity:"success",onClick:Ce})]),l("div",Bl,[(f(!0),b(F,null,J(T.value,(e,n)=>(f(),b("div",{key:n,class:"",style:{display:"grid","grid-template-columns":"10rem  1fr 1fr 3rem",gap:".5rem"}},[o(s(G),{modelValue:e.type,"onUpdate:modelValue":i=>e.type=i,options:_e,optionLabel:"label",optionValue:"value"},null,8,["modelValue","onUpdate:modelValue"]),o(s(D),{modelValue:e.text,"onUpdate:modelValue":i=>e.text=i,placeholder:"Texto"},null,8,["modelValue","onUpdate:modelValue"]),o(s(D),{modelValue:e.url,"onUpdate:modelValue":i=>e.url=i,placeholder:"URL"},null,8,["modelValue","onUpdate:modelValue"]),o(s(h),{icon:"pi pi-times",severity:"danger",onClick:i=>T.value.splice(n,1)},null,8,["onClick"])]))),128))])])])]),_:1},8,["visible","header"]),o(s(Be))])])],64))}},Ml=Le(Fl,[["__scopeId","data-v-f46a8681"]]);export{Ml as default};
