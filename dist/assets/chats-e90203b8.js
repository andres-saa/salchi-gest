import{H as Ee,h as y,i as re,I as le,j as L,J as I,D as ye,g as $,o as p,c as k,a as e,n as c,u as o,F as pe,r as me,d as T,e as h,t as f,f as _,b as ce,k as D,p as Te,m as Le,_ as be,C as Ne,l as Ue,G as Ie,U as Re,q as ve,K as Oe,L as ze}from"./index-a94103e7.js";import{c as xe,u as De,P as Ae}from"./Messages.vue_vue_type_style_index_0_scoped_09e7a26a_lang-b6eb416f.js";/* empty css                                                             */import Ve from"./Messages-6cdd4925.js";const fe=R=>(Te("data-v-4b731f1a"),R=R(),Le(),R),Me={class:"sidebar-container",style:{position:"relative"}},Pe={class:"header"},Be=fe(()=>e("strong",null," Notificaciones ",-1)),Fe=[Be],We=["onClick"],Je={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},Ke={style:{display:"flex","flex-direction":"column",width:"100%"}},qe=fe(()=>e("h3",null,[e("b",null," Buscar un usuario")],-1)),Ge=["onClick"],He={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},Xe={style:{"grid-area":"check",display:"flex","justify-content":"end",gap:".5rem"}},Ye={key:0,style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold"}},Ze={style:{color:"white"}},Qe=fe(()=>e("i",{style:{color:"greenyellow"},class:"fa-solid fa-check-double"},null,-1)),et={key:0,style:{bottom:"0","padding-bottom":"1rem",background:"linear-gradient(to bottom , transparent 3%, black)",display:"flex",position:"absolute","z-index":"100",width:"100%",color:"white"}},tt={key:1,style:{"text-align":"center",padding:".5rem",color:"#ffffff80"}},at={class:"flex align-items-center"},st=["src"],ot={class:"flex align-items-center"},it=["src"],nt={style:{display:"flex",gap:"1rem"}},rt={style:{color:"white"}},lt={class:"statuses"},ct=["onClick"],dt={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},ut={style:{"grid-area":"check",display:"flex","justify-content":"end",gap:".5rem"}},pt={key:0,style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold"}},mt={style:{color:"white"}},ft=fe(()=>e("i",{style:{color:"greenyellow"},class:"fa-solid fa-check-double"},null,-1)),_t={key:0,style:{bottom:"0","padding-bottom":"1rem",background:"linear-gradient(to bottom , transparent 3%, black)",display:"flex",position:"absolute","z-index":"100",width:"100%",color:"white"}},ht={key:1,style:{"text-align":"center",padding:".5rem",color:"#ffffff80"}},Se=1e3,gt=Ee({__name:"Sidebar",props:{restaurant:Object},setup(R){const b=y(!1),P=y(!1),Q=y(""),ee=y(!1),te=n=>{n.target.closest(".notifications")||(b.value=!1)};re(()=>{document.addEventListener("click",te)}),le(()=>{document.removeEventListener("click",te)});const g=xe(),q=R,l=De(),G=[{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"},{id:7,name:"Distrimoster",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"}],d=y(q.restaurant||G[0]);y([{label:"Todos",textColor:"#4CAF50"},{label:"Sin leer",textColor:"#2196F3"},{label:"Favoritos",textColor:"#FFC107"},{label:"Preocupantes",textColor:"#F44336"},{label:"Top",textColor:"#9C27B0"}]);const j=async n=>{l.current_user=n,P.value=!1,b.value=!1;try{await L.post(`${I}/read-message/${n.user_id}/${d.value.id}`,!1)}catch(r){console.error("No se pudo marcar como leído",r)}n.unreaded=0},B=async n=>{var r;l.current_user=n.user_info,b.value=!1;try{await L.post(`${I}/read-message/${n.user_info.user_id}/${d.value.id}`,!1),await L.post(`${I}/view_notification/${n.id}`,!1),l.notifications[d.value.id]=await L.get(`${I}/notifications/${d.value.id}`);const t=(r=l.sidebars[d.value.id])==null?void 0:r.findIndex(a=>a.user_id==n.user_info.user_id);console.log(t),t!==-1&&(l.sidebars[d.value.id][t].unreaded=0)}catch(t){console.error("No se pudo marcar como leído",t)}},S=[{label:"SIN LEER",bg:"#f39c12",icon:"fa-solid fa-envelope-open"},{label:"LEIDOS",bg:"#16a085",icon:"fa-solid fa-envelope-circle-check"},{label:"TODO",bg:"#34495e",icon:"fa-solid fa-inbox"},{label:"SIN DATOS",bg:"#95a5a6",icon:"fa-solid fa-circle-question"},{label:"PREOCUPANTE",bg:"#e74c3c",icon:"fa-solid fa-triangle-exclamation"},{label:"CASUAL",bg:"#e67e22",icon:"fa-solid fa-person-walking"},{label:"FRECUENTE",bg:"#27ae60",icon:"fa-solid fa-repeat"},{label:"TOP",bg:"#2980b9",icon:"fa-solid fa-ranking-star"},{label:"ESTRELLA",bg:"#8e44ad",icon:"fa-solid fa-star"}],O=y({label:"SIN LEER",bg:"#f39c12",icon:"fa-solid fa-envelope-open"}),ae=y(0);let A=0;const F=y(!1),V=y(!1),w=y(null),se=(n="")=>{const r=n.trim().split(" ");return(Array.from(r[0]||"")[0]||"")+(r[1]?Array.from(r[1])[0]:"")};re(async()=>{l.notifications[d.value.id]=await L.get(`${I}/notifications/${d.value.id}`)});const _e=n=>n==="9+"?10:Number(n??0),z=(n,r)=>{const t=l.sidebars[n]||[];r.forEach(a=>{const i=t.findIndex(u=>u.wa_id===a.wa_id);if(i===-1)t.push(a);else{const u=t[i],C=u.ultimo_mensaje_id!==a.ultimo_mensaje_id,x=u.color!==a.color,E=u.nombre!==a.nombre,J=a.unreaded!=u.unreaded;(C||J||x||E)&&(t[i]=a)}}),l.sidebars[n]=t,ae.value=t.reduce((a,i)=>a+_e(i.unreaded),0)},H=async()=>{if(F.value||V.value)return;F.value=!0;const n=`${I}/last-contact-messages/${d.value.id}?limit=${Se}&offset=${A}`,r=await L.get(n,!1);r.length<Se&&(V.value=!0),A+=r.length,z(d.value.id,r),F.value=!1},N=()=>{const n=w.value;if(!n||F.value||V.value)return;n.scrollTop+n.clientHeight>=n.scrollHeight-120&&H()},he=n=>{const r=d.value.id,t=l.sidebars[r]||[],a=t.findIndex(i=>i.wa_id===n.wa_id);a!==-1?(t.splice(a,1),l.sidebars[r]=[n,...t]):l.sidebars[r]=[n,...t],ae.value=l.sidebars[r].reduce((i,u)=>i+Number(u.unreaded||0),0)};let U=null;const oe=()=>{const n=`wss://sockets-service.salchimonster.com/ws/salchimonster-${d.value.id}`;U=new WebSocket(n),U.onopen=()=>console.log("WebSocket conectado a",n),U.onerror=r=>console.error("WebSocket error",r),U.onclose=()=>setTimeout(oe,5e3),U.onmessage=async r=>{const t=JSON.parse(r.data);t!=null&&t.user_id&&he(t)}};let M=null;const X=()=>{const n=`wss://sockets-service.salchimonster.com/ws/salchimonster-notifications-${d.value.id}`;M=new WebSocket(n),M.onopen=()=>console.log("WebSocket conectado a",n),M.onerror=r=>console.error("WebSocket error",r),M.onclose=()=>setTimeout(X,5e3),M.onmessage=async r=>{l.notifications[d.value.id]=await L.get(`${I}/notifications/${d.value.id}`),ee.value=!0,setTimeout(()=>{ee.value=!1},1e3),JSON.parse(r.data)}};ye(d,async n=>{A=0,V.value=!1,l.sidebars[n.id]=[],U&&U.close(),oe(),X(),await H(),W.value=!1,setTimeout(()=>{W.value=!0},0)}),re(async()=>{var n;await H(),(n=w.value)==null||n.addEventListener("scroll",N),oe(),X()}),le(()=>{var n;(n=w.value)==null||n.removeEventListener("scroll",N),U&&U.close()});const W=y(!0),ge=n=>{O.value=n,W.value=!1,setTimeout(()=>{W.value=!0},0)};return(n,r)=>{var E,J,Y,Z,ie,ne;const t=$("RouterLink"),a=$("InputText"),i=$("ProgressSpinner"),u=$("Button"),C=$("Dialog"),x=$("Dropdown");return p(),k("div",Me,[e("div",Pe,[e("div",{class:"notifications",style:c([b.value?{height:"calc(100vh - 8rem)",top:"4rem",boxShadow:"0 1rem 1rem #00000040"}:{height:0,overflow:"hidden",top:"-2rem"},{width:"100%","max-width":"90%","background-color":"#ffffff90","max-height":"90vh",overflow:"auto",position:"absolute","z-index":"9",transition:"all linear .2s","border-radius":".5rem",right:"0","backdrop-filter":"blur(5px)",display:"flex","flex-direction":"column"}])},[e("h4",{class:"my-3 px-3",style:c(o(g).current_chat_theme.text)},Fe,4),(p(!0),k(pe,null,me((J=(E=o(l))==null?void 0:E.notifications)==null?void 0:J[d.value.id],(s,m)=>(p(),T(t,{"active-class":o(g).current_chat_theme.name==="dark"?"active":"active-light",key:m,to:`/chat/chats/messages/${d.value.id}/${s.user_info.wa_id}/${(s.user_info.nombre||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^A-Za-z0-9_-]/g,"")||"n"}/${s.user_info.color}?expirado=${s.user_info.expirado}&expira-en=${s.user_info.tiempo_para_expirar}`},{default:h(()=>[e("div",{class:"chat2",onClick:()=>B(s),style:c(s.resolved?"background-color: #fff":"background-color: #b6f8ff59")},[e("div",Je,[e("div",{style:c([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${s.user_info.color||"black"}`])},f(se(s.user_info.nombre)),5)]),e("div",{style:c([{"grid-area":"nombre"},`${o(g).current_chat_theme.text} ; ${s.resolved?"":"font-weight: bold;"}`])},f(s.description),5),e("span",{style:c([{"grid-area":"mensaje",color:"#ffffff80",opacity:".5"},o(g).current_chat_theme.text])},f(s.user_info.nombre.slice(0,20))+"... ",5),e("p",{class:"p-0 m-0",style:c([{"grid-area":"fecha","text-align":"end","min-width":"max-content"},o(g).current_chat_theme.text])},f(s.user_info.hora_ultimo_mensaje),5)],12,We)]),_:2},1032,["active-class","to"]))),128))],4),_(C,{closable:!1,header:"Buscar un usuario",visible:P.value,"onUpdate:visible":r[2]||(r[2]=s=>P.value=s),style:{width:"50rem"},modal:""},{header:h(()=>[e("div",Ke,[qe,_(a,{modelValue:Q.value,"onUpdate:modelValue":r[0]||(r[0]=s=>Q.value=s),style:{width:"100%"},placeholder:"Escriba el nombre o numero del usuario"},null,8,["modelValue"])])]),default:h(()=>{var s;return[e("div",{class:ce(["",W.value?"chats active-new":"chats"]),style:{height:"67vh"},ref_key:"chatsContainer",ref:w,onScroll:N},[(p(!0),k(pe,null,me(((s=o(l).sidebars[d.value.id])==null?void 0:s.filter(m=>{var ue,we,ke,$e;const v=((we=(ue=Q.value)==null?void 0:ue.toLowerCase())==null?void 0:we.trim())||"";if(v==="")return!1;const K=((ke=m.nombre)==null?void 0:ke.toLowerCase())||"",de=(($e=m.wa_id)==null?void 0:$e.toLowerCase())||"";return K.includes(v)||de.includes(v)}))||[],(m,v)=>(p(),T(t,{"active-class":o(g).current_chat_theme.name=="dark"?"active":"active-light",key:v,to:`/chat/chats/messages/${d.value.id}/${m.wa_id}/${m.nombre}/${m.color}?expirado=${m.expirado}&?expira-en?=${m.tiempo_para_expirar}`},{default:h(()=>[e("div",{class:"chat",onClick:()=>j(m)},[e("div",He,[e("div",{style:c([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${m.color||"black"}`])},f(se(m.nombre)),5)]),e("div",{style:c([{"grid-area":"nombre","text-transform":"capitalize","font-weight":"500"},o(g).current_chat_theme.text])},f(m.nombre),5),e("div",{style:c([{"grid-area":"numero","text-transform":"capitalize",opacity:".7"},o(g).current_chat_theme.text])},"+"+f(m.wa_id),5),e("span",{style:c([{"grid-area":"mensaje",color:"#ffffff80",opacity:".5"},o(g).current_chat_theme.text])},f(m.mensaje_truncado),5),e("span",{style:c([{"grid-area":"fecha","text-align":"end"},o(g).current_chat_theme.text])},f(m.abreviatura||m.fecha_ultimo_mensaje),5),e("span",{style:c([{"grid-area":"hora",color:"#ffffff80",opacity:".5","text-align":"end"},o(g).current_chat_theme.text])},f(m.hora_ultimo_mensaje),5),e("div",Xe,[m.unreaded>0?(p(),k("div",Ye,[e("span",Ze,f(m.unreaded),1)])):D("",!0),Qe])],8,Ge)]),_:2},1032,["active-class","to"]))),128)),F.value?(p(),k("div",et,[(p(),T(i,{key:0,style:{width:"50px",height:"50px"},strokeWidth:"8",fill:"transparent",animationDuration:".3s","aria-label":"Custom ProgressSpinner"}))])):D("",!0),V.value?(p(),k("div",tt,"No hay más chats.")):D("",!0)],34),_(u,{rounded:"",onClick:r[1]||(r[1]=m=>P.value=!1),icon:"pi pi-times  text-xl",style:{position:"absolute",top:"-1rem",right:"-1rem"},severity:"danger"})]}),_:1},8,["visible"]),_(x,{modelValue:d.value,"onUpdate:modelValue":r[3]||(r[3]=s=>d.value=s),options:G,optionLabel:"name",style:c([{"background-color":"#ffffff20",outline:"none","box-shadow":"none"},o(g).current_chat_theme.border])},{option:h(s=>[e("div",at,[e("img",{src:s.option.img,alt:"Logo",style:{width:"24px",height:"24px","margin-right":"8px","object-fit":"contain"}},null,8,st),e("span",null,[e("b",null,f(s.option.name),1)])])]),value:h(s=>[e("div",ot,[s.value?(p(),k("img",{key:0,src:s.value.img,alt:"Logo",style:{width:"24px",height:"24px","margin-right":"8px","object-fit":"contain"}},null,8,it)):D("",!0),e("span",{style:c(o(g).current_chat_theme.text)},f(s.value?s.value.name:"Selecciona"),5)])]),_:1},8,["modelValue","style"]),e("div",nt,[_(u,{class:"options",text:""},{default:h(()=>[e("i",{class:"pi pi-search text-2xl",onClick:r[4]||(r[4]=s=>P.value=!0),style:c(o(g).current_chat_theme.text)},null,4)]),_:1}),e("div",{class:"notifications",style:{position:"relative",cursor:"pointer"},onClick:r[5]||(r[5]=s=>b.value=!b.value)},[_(u,{class:"options",text:"",style:{opacity:".5"}},{default:h(()=>[e("i",{class:"pi pi-bell text-2xl notifications",style:c(o(g).current_chat_theme.text)},null,4)]),_:1}),e("div",{class:ce(ee.value?"load":""),style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",position:"absolute",top:"-1rem",right:"-.7rem",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold",padding:".8rem"}},[e("span",rt,f(((ie=(Z=(Y=o(l))==null?void 0:Y.notifications)==null?void 0:Z[d.value.id])==null?void 0:ie.length)||0),1)],2)]),_(u,{class:"options",text:""},{default:h(()=>[e("i",{class:"pi pi-bars text-2xl",style:c(o(g).current_chat_theme.text)},null,4)]),_:1})])]),e("div",lt,[(p(),k(pe,null,me(S,(s,m)=>_(u,{style:c([{"border-radius":".3rem",padding:"0.3rem","text-transform":"capitalize"},s.label===O.value.label?{backgroundColor:s.bg,color:"#fff"}:{backgroundColor:"#ffffff20",color:s.bg}]),text:"",icon:s.icon,key:m,onClick:()=>ge(s),class:"status",label:s.label.toLowerCase()},null,8,["icon","onClick","label","style"])),64))]),e("div",{class:ce(["",W.value?"chats active-new":"chats"]),ref_key:"chatsContainer",ref:w,onScroll:N},[(p(!0),k(pe,null,me(((ne=o(l).sidebars[d.value.id])==null?void 0:ne.filter(s=>O.value.label==="TODO"?!0:O.value.label==="SIN LEER"?s.unreaded>0:O.value.label==="LEIDOS"?s.unreaded==0:s.clasification===O.value.label))||[],(s,m)=>(p(),T(t,{"active-class":o(g).current_chat_theme.name=="dark"?"active":"active-light",key:m,to:`/chat/chats/messages/${d.value.id}/${s.wa_id}/${s.nombre}/${s.color}?expirado=${s.expirado}&?expira-en?=${s.tiempo_para_expirar}`},{default:h(()=>[e("div",{class:"chat",onClick:()=>j(s)},[e("div",dt,[e("div",{style:c([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${s.color||"black"}`])},f(se(s.nombre)),5)]),e("div",{style:c([{"grid-area":"nombre","text-transform":"capitalize","font-weight":"500"},o(g).current_chat_theme.text])},f(s.nombre),5),e("div",{style:c([{"grid-area":"numero","text-transform":"capitalize",opacity:".7"},o(g).current_chat_theme.text])},"+"+f(s.wa_id),5),e("span",{style:c([{"grid-area":"mensaje",color:"#ffffff80",opacity:".5"},o(g).current_chat_theme.text])},f(s.mensaje_truncado),5),e("span",{style:c([{"grid-area":"fecha","text-align":"end"},o(g).current_chat_theme.text])},f(s.abreviatura||s.fecha_ultimo_mensaje),5),e("span",{style:c([{"grid-area":"hora",color:"#ffffff80",opacity:".5","text-align":"end"},o(g).current_chat_theme.text])},f(s.hora_ultimo_mensaje),5),e("div",ut,[s.unreaded>0?(p(),k("div",pt,[e("span",mt,f(s.unreaded),1)])):D("",!0),ft])],8,ct)]),_:2},1032,["active-class","to"]))),128)),F.value?(p(),k("div",_t,[(p(),T(i,{key:0,style:{width:"50px",height:"50px"},strokeWidth:"8",fill:"transparent",animationDuration:".3s","aria-label":"Custom ProgressSpinner"}))])):D("",!0),V.value?(p(),k("div",ht,"No hay más chats.")):D("",!0)],34)])}}}),Ce=be(gt,[["__scopeId","data-v-4b731f1a"]]),je=R=>(Te("data-v-07d567be"),R=R(),Le(),R),vt={class:"top-bar-left"},yt={style:{height:"3rem",width:"3rem",display:"flex","align-items":"center"}},bt={class:"top-bar-info"},xt={style:{display:"flex","flex-direction":"column"}},wt={style:{display:"flex","align-items":"center",gap:"1rem"}},kt={style:{height:"100%",overflow:"auto"}},$t={class:"message-area"},St=je(()=>e("i",{class:"fas fa-laugh-wink emoji-picker"},null,-1)),Ct=["onKeydown"],Et=["src"],Tt={style:{position:"relative",transition:".2s"}},Lt=je(()=>e("i",{class:"pi pi-send text-2xl"},null,-1)),Dt={style:{display:"flex",gap:"1rem"}},jt={class:"flex gap-2"},Nt={style:{width:"100%",display:"flex","justify-content":"end"}},Ut=Ee({__name:"Main",setup(R){const b=xe();function P(t){return{APPROVED:"success",PENDING:"warning",REJECTED:"danger"}[t]||"info"}const Q=t=>{ee(t),q.value=!1};async function ee(t){const a=t,i=new FormData;i.append("messaging_product","whatsapp"),i.append("employer_id",G.rawUserData.id.toString()),i.append("context_message_id",""),i.append("restaurant_id",l.params.restaurant_id),i.append("to",l.params.user_id),i.append("type","template"),i.append("template",JSON.stringify(a));try{w.sending=!0,await L.post(`${I}/webhook/send/template/`,i,!1),console.log(`✅ Template enviado a ${to}`)}catch(u){console.error(`✗ Error al enviar template a ${to}`,u)}finally{w.sending=!1}}const te=y([{}]),g=t=>{t.target.closest(".emoji-picker")||(d.value=!1)};re(()=>{document.addEventListener("click",g),r()}),le(()=>{document.removeEventListener("click",g)});const q=y(!1);y([]);const l=Ne(),G=Ue(),d=y(!1),j=y(""),B=y(!1),S=y(null),O=y(!1),ae=y(!0),A=Ie(()=>{var t,a;return ae.value&&(((t=l.query)==null?void 0:t.expirado)==="true"||((a=l.query)==null?void 0:a.expirado)===!0)}),F=t=>{ae.value=t};ye(()=>{var t;return(t=l.params)==null?void 0:t.restaurant_id},()=>{r()}),ye(A,t=>{j.value=t?"Conversación expirada":""},{immediate:!0});const V={"SIN DATOS":{bg:"#7f8c8d",icon:"fa-circle-question"},PREOCUPANTE:{bg:"#e74c3c",icon:"fa-triangle-exclamation"},CASUAL:{bg:"#e67e22",icon:"fa-person-walking"},FRECUENTE:{bg:"#27ae60",icon:"fa-repeat"},TOP:{bg:"#2980b9",icon:"fa-ranking-star"},ESTRELLA:{bg:"#8e44ad",icon:"fa-star"}},w=De();y([{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"},{id:7,name:"Distrimoster",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"}]);const se=(t="")=>{const a=t.trim().split(" ");return(Array.from(a[0]||"")[0]||"")+(a[1]?Array.from(a[1])[0]:"")},_e=t=>{j.value+=t.i,d.value=!1};let z=null,H=[],N=null;const he=async()=>{if(B.value&&z){z.stop();return}try{N=await navigator.mediaDevices.getUserMedia({audio:!0});const t=MediaRecorder.isTypeSupported("audio/ogg;codecs=opus")?"audio/ogg;codecs=opus":"audio/webm;codecs=opus";z=new MediaRecorder(N,{mimeType:t}),z.ondataavailable=a=>a.data.size&&H.push(a.data),z.onstop=()=>{const a=new Blob(H,{type:t.split(";")[0]});H=[],N.getTracks().forEach(u=>u.stop());const i=t.startsWith("audio/ogg")?"ogg":"webm";S.value={file:new File([a],`audio_${Date.now()}.${i}`,{type:a.type}),url:URL.createObjectURL(a)},B.value=!1},z.start(),B.value=!0}catch(t){console.error("No se pudo abrir el micrófono:",t.name,t.message),B.value=!1,N&&N.getTracks().forEach(a=>a.stop())}},U=()=>{S.value&&URL.revokeObjectURL(S.value.url),S.value=null};le(()=>{z&&B.value&&z.stop(),N&&N.getTracks().forEach(t=>t.stop())});const oe={messaging_product:"whatsapp",employer_id:G.rawUserData.id,context_message_id:null},M=async(t,a=null)=>{var u,C;if(A.value||!t.trim())return;const i=new FormData;i.append("messaging_product","whatsapp"),i.append("employer_id",G.rawUserData.id),i.append("context_message_id",((u=a==null?void 0:a.message_data)==null?void 0:u.wa_id)||null),i.append("restaurant_id",(C=l.params.restaurant_id)==null?void 0:C.toString()),i.append("to",l.params.user_id),i.append("type","text"),i.append("text",JSON.stringify({body:t})),j.value="";try{w.sending=!0,await L.post(`${I}/webhook/send/text/`,i,!1)}catch(x){console.error("Error al enviar texto",x)}w.sending=!1},X=async()=>{var u;if(A.value||!S.value||O.value)return;const t=S.value;U(),O.value=!0;const a=new FormData;a.append("files",t.file);const i={...oe,restaurant_id:(u=l.params.restaurant_id)==null?void 0:u.toString(),to:l.params.user_id,type:"audio",text:{body:""},file_index:0};a.append("payloads",JSON.stringify(i));try{await L.post(`${I}/webhook/send`,a,!1)}catch(C){console.error("Error al enviar audio",C)}O.value=!1},W=async t=>{var C;if(A.value||!(t!=null&&t.length))return;const a=new FormData,i={restaurant_id:(C=l.params.restaurant_id)==null?void 0:C.toString(),to:l.params.user_id,messaging_product:"whatsapp",employer_id:G.rawUserData.id,context_message_id:null},u=x=>{var Z;const{type:E,name:J}=x;if(E.startsWith("image/"))return"image";if(E.startsWith("audio/"))return"audio";if(E.startsWith("video/"))return"video";if(E==="application/pdf")return"document";const Y=(Z=J.split(".").pop())==null?void 0:Z.toLowerCase();return["jpg","jpeg","png","webp"].includes(Y)?"image":["mp3","wav","ogg","opus"].includes(Y)?"audio":"document"};t.forEach((x,E)=>{a.append("files",x.file),a.append("payloads",JSON.stringify({...i,type:u(x.file),text:{body:x.caption||""},file_index:E}))}),w.sending=!0;try{await L.post(`${I}/webhook/send`,a,!1)}catch(x){console.error("Error al enviar archivos",x)}w.sending=!1},ge=t=>{t.key==="Enter"&&(t.preventDefault(),j.value.trim()&&M(j.value))},n=t=>{t.key==="Enter"&&S.value&&(t.preventDefault(),X())};re(()=>window.addEventListener("keydown",n)),le(()=>window.removeEventListener("keydown",n));async function r(){if(l.params.restaurant_id){const a=(await L.get(`${Re}/restaurants`)||[]).find(i=>{var u;return i.id==((u=l.params)==null?void 0:u.restaurant_id)})||null;a&&(te.value=await L.get(`${I}/wabas/${a.waba_id}/templates/`))}}return(t,a)=>{var ie,ne,s,m;const i=$("Button"),u=$("RouterView"),C=$("Textarea"),x=$("Column"),E=$("Tag"),J=$("DataTable"),Y=$("RouterLink"),Z=$("Dialog");return p(),k("div",{class:"main-container",style:c([o(b).current_chat_theme.bg_image,{}])},[(ie=o(l).params)!=null&&ie.user_id?(p(),k("div",{key:0,tabindex:"0",class:"top-bar",style:c([{"border-radius":".5rem",gap:"1rem"},o(b).current_chat_theme.bg_bars])},[e("div",vt,[e("div",yt,[e("div",{class:"cliente-img",style:c([`background-color:${o(l).params.color}`,{height:"100%",color:"white",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"}])},f(se(o(l).params.user_name)),5)]),e("div",bt,[e("div",xt,[e("strong",null,[e("h5",{style:c([{"text-transform":"capitalize",margin:"0"},o(b).current_chat_theme.text])},f((ne=o(l).params.user_name)==null?void 0:ne.substring(0,20)),5)]),e("span",null,"+"+f(o(l).params.user_id),1)]),e("div",null,[o(w).current_user.clasification?(p(),T(i,{key:0,style:c({height:"2.3rem",display:"flex",alignItems:"center",textTransform:"capitalize",gap:"0.35rem",backgroundColor:((s=V[o(w).current_user.clasification])==null?void 0:s.bg)||"#7f8c8d",color:"#fff"})},{default:h(()=>{var v,K;return[e("i",{class:ce(["fa-solid",(v=V[o(w).current_user.clasification])==null?void 0:v.icon]),"aria-hidden":"true",style:{"font-size":"0.9rem"}},null,2),ve(" "+f((K=o(w).current_user.clasification)==null?void 0:K.toLowerCase())+" "+f(o(w).current_user.times_purchased)+" compras ",1)]}),_:1},8,["style"])):D("",!0)])])]),e("div",wt,[_(i,{icon:"pi pi-shopping-cart",class:"p-2",style:{color:"white","min-width":"max-content"},severity:"warning",label:"Ing. Ped"}),_(i,{text:"",class:"p-2"},{default:h(()=>[e("i",{style:c(o(b).current_chat_theme.text),class:"pi pi-search text-2xl"},null,4)]),_:1}),_(i,{text:"",class:"p-2"},{default:h(()=>[e("i",{style:c(o(b).current_chat_theme.text),class:"pi pi-bars text-2xl"},null,4)]),_:1})])],4)):D("",!0),e("div",kt,[_(u,null,{default:h(()=>[o(l).params.user_id?(p(),T(Ve,{key:0,send_function:W,send_text:M,change_expiration:F,ref:"Messages_element"},null,512)):D("",!0)]),_:1})]),(m=o(l).params)!=null&&m.user_id?(p(),k("div",{key:1,class:"chat-bar",tabindex:"0",style:c(o(b).current_chat_theme.bg_bars)},[d.value?(p(),T(o(Ae),{key:0,native:!0,style:{position:"absolute",bottom:"4rem","z-index":"1000"},onSelect:_e,class:"emoji-picker"})):D("",!0),e("div",$t,[_(i,{text:"",style:{"font-size":"2rem"},onClick:a[0]||(a[0]=v=>d.value=!d.value)},{default:h(()=>[St]),_:1}),S.value?(p(),k("div",{key:1,class:"audio-chip",onKeydown:Oe(ze(X,["prevent"]),["enter"])},[e("audio",{style:{width:"100%","min-width":"28rem","max-width":"42rem"},src:S.value.url,controls:""},null,8,Et),_(i,{text:"",class:"btn-audio-trash p-2",onClick:U},{default:h(()=>[e("i",{style:c(o(b).current_chat_theme.text),class:"pi pi-trash text-2xl p-0"},null,4)]),_:1})],40,Ct)):(p(),T(C,{key:0,modelValue:j.value,"onUpdate:modelValue":a[1]||(a[1]=v=>j.value=v),autoResize:"",class:"message",disabled:A.value,onKeydown:ge,style:c(`${o(b).current_chat_theme.text} ; ${o(b).current_chat_theme.border} `)},null,8,["modelValue","disabled","style"]))]),e("div",Tt,[!S.value&&j.value.trim()===""?(p(),T(i,{key:0,text:"",style:{height:"100%"},onClick:he},{default:h(()=>[e("i",{style:c(o(b).current_chat_theme.text),class:ce(B.value?"pi pi-stop text-2xl text-red-500":"pi pi-microphone text-2xl ")},null,6)]),_:1})):S.value?(p(),T(i,{key:1,disabled:O.value,text:"",onClick:X},{default:h(()=>[e("i",{style:c(o(b).current_chat_theme.text),class:"pi pi-send text-2xl"},null,4)]),_:1},8,["disabled"])):(p(),T(i,{key:2,style:c(o(b).current_chat_theme.text),text:"",onClick:a[2]||(a[2]=v=>M(j.value))},{default:h(()=>[Lt]),_:1},8,["style"]))]),e("div",Dt,[_(i,{severity:"danger",style:{},icon:"pi pi-clock",class:"p-2",onClick:a[3]||(a[3]=()=>q.value=!0)}),o(l).query.expirado?(p(),T(i,{key:0,icon:"pi pi-bolt",severity:"warning",style:{},class:"p-2",onClick:a[4]||(a[4]=()=>q.value=!0)})):D("",!0)])],4)):D("",!0),_(Z,{visible:q.value,"onUpdate:visible":a[5]||(a[5]=v=>q.value=v),header:"Envio de plantilla",style:{width:"50rem"}},{default:h(()=>[_(J,{value:te.value,dataKey:"id",paginator:"",rows:10,responsiveLayout:"scroll",class:"shadow-md rounded-xl overflow-hidden"},{default:h(()=>[_(x,{class:"my-1 py-1",field:"name",header:"Nombre",bodyClass:"font-medium"}),_(x,{class:"my-1 py-1",header:"Estado"},{body:h(({data:v})=>[_(E,{severity:P(v.status)},{default:h(()=>[ve(f(v.status),1)]),_:2},1032,["severity"])]),_:1}),_(x,{class:"my-1 py-1",header:"Estado"},{body:h(({data:v})=>{var K,de;return[ve(f((de=(K=v==null?void 0:v.components)==null?void 0:K.find(ue=>ue.type=="BODY"))==null?void 0:de.text),1)]}),_:1}),_(x,{class:"my-1 py-1",headerStyle:"width:8rem",header:"Acciones"},{body:h(({data:v})=>[e("div",jt,[_(i,{icon:"pi pi-send",label:"Enviar",severity:"help",onClick:K=>Q(v)},null,8,["onClick"])])]),_:1})]),_:1},8,["value"]),e("div",Nt,[_(Y,{to:"/chat/templates"},{default:h(()=>[_(i,{severity:"help",icon:"pi pi-plus",label:"Agregar otro"})]),_:1})])]),_:1},8,["visible"])],4)}}}),It=be(Ut,[["__scopeId","data-v-07d567be"]]);const Rt={__name:"chats",setup(R){const b=xe();return(P,Q)=>(p(),k("div",{class:"chat-container",style:c(o(b).current_chat_theme.bg)},[_(Ce,{style:{"box-shadow":".5rem 0 1rem #00000010"},class:"sidebar-left",restaurant:{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"}}),_(It),_(Ce,{style:{"box-shadow":"-.5rem 0 1rem #00000010"},class:"sidebar-right",restaurant:{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"}})],4))}},Mt=be(Rt,[["__scopeId","data-v-5877f5bf"]]);export{Mt as default};
