import{s as B}from"./siteService-77184632.js";import{u as E}from"./directorio-d3743566.js";import{A as I}from"./auditService-6d3c8bc4.js";import{G as N,r as u,q as W,I as L,a as v,o as i,b as n,d as a,i as r,u as x,F as b,e as w,g as M,k as j,h as D,t as S,j as F,f as P,af as R,ar as $,U as z}from"./index-e0d1eab6.js";const q={class:"mx-auto",style:{"max-width":"900px"}},G={class:"mx-4"},H={class:"grid my-0 py-0"},J={class:"col-12 my-0 py-2 md:col-6"},K={class:"col-12 my-0 py-2 md:col-6"},Q={class:"",style:{"border-radius":"1rem"}},X=a("p",{class:"text-2xl text-center my-4",style:{"font-weight":"bold"}}," Auditoria ",-1),Y={class:"my-3",style:{"text-transform":"uppercase"}},Z={style:{"overflow-x":"auto"},class:""},ee={class:"col-12 p-0 my-3"},te={class:"col-12 p-0",style:{display:"flex"}},ne={__name:"newAudit",setup(se){const y=N().setLoading,m=E(),h=u([]),C=u([]),p=u({}),c=u({}),_=u(!1),f=u([]);W(async()=>{var e;h.value=await B.getSites();const s=await I.getChecklist();C.value=Array.isArray(s)?s:[],h.value.length>0&&!((e=m.currentSite)!=null&&e.site_name)&&m.setSite(h.value[0])}),L(p,async s=>{s!=null&&s.checklist_id?c.value=await I.getChecklistWithItems(s.checklist_id):c.value=[]});function T(){f.value=c.value.groups.flatMap(s=>s.items.filter(e=>!e.checked)),f.value.length>0?_.value=!0:V()}async function A(){_.value=!1,V()}async function V(){const s=c.value.groups.flatMap(o=>o.items.filter(l=>!l.checked).map(l=>({audit_item:{check_item_id:l.item_id,status:!1,comments:""},warning:{warning_text:l.warning_text||"Observación no proporcionada",resolved:!1,date:new Date().toISOString().split("T")[0]}}))),e={audit:{site_id:m.currentSite.site_id,coordinator_id:$(),audit_date:new Date().toISOString().split("T")[0],checklist_id:p.value.checklist_id},items_with_warnings:s};try{y(!0,"enviando");const o=await fetch(`${z}/audits-with-items-and-warnings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const l=await o.json();y(!1,"enviando"),console.log("Audit created successfully",l),c.value={}}catch(o){y(!1,"enviando"),console.error("Error creating the audit",o)}}return(s,e)=>{const o=v("Dropdown"),l=v("Checkbox"),g=v("Button"),U=v("InputText"),O=v("Dialog");return i(),n("div",q,[a("div",G,[a("div",H,[a("div",J,[r(o,{placeholder:"sede",class:"col-12 p-0",modelValue:x(m).currentSite,"onUpdate:modelValue":e[0]||(e[0]=t=>x(m).currentSite=t),options:h.value,optionLabel:"site_name"},null,8,["modelValue","options"])]),a("div",K,[r(o,{placeholder:"Checklist",class:"col-12 p-0",modelValue:p.value,"onUpdate:modelValue":e[1]||(e[1]=t=>p.value=t),options:C.value,optionLabel:"checklist_name"},null,8,["modelValue","options"])])]),a("div",Q,[X,(i(!0),n(b,null,w(c.value.groups,t=>(i(),n("div",{key:t.group_id},[a("h6",Y,S(t.group_name),1),(i(!0),n(b,null,w(t.items,d=>(i(),n("div",{style:{display:"flex",gap:"1rem"},key:d.item_id,class:"p-field-checkbox"},[r(l,{class:"",modelValue:d.checked,"onUpdate:modelValue":k=>d.checked=k,value:!0,binary:"true"},null,8,["modelValue","onUpdate:modelValue"]),a("label",Z,S(d.item_description),1)]))),128))]))),128))]),p.value.checklist_id?(i(),M(g,{key:0,style:{},onClick:T,size:"small",class:"my-5 col-12 md:col-4",severity:"help",label:"Revisar y Enviar Auditoría"})):j("",!0),r(O,{style:{width:"40rem"},visible:_.value,"onUpdate:visible":e[3]||(e[3]=t=>_.value=t),header:"Añadir Observaciones",modal:"",closable:!1},{footer:D(()=>[a("div",te,[r(g,{class:"col-6",severity:"success",label:"Enviar",onClick:A}),r(g,{class:"col-6",severity:"danger",label:"Cancelar ",onClick:e[2]||(e[2]=t=>_.value=!1)})])]),default:D(()=>[(i(!0),n(b,null,w(f.value,(t,d)=>(i(),n("div",{key:d},[a("h5",ee,[F(S(t.item_description)+" ",1),a("i",{style:{color:"red"},class:P(x(R).TIMES)}," No cumplio",2)]),r(U,{class:"col-12",modelValue:t.warning_text,"onUpdate:modelValue":k=>t.warning_text=k,placeholder:"Observación..."},null,8,["modelValue","onUpdate:modelValue"])]))),128))]),_:1},8,["visible"])])])}}};export{ne as default};
