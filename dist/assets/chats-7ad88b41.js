import{_ as ee,h as d,D as re,i as Y,G as H,g as D,o as c,c as y,a as e,f,e as _,t as b,k as V,F as se,r as oe,d as U,n as Q,u as w,b as Z,H as X,j as G,p as le,m as ce,I as ue,C as pe,l as me,J as _e,q as fe,K as he,L as ge}from"./index-d6f027a1.js";import{u as de,P as ve}from"./Messages.vue_vue_type_style_index_0_scoped_32580997_lang-53b5ec46.js";/* empty css                                                             */import ye from"./Messages-b6e48b88.js";const te=k=>(le("data-v-c1a5efb7"),k=k(),ce(),k),be={class:"sidebar-container",style:{position:"relative"}},xe={class:"header"},we={class:"flex align-items-center"},ke=["src"],Se={class:"flex align-items-center"},$e=["src"],Ee={style:{color:"white"}},Ce={style:{display:"flex",gap:"1rem"}},Te=te(()=>e("i",{class:"pi pi-bars text-2xl text-white"},null,-1)),Le={style:{position:"relative"}},Ue=te(()=>e("i",{class:"pi pi-bell text-2xl text-white"},null,-1)),je={style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",position:"absolute",top:"-1rem",right:"-.7rem",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold"}},De={style:{color:"white"}},Ie={class:"busqueda"},Re={class:"statuses"},Oe=["onClick"],Ne={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},Ae={style:{"grid-area":"nombre","text-transform":"capitalize"}},ze={key:0,style:{"grid-area":"expiration","text-align":"end","text-transform":"capitalize",color:"#ffffff80"}},Fe={key:1,style:{"grid-area":"expiration","text-align":"end","text-transform":"capitalize",color:"#ff000080"}},Me={style:{"grid-area":"mensaje",color:"#ffffff80"}},Ve={style:{"grid-area":"fecha","text-align":"end"}},Be={style:{"grid-area":"check",display:"flex","justify-content":"end",gap:".5rem"}},Pe={key:0,style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold"}},We={style:{color:"white"}},qe=te(()=>e("i",{style:{color:"greenyellow"},class:"fa-solid fa-check-double"},null,-1)),Ke={key:0,style:{bottom:"0","padding-bottom":"1rem",background:"linear-gradient(to bottom , transparent 3%, black)",display:"flex",position:"absolute","z-index":"100",width:"100%",color:"white"}},Je={key:1,style:{"text-align":"center",padding:".5rem",color:"#ffffff80"}},ie=1e3,He={__name:"Sidebar",props:{restaurant:Object},setup(k){const B=k,l=de(),F=[{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"},{id:7,name:"Distrimoster",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"}],u=d(B.restaurant||F[0]);d([{label:"Todos",textColor:"#4CAF50"},{label:"Sin leer",textColor:"#2196F3"},{label:"Favoritos",textColor:"#FFC107"},{label:"Preocupantes",textColor:"#F44336"},{label:"Top",textColor:"#9C27B0"}]);const S=d([{label:"TODO",bg:"#8e44ad",icon:"fa-star"},{label:"SIN DATOS",bg:"#7f8c8d",icon:"fa-circle-question"},{label:"PREOCUPANTE",bg:"#e74c3c",icon:"fa-triangle-exclamation"},{label:"CASUAL",bg:"#e67e22",icon:"fa-person-walking"},{label:"FRECUENTE",bg:"#27ae60",icon:"fa-repeat"},{label:"TOP",bg:"#2980b9",icon:"fa-ranking-star"},{label:"ESTRELLA",bg:"#8e44ad",icon:"fa-star"}]),$=d({label:"TODO",bg:"#8e44ad",icon:"fa-star"}),p=d(0);let I=0;const R=d(!1),E=d(!1),M=d(null),K=o=>{var r;if(!o)return"";const n=o.split(" ");return(n[0][0]||"")+(((r=n[1])==null?void 0:r[0])||"")},C=(o,n)=>{const r=l.sidebars[o]||[];n.forEach(m=>{const g=r.findIndex(O=>O.wa_id===m.wa_id);g===-1?r.push(m):r[g].ultimo_mensaje_id!==m.ultimo_mensaje_id&&(r[g]=m)}),l.sidebars[o]=r,p.value=r.reduce((m,g)=>m+Number(g.unreaded||0),0)},P=async()=>{if(R.value||E.value)return;R.value=!0;const o=`${X}/last-contact-messages/${u.value.id}?limit=${ie}&offset=${I}`,n=await G.get(o,!1);n.length<ie&&(E.value=!0),I+=n.length,C(u.value.id,n),R.value=!1},W=()=>{const o=M.value;if(!o||R.value||E.value)return;o.scrollTop+o.clientHeight>=o.scrollHeight-120&&P()},L=o=>{const n=u.value.id,r=l.sidebars[n]||[],m=r.findIndex(g=>g.wa_id===o.wa_id);m!==-1?(r.splice(m,1),l.sidebars[n]=[o,...r]):l.sidebars[n]=[o,...r],p.value=l.sidebars[n].reduce((g,O)=>g+Number(O.unreaded||0),0)};let h=null;const T=()=>{const o=`wss://sockets-service.salchimonster.com/ws/salchimonster-${u.value.id}`;h=new WebSocket(o),h.onopen=()=>console.log("WebSocket conectado a",o),h.onerror=n=>console.error("WebSocket error",n),h.onclose=()=>setTimeout(T,5e3),h.onmessage=async n=>{const r=JSON.parse(n.data);r!=null&&r.user_id&&L(r)}};re(u,async o=>{I=0,E.value=!1,l.sidebars[o.id]=[],h&&h.close(),T(),await P(),A.value=!1,setTimeout(()=>{A.value=!0},0)}),Y(async()=>{var o;await P(),(o=M.value)==null||o.addEventListener("scroll",W),T()}),H(()=>{var o;(o=M.value)==null||o.removeEventListener("scroll",W),h&&h.close()});const A=d(!0),J=o=>{$.value=o,A.value=!1,setTimeout(()=>{A.value=!0},0)};return(o,n)=>{var i;const r=D("Dropdown"),m=D("Button"),g=D("InputText"),O=D("IconField"),a=D("RouterLink"),s=D("ProgressSpinner");return c(),y("div",be,[e("div",xe,[f(r,{modelValue:u.value,"onUpdate:modelValue":n[0]||(n[0]=t=>u.value=t),options:F,optionLabel:"name",style:{"background-color":"#ffffff20",border:"none",color:"white",outline:"none","box-shadow":"none"}},{option:_(t=>[e("div",we,[e("img",{src:t.option.img,alt:"Logo",style:{width:"24px",height:"24px","margin-right":"8px","object-fit":"contain"}},null,8,ke),e("span",null,[e("b",null,b(t.option.name),1)])])]),value:_(t=>[e("div",Se,[t.value?(c(),y("img",{key:0,src:t.value.img,alt:"Logo",style:{width:"24px",height:"24px","margin-right":"8px","object-fit":"contain"}},null,8,$e)):V("",!0),e("span",Ee,b(t.value?t.value.name:"Selecciona"),1)])]),_:1},8,["modelValue"]),e("div",Ce,[f(m,{class:"options",text:""},{default:_(()=>[Te]),_:1}),e("div",Le,[f(m,{class:"options",text:"",style:{opacity:".5"}},{default:_(()=>[Ue]),_:1}),e("div",je,[e("span",De,b(p.value),1)])])])]),e("div",Ie,[f(O,{style:{display:"flex"}},{default:_(()=>[f(g,{style:{color:"white"},class:"search",placeholder:"Buscar..."})]),_:1})]),e("div",Re,[(c(!0),y(se,null,oe(S.value,(t,v)=>(c(),U(m,{style:Q([{height:"2.3rem","border-radius":".3rem",padding:".5rem"},t.label===$.value.label?{backgroundColor:t.bg,color:"#fff"}:{backgroundColor:"#ffffff20",color:t.bg}]),text:"",key:v,onClick:()=>J(t),class:"status",label:t.label},null,8,["onClick","label","style"]))),128))]),e("div",{class:Z(["",A.value?"chats active-new":"chats"]),ref_key:"chatsContainer",ref:M,onScroll:W},[(c(!0),y(se,null,oe(((i=w(l).sidebars[u.value.id])==null?void 0:i.filter(t=>t.clasification==$.value.label||$.value.label=="TODO"))||[],(t,v)=>(c(),U(a,{"active-class":"active",key:v,to:`/chat/chats/messages/${u.value.id}/${t.wa_id}/${t.nombre}/${t.color}?expirado=${t.expirado}&?expira-en?=${t.tiempo_para_expirar}`},{default:_(()=>[e("div",{class:"chat",onClick:()=>w(l).current_user=t},[e("div",Ne,[e("div",{style:Q([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${t.color}`])},b(K(t.nombre)),5)]),e("div",Ae,b(t.nombre),1),t.tiempo_para_expirar||!t.expirado?(c(),y("div",ze," Expira en "+b(t.tiempo_para_expirar),1)):(c(),y("div",Fe," Expirado ")),e("span",Me,b(t.mensaje_truncado),1),e("span",Ve,b(t.abreviatura||t.fecha_ultimo_mensaje),1),e("div",Be,[t.unreaded>0?(c(),y("div",Pe,[e("span",We,b(t.unreaded),1)])):V("",!0),qe])],8,Oe)]),_:2},1032,["to"]))),128)),R.value?(c(),y("div",Ke,[(c(),U(s,{key:0,style:{width:"50px",height:"50px"},strokeWidth:"8",fill:"transparent",animationDuration:".3s","aria-label":"Custom ProgressSpinner"}))])):V("",!0),E.value?(c(),y("div",Je,"No hay más chats.")):V("",!0)],34)])}}},ne=ee(He,[["__scopeId","data-v-c1a5efb7"]]),z=k=>(le("data-v-63f3e143"),k=k(),ce(),k),Xe={class:"main-container"},Ge={class:"top-bar",style:{"border-radius":".5rem",gap:"1rem"}},Qe={class:"top-bar-left"},Ye={style:{height:"3rem",width:"3rem",display:"flex","align-items":"center"}},Ze={class:"top-bar-info"},et={style:{"text-transform":"capitalize",margin:"0"}},tt={style:{display:"flex","align-items":"center",gap:"1rem"}},at=z(()=>e("i",{class:"pi pi-search text-2xl text-white"},null,-1)),st=z(()=>e("i",{class:"pi pi-bars text-2xl text-white"},null,-1)),ot={style:{height:"100%",overflow:"auto"}},it={key:1,style:{display:"flex","justify-content":"center","align-items":"center",height:"100%"}},nt=z(()=>e("h2",{style:{color:"white","font-size":"3rem",opacity:".5"}},"Selecciona un chat...",-1)),rt=[nt],lt={class:"chat-bar",tabindex:"0"},ct={class:"message-area"},dt=z(()=>e("i",{class:"fas fa-laugh-wink emoji-picker"},null,-1)),ut=["onKeydown"],pt=["src"],mt=z(()=>e("i",{class:"pi pi-trash text-2xl p-0"},null,-1)),_t={style:{position:"relative",transition:".2s"}},ft=z(()=>e("i",{class:"pi pi-send text-2xl text-white"},null,-1)),ht=z(()=>e("i",{class:"pi pi-send text-2xl text-white"},null,-1)),gt=ue({__name:"Main",setup(k){const B=a=>{a.target.closest(".emoji-picker")||(u.value=!1)};Y(()=>{document.addEventListener("click",B)}),H(()=>{document.removeEventListener("click",B)});const l=pe(),F=me(),u=d(!1),S=d(""),$=d(!1),p=d(null),I=d(!1),R=d(!0),E=_e(()=>{var a,s;return R.value&&(((a=l.query)==null?void 0:a.expirado)==="true"||((s=l.query)==null?void 0:s.expirado)===!0)}),M=a=>{R.value=a};re(E,a=>{S.value=a?"Conversación expirada":""},{immediate:!0});const K={"SIN DATOS":{bg:"#7f8c8d",icon:"fa-circle-question"},PREOCUPANTE:{bg:"#e74c3c",icon:"fa-triangle-exclamation"},CASUAL:{bg:"#e67e22",icon:"fa-person-walking"},FRECUENTE:{bg:"#27ae60",icon:"fa-repeat"},TOP:{bg:"#2980b9",icon:"fa-ranking-star"},ESTRELLA:{bg:"#8e44ad",icon:"fa-star"}},C=de();d([{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"},{id:7,name:"Distrimoster",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"}]);const P=(a="")=>{const s=a.trim().split(" ");return(Array.from(s[0]||"")[0]||"")+(s[1]?Array.from(s[1])[0]:"")},W=a=>{S.value+=a.i,u.value=!1};let L=null,h=[],T=null;const A=async()=>{if($.value&&L){L.stop();return}try{T=await navigator.mediaDevices.getUserMedia({audio:!0});const a=MediaRecorder.isTypeSupported("audio/ogg;codecs=opus")?"audio/ogg;codecs=opus":"audio/webm;codecs=opus";L=new MediaRecorder(T,{mimeType:a}),L.ondataavailable=s=>s.data.size&&h.push(s.data),L.onstop=()=>{const s=new Blob(h,{type:a.split(";")[0]});h=[],T.getTracks().forEach(t=>t.stop());const i=a.startsWith("audio/ogg")?"ogg":"webm";p.value={file:new File([s],`audio_${Date.now()}.${i}`,{type:s.type}),url:URL.createObjectURL(s)},$.value=!1},L.start(),$.value=!0}catch(a){console.error("No se pudo abrir el micrófono:",a.name,a.message),$.value=!1,T&&T.getTracks().forEach(s=>s.stop())}},J=()=>{p.value&&URL.revokeObjectURL(p.value.url),p.value=null};H(()=>{L&&$.value&&L.stop(),T&&T.getTracks().forEach(a=>a.stop())});const o={messaging_product:"whatsapp",employer_id:F.rawUserData.id,context_message_id:null},n=async(a,s=null)=>{var t,v;if(E.value||!a.trim())return;const i=new FormData;i.append("messaging_product","whatsapp"),i.append("employer_id",F.rawUserData.id),i.append("context_message_id",((t=s==null?void 0:s.message_data)==null?void 0:t.wa_id)||null),i.append("restaurant_id",(v=l.params.restaurant_id)==null?void 0:v.toString()),i.append("to",l.params.user_id),i.append("type","text"),i.append("text",JSON.stringify({body:a})),S.value="";try{C.sending=!0,await G.post(`${X}/webhook/send/text/`,i,!1)}catch(x){console.error("Error al enviar texto",x)}C.sending=!1},r=async()=>{var t;if(E.value||!p.value||I.value)return;const a=p.value;J(),I.value=!0;const s=new FormData;s.append("files",a.file);const i={...o,restaurant_id:(t=l.params.restaurant_id)==null?void 0:t.toString(),to:l.params.user_id,type:"audio",text:{body:""},file_index:0};s.append("payloads",JSON.stringify(i));try{await G.post(`${X}/webhook/send`,s,!1)}catch(v){console.error("Error al enviar audio",v)}I.value=!1},m=async a=>{var v;if(E.value||!(a!=null&&a.length))return;const s=new FormData,i={restaurant_id:(v=l.params.restaurant_id)==null?void 0:v.toString(),to:l.params.user_id,messaging_product:"whatsapp",employer_id:F.rawUserData.id,context_message_id:null},t=x=>{var ae;const{type:j,name:N}=x;if(j.startsWith("image/"))return"image";if(j.startsWith("audio/"))return"audio";if(j.startsWith("video/"))return"video";if(j==="application/pdf")return"document";const q=(ae=N.split(".").pop())==null?void 0:ae.toLowerCase();return["jpg","jpeg","png","webp"].includes(q)?"image":["mp3","wav","ogg","opus"].includes(q)?"audio":"document"};a.forEach((x,j)=>{s.append("files",x.file),s.append("payloads",JSON.stringify({...i,type:t(x.file),text:{body:x.caption||""},file_index:j}))}),C.sending=!0;try{await G.post(`${X}/webhook/send`,s,!1)}catch(x){console.error("Error al enviar archivos",x)}C.sending=!1},g=a=>{a.key==="Enter"&&(a.preventDefault(),S.value.trim()&&n(S.value))},O=a=>{a.key==="Enter"&&p.value&&(a.preventDefault(),r())};return Y(()=>window.addEventListener("keydown",O)),H(()=>window.removeEventListener("keydown",O)),(a,s)=>{var x,j;const i=D("Button"),t=D("RouterView"),v=D("Textarea");return c(),y("div",Xe,[e("div",Ge,[e("div",Qe,[e("div",Ye,[e("div",{class:"cliente-img",style:Q([`background-color:${w(l).params.color}`,{height:"100%",width:"3rem",color:"white","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"}])},b(P(w(l).params.user_name)),5)]),e("div",Ze,[e("strong",null,[e("h5",et,b((x=w(l).params.user_name)==null?void 0:x.substring(0,20)),1)]),e("div",null,[w(C).current_user.clasification?(c(),U(i,{key:0,style:Q({height:"2.3rem",display:"flex",alignItems:"center",textTransform:"capitalize",gap:"0.35rem",backgroundColor:((j=K[w(C).current_user.clasification])==null?void 0:j.bg)||"#7f8c8d",color:"#fff"})},{default:_(()=>{var N,q;return[e("i",{class:Z(["fa-solid",(N=K[w(C).current_user.clasification])==null?void 0:N.icon]),"aria-hidden":"true",style:{"font-size":"0.9rem"}},null,2),fe(" "+b((q=w(C).current_user.clasification)==null?void 0:q.toLowerCase())+" "+b(w(C).current_user.times_purchased)+" compras ",1)]}),_:1},8,["style"])):V("",!0)])])]),e("div",tt,[f(i,{icon:"pi pi-shopping-cart",class:"p-2",style:{color:"white","min-width":"max-content"},severity:"warning",label:"Ing. Ped"}),f(i,{text:"",class:"p-2"},{default:_(()=>[at]),_:1}),f(i,{text:"",class:"p-2"},{default:_(()=>[st]),_:1})])]),e("div",ot,[f(t,null,{default:_(()=>[w(l).params.user_id?(c(),U(ye,{key:0,send_function:m,send_text:n,change_expiration:M,ref:"Messages_element"},null,512)):(c(),y("div",it,rt))]),_:1})]),e("div",lt,[u.value?(c(),U(w(ve),{key:0,native:!0,style:{position:"absolute",bottom:"4rem","z-index":"1000"},onSelect:W,class:"emoji-picker"})):V("",!0),e("div",ct,[f(i,{text:"",style:{color:"yellow","font-size":"2rem"},onClick:s[0]||(s[0]=N=>u.value=!u.value)},{default:_(()=>[dt]),_:1}),p.value?(c(),y("div",{key:1,class:"audio-chip",onKeydown:he(ge(r,["prevent"]),["enter"])},[e("audio",{style:{width:"100%","min-width":"28rem","max-width":"42rem"},src:p.value.url,controls:""},null,8,pt),f(i,{text:"",class:"btn-audio-trash p-2",onClick:J},{default:_(()=>[mt]),_:1})],40,ut)):(c(),U(v,{key:0,modelValue:S.value,"onUpdate:modelValue":s[1]||(s[1]=N=>S.value=N),autoResize:"",class:"message",disabled:E.value,onKeydown:g},null,8,["modelValue","disabled"]))]),e("div",_t,[!p.value&&S.value.trim()===""?(c(),U(i,{key:0,text:"",style:{height:"100%"},onClick:A},{default:_(()=>[e("i",{class:Z($.value?"pi pi-stop text-2xl text-red-500":"pi pi-microphone text-2xl text-white")},null,2)]),_:1})):p.value?(c(),U(i,{key:1,disabled:I.value,text:"",onClick:r},{default:_(()=>[ft]),_:1},8,["disabled"])):(c(),U(i,{key:2,text:"",onClick:s[2]||(s[2]=N=>n(S.value))},{default:_(()=>[ht]),_:1}))])])])}}}),vt=ee(gt,[["__scopeId","data-v-63f3e143"]]);const yt={class:"chat-container"},bt={__name:"chats",setup(k){return(B,l)=>(c(),y("div",yt,[f(ne,{class:"sidebar-left",restaurant:{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"}}),f(vt),f(ne,{class:"sidebar-right",restaurant:{id:7,name:"Distrimoster",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"}})]))}},$t=ee(bt,[["__scopeId","data-v-da207d94"]]);export{$t as default};
