import{_ as Ae,l as Pe,j as r,G as O,Z as Oe,k as Fe,m as I,U as Be,D as q,r as Me,o as h,c as _,e as s,f as p,u as o,a as l,F as X,$ as E,h as U,t as f,i as k,g as He,a0 as C,a1 as ee,a2 as ce,a3 as me,a4 as F,a5 as J,a6 as Ye,b as pe,a7 as Ge,p as Ke,q as qe,J as R}from"./index-b159ff9c.js";import{u as Je}from"./chat-c4943053.js";import{r as ze,u as Qe}from"./xlsx-4cca7150.js";const m=B=>(Ke("data-v-e0124f31"),B=B(),qe(),B),We={style:{height:"100%","overflow-y":"auto"}},Ze={style:{display:"grid","grid-template-columns":"repeat(2, 1fr)","max-width":"max-content",gap:".5rem","align-items":"center"}},Xe=m(()=>l("h6",{class:"m-0 p-0"},[l("strong",null,"Id plantilla :")],-1)),el={class:"m-0 p-0"},ll=m(()=>l("h6",{class:"m-0 p-0"},[l("strong",null,"Nombre plantilla :")],-1)),al={class:"m-0 p-0"},tl=m(()=>l("h6",{class:"m-0 p-0"},[l("strong",null,"Estado :")],-1)),sl={class:"m-0 p-0"},ol=m(()=>l("h6",{class:"m-0 p-0"},[l("strong",null,"Categoria :")],-1)),nl={class:"m-0 p-0"},il=m(()=>l("h6",{class:"m-0 p-0"},[l("strong",null,"Mensaje :")],-1)),rl={class:"m-0",style:{"background-color":"#0a3744",padding:"1rem","border-radius":".5rem",color:"white"}},ul=m(()=>l("h6",{class:"m-0 p-0"},[l("strong",null,"Foto :")],-1)),dl=["src"],cl=m(()=>l("h5",{class:"mt-4 mb-1"},[l("strong",null,"Imagen para este envío")],-1)),ml={style:{display:"flex",gap:"1rem","align-items":"center","flex-wrap":"wrap"}},pl=["src"],vl=m(()=>l("h5",{class:"mt-4 mb-1"},[l("strong",null,"Archivo Excel con números")],-1)),hl={style:{display:"flex",gap:"1rem","align-items":"center","flex-wrap":"wrap"}},fl={key:0,class:"m-0"},gl=m(()=>l("h5",{class:"mt-4 mb-1"},[l("strong",null,"Rango de filas (máx. 800 mensajes)")],-1)),yl={style:{display:"flex",gap:"1rem","align-items":"center","flex-wrap":"wrap"}},_l={key:0,class:"m-0"},bl={key:0,style:{color:"red"}},xl=m(()=>l("h5",{class:"mt-4 mb-1"},[l("strong",null,"Vista previa"),U(),l("small",{class:"opacity-70"},"(Verás si cada número entra en el rango)")],-1)),wl={class:"p-4 templates-container",style:{margin:"auto","background-color":"white","border-radius":"1rem",transition:"all .3s ease","max-height":"90vh"}},El={style:{height:"100%"}},Vl={class:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",style:{"align-items":"center"}},Ul=m(()=>l("h2",{class:"text-2xl font-bold whitespace-nowrap m-0 p-0",style:{"min-width":"max-content"}},"Plantillas de WhatsApp",-1)),kl={class:"p-input-icon-left w-full md:w-80 my-3",style:{height:"100%"}},Cl=m(()=>l("i",{class:"pi pi-search"},null,-1)),Tl={key:0,style:{display:"flex","justify-content":"center"}},Sl=["src"],$l={class:"flex gap-2"},Il={style:{display:"flex",width:"100%","justify-content":"end","margin-top":"1rem"}},Nl={class:"space-y-4"},Ll={class:"md:grid-cols-2 gap-3"},Rl={class:"field"},Dl={key:0,style:{position:"relative",width:"300px","margin-top":".5rem"}},jl=["src"],Al={style:{display:"flex","justify-content":"center"}},Pl=["src"],Ol={class:"field"},Fl=m(()=>l("label",{class:"font-medium"},"Nombre",-1)),Bl={class:"field"},Ml=m(()=>l("label",{class:"font-medium"},"Categoría",-1)),Hl={class:"field"},Yl=m(()=>l("label",{class:"font-medium"},"Idioma",-1)),Gl={class:"font-medium"},Kl={class:"opacity-70"},ql={key:0,class:"",style:{display:"flex","flex-direction":"column",gap:"1rem","justify-content":"center"}},Jl=m(()=>l("h5",{class:"font-medium m-0 p-0 py-3"},"Ejemplos de variables",-1)),zl={class:"space-y-2"},Ql={class:"flex items-center my-4",style:{"align-items":"center",gap:"1rem"}},Wl=m(()=>l("h5",{class:"m-0"},"Botones",-1)),Zl={style:{display:"flex","flex-direction":"column",gap:"1rem","max-width":"100%",overflow:"hidden"}},Xl={__name:"templates",setup(B){const ve=Pe(),M=Je();function he(){D.value=null,W.value=""}const T=r("");async function fe(t){var n,e;const a=(n=t.target.files)==null?void 0:n[0];if(a)try{const i=new FormData;i.append("file",a);const u=await I.postFormData(`${R}/upload-photo-product`,i),d=(((e=u==null?void 0:u.content)==null?void 0:e.file_id)??u).toString();T.value=`${R}/files/images/${d}`}catch(i){console.error("✗ Error subiendo imagen:",i)}}r(""),r(!1),r(M.templates);const V=r({}),le=r(!1),H=r(""),N=r(!1),z=r(!1),Y=r(null),ae=r([]),b=r({name:"",category:"UTILITY",language:"es_ES"}),L=r(""),S=r([]),g=r({}),ge=r(null),x=r({}),Q=r([{}]);r({label:"PREOCUPANTE",bg:"#e74c3c",icon:"fa-triangle-exclamation"});const D=r(null),W=r(""),G=r([]);r([{label:"SIN DATOS",bg:"#7f8c8d",icon:"fa-circle-question"},{label:"PREOCUPANTE",bg:"#e74c3c",icon:"fa-triangle-exclamation"},{label:"CASUAL",bg:"#e67e22",icon:"fa-person-walking"},{label:"FRECUENTE",bg:"#27ae60",icon:"fa-repeat"},{label:"TOP",bg:"#2980b9",icon:"fa-ranking-star"},{label:"ESTRELLA",bg:"#8e44ad",icon:"fa-star"}]);const ye=O(()=>G.value.length===0?Q.value:Q.value.filter(t=>G.value.includes(t.clasification))),_e=Oe(),$=r(!1),be=[{label:"AUTHENTICATION",value:"AUTHENTICATION"},{label:"MARKETING",value:"MARKETING"},{label:"UTILITY",value:"UTILITY"}],xe=[{label:"Español (CO)",value:"es_CO"},{label:"Español (ES)",value:"es_ES"},{label:"English (US)",value:"en_US"}],we=[{label:"URL",value:"URL"},{label:"QUICK_REPLY",value:"QUICK_REPLY"}],Ee=O(()=>{if(!H.value)return M.templates;const t=H.value.toLowerCase();return M.templates.filter(a=>`${a.name} ${a.category}`.toLowerCase().includes(t))});Fe(async()=>{const t=await I.get(`${Be}/restaurants`);ae.value=t,x.value=t.find(a=>a.id==1),x.value});const j=O(()=>{if(!v.value.length)return[];const t=Math.max(1,Math.min(A.value,v.value.length)),a=Math.max(t,Math.min(P.value,v.value.length));return v.value.slice(t-1,a)}),Ve=O(()=>v.value.map((t,a)=>{const n=a>=A.value-1&&a<=P.value-1;return{index:a+1,number:t,selected:n}})),Ue=t=>t.selected?"selected-row":"",ke=t=>{V.value=t,$.value=!0};q($,()=>{G.value=[]});const K=r([]);q(L,t=>{const a=Array.from(new Set((t.match(/{{\s*([^{}\s]+)\s*}}/g)||[]).map(n=>n.replace(/{{|}}/g,"").trim())));K.value=a,g.value=Object.fromEntries(Object.entries(g.value).filter(([n])=>a.includes(n))),a.forEach(n=>{n in g.value||(g.value[n]="")})});async function te(){le.value=!0;try{M.templates=await I.get(`${R}/wabas/${x.value.waba_id}/templates/`)}finally{le.value=!1}}const Ce=async()=>{Q.value=await I.get(`${R}/wabas/${x.value.waba_id}/templates/users/${x.value.id}`)};q(x,async t=>{t&&(te(),G.value=[],await Ce())},{deep:!0});function Te(t){return{APPROVED:"success",PENDING:"warning",REJECTED:"danger"}[t]||"info"}function se(){b.value={name:"",category:"UTILITY",language:"es_ES"},L.value="",S.value=[],g.value={},Y.value=null}function Se(){se(),N.value=!0}const v=r([]),A=r(1),P=r(1);async function $e(t){var n;const a=(n=t.target.files)==null?void 0:n[0];if(a){try{const e=await a.arrayBuffer(),i=ze(e,{type:"array"}),u=i.Sheets[i.SheetNames[0]],y=Qe.sheet_to_json(u,{header:1}).map(c=>c==null?void 0:c[0]).filter(c=>c!=null).map(c=>String(c).replace(/\D/g,"")).filter(c=>/^\d{6,15}$/.test(c));v.value=y,A.value=1,P.value=Math.min(y.length,800)}catch(e){console.error("✗ Error leyendo Excel:",e)}t.target.value=""}}const oe=r({}),Ie=O(()=>ge.value?"Editar plantilla":"Nueva plantilla");function Ne(t){var i,u;Y.value=t.id,b.value={name:t.name,category:t.category,language:t.language};const a=t.components.find(d=>d.type==="BODY")||{text:""};L.value=a.text,g.value={},(i=a.example)!=null&&i.body_text_named_params?a.example.body_text_named_params.forEach(({param_name:d,example:y})=>{g.value[d]=y}):(u=a.example)!=null&&u.body_text&&a.example.body_text[0].forEach((d,y)=>{g.value[String(y+1)]=d});const n=t.components.find(d=>d.type==="BUTTONS")||{buttons:[]};S.value=n.buttons.map(d=>({type:d.type,text:d.text,url:d.url||""}));const e=t.components.find(d=>d.type==="HEADER")||{type:"HEADER",format:"IMAGE",example:{header_handle:[]}};oe.value=e==null?void 0:e.example.header_handle[0],N.value=!0}function Le(){S.value.push({type:"URL",text:"",url:""})}function Re(){const t=K.value;return t.length?t.every(n=>/^\d+$/.test(n))?{body_text:[t.sort((e,i)=>+e-+i).map(e=>g.value[e]||"")]}:{body_text_named_params:t.map(n=>({param_name:n,example:g.value[n]||""}))}:void 0}async function De(){if(b.value.name.trim()){z.value=!0;try{const t=Re(),a=[{type:"BODY",data:{text:L.value,...t?{example:t}:{}}}];S.value.length&&a.push({type:"BUTTONS",data:{buttons:S.value}});const n={...b.value,components:a},e=`${R}/wabas/${x.value.waba_id}/templates`;if(D.value){const i=new FormData;i.append("template_json",JSON.stringify(n)),i.append("header_image",D.value);const u=`${e}/with-header`;await I.postFormData(u,i,"Guardando…")}else{const i=Y.value?`${e}/${Y.value}`:e;await I.post(i,n,"Guardando…")}await te(),N.value=!1,se(),D.value=null,W.value=""}catch(t){console.error("✗ Error guardando plantilla:",t)}finally{z.value=!1}}}const Z=r(!1);async function je(){if(!V.value)return;if(!T.value){_e.require({message:"Debes seleccionar una imagen antes de difundir la plantilla.",header:"Imagen requerida",icon:"pi pi-exclamation-triangle",acceptLabel:"Ok",rejectVisible:!1});return}const t=ye.value.map(n=>n.wa_id).filter(n=>!!n&&n.trim().length>0);if(!t.length){console.warn("No hay destinatarios válidos para la difusión");return}const a={messaging_product:"whatsapp",employer_id:ve.rawUserData.id.toString(),restaurant_id:`${x.value.id}`,template:V.value,template_header_url:T.value,recipients:["573226892988"]};Z.value=!0;try{await I.post(`${R}/webhook/send/template/bulk/`,a,!1),console.log(`✅ Difusión iniciada para ${t.length} usuarios`),$.value=!1}catch(n){console.error("✗ Error en difusión masiva:",n)}finally{Z.value=!1}}return q($,t=>{t||(T.value="")}),(t,a)=>{const n=Me("InputNumber");return h(),_(X,null,[s(o(me),{visible:$.value,"onUpdate:visible":a[3]||(a[3]=e=>$.value=e),modal:"",header:"Difundir Plantilla",style:{width:"100vw","max-width":"80rem","background-color":"white"}},{footer:p(()=>[s(o(E),{label:"Cancelar",text:"",severity:"secondary",onClick:a[2]||(a[2]=e=>$.value=!1)}),s(o(E),{label:"Enviar",severity:"help",icon:"pi pi-broadcast",loading:Z.value,onClick:je,disabled:j.value.length===0||j.value.length>800||!T.value,autofocus:""},null,8,["loading","disabled"])]),default:p(()=>{var e,i,u,d,y,c,ne,ie,re,ue,de;return[l("div",We,[l("div",Ze,[Xe,U(),l("h6",el,f((e=V.value)==null?void 0:e.id),1),ll,U(),l("h6",al,f((i=V.value)==null?void 0:i.name),1),tl,U(),l("h6",sl,f((u=V.value)==null?void 0:u.status),1),ol,U(),l("h6",nl,f((d=V.value)==null?void 0:d.category),1),il,l("h6",rl,f((ne=(c=(y=V.value)==null?void 0:y.components)==null?void 0:c.find(w=>w.type=="BODY"))==null?void 0:ne.text),1),ul,l("img",{style:{height:"10rem",width:"10rem","aspect-ratio":"1 / 1","object-fit":"cover","border-radius":".5rem",border:"1px solid"},src:(de=(ue=(re=(ie=V.value)==null?void 0:ie.components)==null?void 0:re.find(w=>w.type=="HEADER"))==null?void 0:ue.example)==null?void 0:de.header_handle[0],alt:""},null,8,dl)]),cl,l("div",ml,[l("input",{type:"file",accept:"image/*",onChange:fe},null,32),T.value?(h(),_("img",{key:0,src:T.value,alt:"preview",style:{height:"8rem",width:"8rem","object-fit":"cover","border-radius":".5rem",border:"1px solid"}},null,8,pl)):k("",!0)]),vl,l("div",hl,[l("input",{type:"file",accept:".xls,.xlsx",onChange:$e},null,32),v.value.length?(h(),_("p",fl,"Cargados "+f(v.value.length)+" números",1)):k("",!0)]),gl,l("div",yl,[s(n,{modelValue:A.value,"onUpdate:modelValue":a[0]||(a[0]=w=>A.value=w),min:1,max:v.value.length,placeholder:"Fila inicial",disabled:!v.value.length},null,8,["modelValue","max","disabled"]),s(n,{modelValue:P.value,"onUpdate:modelValue":a[1]||(a[1]=w=>P.value=w),min:1,max:v.value.length,placeholder:"Fila final",disabled:!v.value.length},null,8,["modelValue","max","disabled"]),j.value.length?(h(),_("p",_l,"Se enviarán "+f(j.value.length)+" mensajes",1)):k("",!0)]),j.value.length>800?(h(),_("p",bl,"⚠️ Máximo permitido 800 mensajes. Ajusta el rango.")):k("",!0),xl,v.value.length?(h(),He(o(ce),{key:1,value:Ve.value,scrollable:"","scroll-height":"30vh",rows:10,paginator:"",paginatorTemplate:"FirstPageLink PrevPageLink PageLinks NextPageLink LastPageLink CurrentPageReport",currentPageReportTemplate:"Mostrando {first} a {last} de {totalRecords} números",rowClass:Ue},{default:p(()=>[s(o(C),{field:"index",header:"#",style:{width:"4rem"}}),s(o(C),{field:"number",header:"Número"}),s(o(C),{header:"Seleccionado"},{body:p(({data:w})=>[s(o(ee),{severity:w.selected?"success":"secondary"},{default:p(()=>[U(f(w.selected?"Sí":"No"),1)]),_:2},1032,["severity"])]),_:1})]),_:1},8,["value"])):k("",!0)])]}),_:1},8,["visible"]),l("div",wl,[l("div",El,[l("div",Vl,[Ul,l("span",kl,[Cl,s(o(F),{modelValue:H.value,"onUpdate:modelValue":a[4]||(a[4]=e=>H.value=e),modelModifiers:{trim:!0},placeholder:"Buscar…",class:"w-full"},null,8,["modelValue"])]),s(o(J),{modelValue:x.value,"onUpdate:modelValue":a[5]||(a[5]=e=>x.value=e),options:ae.value.filter(e=>e.exist),optionLabel:"name",placeholder:"Selecciona un restaurante",class:"w-full md:w-80 my-3"},null,8,["modelValue","options"])]),s(o(ce),{style:{"max-width":"80rem",width:"100%",overflow:"auto"},value:Ee.value,dataKey:"id",scrollable:"","scroll-height":"65vh",paginator:"",rows:10,responsiveLayout:"scroll",globalFilterFields:["name","category"],class:"shadow-md rounded-xl overflow-hidden"},{default:p(()=>[s(o(C),{class:"my-1 py-1",field:"name",header:"Nombre",bodyClass:"font-medium"}),s(o(C),{class:"my-1 py-1",header:"Texto"},{body:p(({data:e})=>{var i;return[l("span",null,f((i=e==null?void 0:e.components.find(u=>u.type=="BODY"))==null?void 0:i.text),1)]}),_:1}),s(o(C),{class:"my-1 py-1",header:"Texto"},{body:p(({data:e})=>{var i,u,d,y;return[(u=(i=e==null?void 0:e.components.find(c=>c.type=="HEADER"))==null?void 0:i.example)!=null&&u.header_handle[0]?(h(),_("div",Tl,[l("img",{style:{height:"10rem",width:"10rem","aspect-ratio":"1 / 1","object-fit":"cover","border-radius":".5rem",border:"1px solid"},src:(y=(d=e==null?void 0:e.components.find(c=>c.type=="HEADER"))==null?void 0:d.example)==null?void 0:y.header_handle[0]},null,8,Sl)])):k("",!0)]}),_:1}),s(o(C),{class:"my-1 py-1",header:"Estado"},{body:p(({data:e})=>[s(o(ee),{severity:Te(e.status)},{default:p(()=>[U(f(e.status),1)]),_:2},1032,["severity"])]),_:1}),s(o(C),{class:"my-1 py-1",headerStyle:"width:8rem",header:"Acciones"},{body:p(({data:e})=>[l("div",$l,[s(o(E),{icon:"pi pi-eye",severity:"warning",onClick:i=>Ne(e)},null,8,["onClick"]),s(o(E),{icon:"pi pi-sync",label:"Difundir",severity:"help",onClick:i=>ke(e)},null,8,["onClick"])])]),_:1})]),_:1},8,["value"]),l("div",Il,[s(o(E),{label:"Nueva plantilla",icon:"pi pi-plus",severity:"help",class:"w-full md:w-auto",onClick:Se})]),s(o(me),{visible:N.value,"onUpdate:visible":a[11]||(a[11]=e=>N.value=e),header:Ie.value,modal:"",class:"",style:{width:"90vw","max-width":"20rem","min-width":"40rem"}},{footer:p(()=>[s(o(E),{label:"cerrar",text:"",severity:"secondary",onClick:a[10]||(a[10]=e=>N.value=!1)}),s(o(E),{label:"Guardar",severity:"help",icon:"pi pi-check",onClick:De,loading:z.value,autofocus:""},null,8,["loading"])]),default:p(()=>[l("div",Nl,[l("div",Ll,[l("div",Rl,[D.value?(h(),_("div",Dl,[l("img",{src:W.value,style:{width:"100%",height:"100%","object-fit":"cover","border-radius":".5rem"}},null,8,jl),s(o(E),{icon:"pi pi-times",severity:"danger",size:"small",style:{position:"absolute",top:".1rem",right:".1rem"},onClick:he})])):k("",!0)]),l("div",Al,[l("img",{src:oe.value,style:{"max-width":"20rem",margin:"","aspect-ratio":"1 / 1","object-fit":"contain"},alt:""},null,8,Pl)]),l("div",Ol,[Fl,s(o(F),{modelValue:b.value.name,"onUpdate:modelValue":a[6]||(a[6]=e=>b.value.name=e),class:"w-full"},null,8,["modelValue"])]),l("div",Bl,[Ml,s(o(J),{modelValue:b.value.category,"onUpdate:modelValue":a[7]||(a[7]=e=>b.value.category=e),options:be,optionLabel:"label",optionValue:"value",class:"w-full"},null,8,["modelValue"])]),l("div",Hl,[Yl,s(o(J),{modelValue:b.value.language,"onUpdate:modelValue":a[8]||(a[8]=e=>b.value.language=e),options:xe,optionLabel:"label",optionValue:"value",class:"w-full"},null,8,["modelValue"])])]),l("div",null,[l("h6",Gl,[U("Cuerpo del mensaje "),l("small",Kl,"(usa "+f(t.param)+" o "+f(1)+")",1)]),s(o(Ye),{"auto-resize":"",modelValue:L.value,"onUpdate:modelValue":a[9]||(a[9]=e=>L.value=e),rows:"6",class:"w-full"},null,8,["modelValue"])]),K.value.length?(h(),_("div",ql,[Jl,(h(!0),_(X,null,pe(K.value,e=>(h(),_("div",{key:e,style:{"align-items":"center",display:"flex",gap:"1rem"},class:""},[s(o(ee),{severity:"info",style:{padding:"0 1rem",height:"2.8rem","min-width":"2.8rem"},class:"min-w-[5rem] text-center text-xl"},{default:p(()=>[U(f(e),1)]),_:2},1024),s(o(F),{modelValue:g.value[e],"onUpdate:modelValue":i=>g.value[e]=i,placeholder:`Ejemplo para ${e}`,class:"flex-1"},null,8,["modelValue","onUpdate:modelValue","placeholder"])]))),128))])):k("",!0),l("div",zl,[l("div",Ql,[Wl,s(o(E),{icon:"pi pi-plus",severity:"success",onClick:Le})]),l("div",Zl,[(h(!0),_(X,null,pe(S.value,(e,i)=>(h(),_("div",{key:i,class:"",style:{display:"grid","grid-template-columns":"10rem  1fr 1fr 3rem",gap:".5rem"}},[s(o(J),{modelValue:e.type,"onUpdate:modelValue":u=>e.type=u,options:we,optionLabel:"label",optionValue:"value"},null,8,["modelValue","onUpdate:modelValue"]),s(o(F),{modelValue:e.text,"onUpdate:modelValue":u=>e.text=u,placeholder:"Texto"},null,8,["modelValue","onUpdate:modelValue"]),s(o(F),{modelValue:e.url,"onUpdate:modelValue":u=>e.url=u,placeholder:"URL"},null,8,["modelValue","onUpdate:modelValue"]),s(o(E),{icon:"pi pi-times",severity:"danger",onClick:u=>S.value.splice(i,1)},null,8,["onClick"])]))),128))])])])]),_:1},8,["visible","header"]),s(o(Ge))])])],64)}}},ta=Ae(Xl,[["__scopeId","data-v-e0124f31"]]);export{ta as default};
