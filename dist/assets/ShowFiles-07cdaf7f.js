import{_ as we,G as ge,cm as be,a0 as $e,D as ke,H as Se,r as d,c as ae,q as Ce,I as Te,o as b,b as $,i as o,u as l,d as s,j as A,t as N,h as y,F as te,U as m,co as Ee,a9 as De,a1 as c,a2 as O,a4 as Ne,cp as se,k as J,a5 as H,a7 as Ve,a6 as V,e as Pe,p as Ue,m as Fe}from"./index-e0d1eab6.js";import{a as xe}from"./dropDownAux-d66e313b.js";import{u as le}from"./sendFileService-8d2d7e99.js";import{s as Ie}from"./siteService-77184632.js";const v=P=>(Ue("data-v-2375a71c"),P=P(),Fe(),P),Le={class:"col-12 p-0 mx-auto"},Re={class:"toolbar"},je={class:"left"},ze={class:"title"},Oe={class:"muted"},He={class:"right"},Be={class:"actions"},qe={class:"field"},Ae=v(()=>s("label",null,"Fecha de renovación",-1)),Je={key:0,class:"upload-zone"},Me=v(()=>s("i",{class:"pi pi-check mr-2"},null,-1)),Ge={class:"grid-buttons"},Ke={class:"field"},Ye=v(()=>s("label",null,"Tipo de documento",-1)),Qe={class:"field"},We=v(()=>s("label",null,"Fecha de renovación",-1)),Xe={key:0,class:"upload-zone"},Ze=v(()=>s("i",{class:"pi pi-check mr-2"},null,-1)),ea={class:"grid-buttons"},aa={class:"field"},ta=v(()=>s("label",null,"Nuevo tipo",-1)),sa={class:"row"},la=v(()=>s("h4",{class:"mt-4"},"Editar existentes",-1)),oa={class:"types-list"},ia={class:"field"},na=v(()=>s("label",null,"Nombre de la sede",-1)),ra={class:"field"},da=v(()=>s("label",null,"Dirección",-1)),ua={class:"field"},ca=v(()=>s("label",null,"Teléfono",-1)),pa={key:0,class:"preview"},ma=["src"],va={class:"row mt-3"},ya={__name:"ShowFiles",setup(P){const U=ge(),f=be(),M=$e(),n=ke(),F=Se(),G=d([]),k=d([]),p=d(null),S=d(null),_=d(null),h=d(null),x=d(!1),I=d(!1),B=d(!1),L=d(!1),C=d(""),w=d({site_name:"",site_address:"",site_phone:"",site_business_hours:""}),R=d(null),j=d(null),z=d(null),K=d(null),T=ae(()=>f.currentSite||{}),Y=ae(()=>{var a;return((a=f==null?void 0:f.currentSite)==null?void 0:a.site_id)||F.params.site_id}),Q=a=>{if(!a)return null;if(typeof a=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(a))return a;const e=new Date(a);if(isNaN(e))return null;const i=e.getFullYear(),u=String(e.getMonth()+1).padStart(2,"0"),g=String(e.getDate()).padStart(2,"0");return`${i}-${u}-${g}`},oe=a=>{if(!a||typeof a!="string")return"";const[e,i,u]=a.split("-");return!e||!i||!u?a:`${u}/${i}/${e}`},q=async()=>{try{const a=await fetch(`${m}/site-file-types`);if(!a.ok)throw new Error(`HTTP ${a.status}`);k.value=await a.json()}catch(a){console.error(a),n.add({severity:"error",summary:"Error",detail:"No se pudieron cargar los tipos de archivo",life:3e3})}},E=async()=>{try{const a=await fetch(`${m}/get-site-documents-info/${Y.value}`);if(!a.ok)return;G.value=await a.json()}catch(a){console.error("Error al obtener documentos:",a)}},ie=async a=>{const e=await fetch(`${m}/site-document/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()},ne=async(a,e)=>{const i={...a,renovation_date:e},u=await fetch(`${m}/site-document/${a.document_id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!u.ok)throw new Error(`HTTP ${u.status}`);return u.json()},re=async()=>{var a;if(!((a=C.value)!=null&&a.trim())){n.add({severity:"warn",summary:"Falta nombre",detail:"Ingresa un nombre para el tipo",life:2500});return}try{const e=await fetch(`${m}/site-file-type`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type_name:C.value.trim()})});if(!e.ok)throw new Error(`HTTP ${e.status}`);C.value="",await q(),n.add({severity:"success",summary:"Tipo creado",life:2500})}catch(e){console.error(e),n.add({severity:"error",summary:"Error",detail:"No se pudo crear el tipo",life:3e3})}},de=async a=>{try{const e=await fetch(`${m}/site-file-type/${a.type_id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({type_name:a.type_name})});if(!e.ok)throw new Error(`HTTP ${e.status}`);n.add({severity:"success",summary:"Tipo actualizado",life:2500})}catch(e){console.error(e),n.add({severity:"error",summary:"Error",detail:"No se pudo actualizar el tipo",life:3e3})}},ue=async a=>{M.require({message:"¿Eliminar este tipo de archivo?",header:"Confirmar",icon:"pi pi-exclamation-triangle",acceptLabel:"Eliminar",rejectLabel:"Cancelar",acceptClass:"p-button-danger",accept:async()=>{try{const e=await fetch(`${m}/site-file-type/${a}`,{method:"DELETE"});if(!e.ok)throw new Error(`HTTP ${e.status}`);k.value=k.value.filter(i=>i.type_id!==a),n.add({severity:"success",summary:"Eliminado",life:2500})}catch(e){console.error(e),n.add({severity:"error",summary:"Error",detail:"No se pudo eliminar",life:3e3}),q()}}})},ce=a=>{M.require({message:`¿Eliminar "${a.document_name}"?`,header:"Confirmar",icon:"pi pi-exclamation-triangle",acceptLabel:"Eliminar",rejectLabel:"Cancelar",acceptClass:"p-button-danger",accept:async()=>{try{if(!(await fetch(`${m}/site_document/${a.document_id}`,{method:"DELETE"})).ok)throw new Error("Error eliminando");await E(),n.add({severity:"success",summary:"Documento eliminado",life:2500})}catch(e){console.error(e),n.add({severity:"error",summary:"Error",detail:"No se pudo eliminar",life:3e3})}}})},W=a=>{var i;const e=(i=a.target.files)==null?void 0:i[0];e&&(p.value=e)},pe=a=>{S.value=a,h.value=null,p.value=null,x.value=!0},me=()=>{_.value=null,h.value=null,p.value=null,I.value=!0},X=()=>{x.value=!1,I.value=!1,p.value=null},ve=async()=>{var i,u;if(!((i=_.value)!=null&&i.type_name)){n.add({severity:"warn",summary:"Selecciona un tipo",life:2e3});return}const a=Q(h.value);if(!a){n.add({severity:"warn",summary:"Fecha de renovación requerida",life:2e3});return}if(!p.value){n.add({severity:"warn",summary:"Adjunta un archivo",life:2e3});return}const e={document_name:`${((u=T.value)==null?void 0:u.site_name)||""} ${_.value.type_name}`.trim(),document_type:_.value.type_name,renovation_date:a,site_id:Y.value};try{U.setLoading(!0,"Enviando");const g=await ie(e);await le(p.value,g.document_id,_.value.type_name),await E(),n.add({severity:"success",summary:"Documento cargado",life:2500}),X()}catch(g){console.error(g),n.add({severity:"error",summary:"Error",detail:"No se pudo cargar el documento",life:3e3})}finally{U.setLoading(!1)}},ye=async()=>{const a=Q(h.value);if(!a){n.add({severity:"warn",summary:"Fecha de renovación requerida",life:2e3});return}try{U.setLoading(!0,"Actualizando"),await ne(S.value,a),p.value&&await le(p.value,S.value.document_id,S.value.document_type),await E(),n.add({severity:"success",summary:"Documento actualizado",life:2500}),X()}catch(e){console.error(e),n.add({severity:"error",summary:"Error",detail:"No se pudo actualizar",life:3e3})}finally{U.setLoading(!1)}},fe=()=>{L.value=!0,w.value={site_name:"",site_address:"",site_phone:"",site_business_hours:""},R.value=null,j.value=null},_e=a=>{var i;const e=(i=a.target.files)==null?void 0:i[0];R.value=e||null,j.value=e?URL.createObjectURL(e):null},he=async()=>{try{const a=await fetch(`${m}/site`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(w.value)});if(!a.ok)throw new Error("Error al crear la sede");const{site_id:e}=await a.json();if(R.value){const i=new FormData;if(i.append("file",R.value),!(await fetch(`${m}/upload-product-image/site-${e}`,{method:"POST",body:i})).ok)throw new Error("Error subiendo imagen de sede")}L.value=!1,n.add({severity:"success",summary:"Sede creada",life:2500})}catch(a){console.error(a),n.add({severity:"error",summary:"Error",detail:"No se pudo crear la sede",life:3e3})}};return Ce(async()=>{var a;!((a=f==null?void 0:f.currentSite)!=null&&a.site_id)&&F.params.site_id&&(f.currentSite=await Ie.getSiteById(F.params.site_id)),await E(),await q()}),Te(()=>F.params.site_id,async()=>{await E()}),(a,e)=>{var i,u,g,Z,ee;return b(),$(te,null,[o(l(Ee)),o(l(De)),s("div",Le,[s("div",Re,[s("div",je,[s("h3",ze,[A(" Documentos — "),s("span",Oe,N(((i=T.value)==null?void 0:i.site_name)||"Sede"),1)])]),s("div",He,[o(l(c),{size:"small",class:"w-full md:w-auto",icon:"pi pi-plus",label:"Nuevo documento",onClick:me}),o(l(c),{size:"small",class:"w-full md:w-auto",icon:"pi pi-home",label:"Nueva sede",onClick:fe}),o(l(c),{size:"small",class:"w-full md:w-auto",icon:"pi pi-list",label:"Tipos de archivo",onClick:e[0]||(e[0]=t=>B.value=!0)})])]),o(l(Ne),{value:G.value,stripedRows:!0,paginator:!0,rows:10,dataKey:"document_id",paginatorTemplate:"FirstPageLink PrevPageLink PageLinks NextPageLink LastPageLink CurrentPageReport RowsPerPageDropdown",rowsPerPageOptions:[5,10,25],currentPageReportTemplate:"Mostrando {first} a {last} de {totalRecords}",responsiveLayout:"scroll",class:"mt-3"},{default:y(()=>[o(l(O),{field:"document_type",header:"Tipo",headerStyle:"min-width:12rem;"}),o(l(O),{header:"Nombre",headerStyle:"min-width:18rem;"},{body:y(({data:t})=>{var r;return[A(N((((r=T.value)==null?void 0:r.site_name)||"")+" "+t.document_type),1)]}),_:1}),o(l(O),{field:"renovation_date",header:"Renovación",headerStyle:"min-width:10rem;"},{body:y(({data:t})=>[A(N(oe(t.renovation_date)),1)]),_:1}),o(l(O),{header:"Acciones",frozen:"",alignFrozen:"right",headerStyle:"min-width:12rem;"},{body:y(({data:t})=>[s("div",Be,[o(l(c),{text:"",rounded:"","aria-label":"Descargar",icon:"pi pi-download",onClick:r=>l(xe)(t.document_id,t.document_type)},null,8,["onClick"]),o(l(c),{text:"",rounded:"","aria-label":"Editar",icon:"pi pi-pencil",onClick:r=>pe(t)},null,8,["onClick"]),o(l(c),{text:"",rounded:"",severity:"danger","aria-label":"Eliminar",icon:"pi pi-trash",onClick:r=>ce(t)},null,8,["onClick"])])]),_:1})]),_:1},8,["value"])]),o(l(H),{visible:x.value,"onUpdate:visible":e[3]||(e[3]=t=>x.value=t),modal:!0,style:{width:"500px"},header:`Renovar ${((u=S.value)==null?void 0:u.document_type)||""} — ${(((g=T.value)==null?void 0:g.site_name)||"").toUpperCase()}`},{default:y(()=>{var t;return[s("div",qe,[Ae,o(l(se),{modelValue:h.value,"onUpdate:modelValue":e[1]||(e[1]=r=>h.value=r),dateFormat:"dd/mm/yy",class:"w-full",manualInput:!1},null,8,["modelValue"])]),p.value?(b(),$("div",Je,[Me,s("span",null,N((t=p.value)==null?void 0:t.name)+" seleccionado",1)])):J("",!0),s("div",Ge,[o(l(c),{class:"w-full",severity:"help",label:"Seleccionar documento",icon:"pi pi-upload",onClick:e[2]||(e[2]=r=>{var D;return(D=z.value)==null?void 0:D.click()})}),o(l(c),{class:"w-full",severity:"success",label:"Guardar",icon:"pi pi-save",onClick:ye})]),s("input",{ref_key:"fileInputRef",ref:z,type:"file",onChange:W,style:{display:"none"}},null,544)]}),_:1},8,["visible","header"]),o(l(H),{visible:I.value,"onUpdate:visible":e[7]||(e[7]=t=>I.value=t),modal:!0,style:{width:"500px"},header:`Cargar ${((Z=_.value)==null?void 0:Z.type_name)||"documento"} — ${(((ee=T.value)==null?void 0:ee.site_name)||"").toUpperCase()}`},{default:y(()=>{var t;return[s("div",Ke,[Ye,o(l(Ve),{modelValue:_.value,"onUpdate:modelValue":e[4]||(e[4]=r=>_.value=r),options:k.value,optionLabel:"type_name",placeholder:"Selecciona un tipo",class:"w-full"},null,8,["modelValue","options"])]),s("div",Qe,[We,o(l(se),{modelValue:h.value,"onUpdate:modelValue":e[5]||(e[5]=r=>h.value=r),dateFormat:"dd/mm/yy",class:"w-full",manualInput:!1},null,8,["modelValue"])]),p.value?(b(),$("div",Xe,[Ze,s("span",null,N((t=p.value)==null?void 0:t.name)+" seleccionado",1)])):J("",!0),s("div",ea,[o(l(c),{class:"w-full",severity:"help",label:"Seleccionar documento",icon:"pi pi-upload",onClick:e[6]||(e[6]=r=>{var D;return(D=z.value)==null?void 0:D.click()})}),o(l(c),{class:"w-full",severity:"success",label:"Enviar",icon:"pi pi-send",onClick:ve})]),s("input",{ref_key:"fileInputRef",ref:z,type:"file",onChange:W,style:{display:"none"}},null,544)]}),_:1},8,["visible","header"]),o(l(H),{visible:B.value,"onUpdate:visible":e[9]||(e[9]=t=>B.value=t),modal:!0,style:{width:"520px"},header:"Tipos de archivo"},{default:y(()=>[s("div",aa,[ta,s("div",sa,[o(l(V),{class:"flex-1",modelValue:C.value,"onUpdate:modelValue":e[8]||(e[8]=t=>C.value=t),placeholder:"Ej: Certificado sanitario"},null,8,["modelValue"]),o(l(c),{label:"Agregar",icon:"pi pi-plus",onClick:re})])]),la,s("div",oa,[(b(!0),$(te,null,Pe(k.value,t=>(b(),$("div",{class:"type-item",key:t.type_id},[o(l(V),{class:"flex-1",modelValue:t.type_name,"onUpdate:modelValue":r=>t.type_name=r,onBlur:r=>de(t)},null,8,["modelValue","onUpdate:modelValue","onBlur"]),o(l(c),{rounded:"",text:"",severity:"danger",icon:"pi pi-trash",onClick:r=>ue(t.type_id)},null,8,["onClick"])]))),128))])]),_:1},8,["visible"]),o(l(H),{visible:L.value,"onUpdate:visible":e[14]||(e[14]=t=>L.value=t),modal:!0,style:{width:"520px"},header:"Nueva sede"},{footer:y(()=>[o(l(c),{label:"Crear sede",icon:"pi pi-check",onClick:he})]),default:y(()=>[s("div",ia,[na,o(l(V),{class:"w-full",modelValue:w.value.site_name,"onUpdate:modelValue":e[10]||(e[10]=t=>w.value.site_name=t)},null,8,["modelValue"])]),s("div",ra,[da,o(l(V),{class:"w-full",modelValue:w.value.site_address,"onUpdate:modelValue":e[11]||(e[11]=t=>w.value.site_address=t)},null,8,["modelValue"])]),s("div",ua,[ca,o(l(V),{class:"w-full",modelValue:w.value.site_phone,"onUpdate:modelValue":e[12]||(e[12]=t=>w.value.site_phone=t)},null,8,["modelValue"])]),j.value?(b(),$("div",pa,[s("img",{src:j.value,alt:"Vista previa"},null,8,ma)])):J("",!0),s("div",va,[o(l(c),{class:"w-full",icon:"pi pi-camera",label:"Cargar imagen",onClick:e[13]||(e[13]=t=>{var r;return(r=K.value)==null?void 0:r.click()})}),s("input",{ref_key:"imageInputRef",ref:K,type:"file",onChange:_e,style:{display:"none"}},null,544)])]),_:1},8,["visible"])],64)}}},ga=we(ya,[["__scopeId","data-v-2375a71c"]]);export{ga as default};
