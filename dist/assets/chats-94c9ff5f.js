import{H as Me,h,D as ue,G as Ee,i as me,I as pe,j as U,J as A,g as I,o as u,c as T,a as e,n,u as o,F as ye,r as be,d as D,e as x,t as _,f as v,b as fe,k as L,p as Pe,m as Be,K as Re,_ as Ce,C as Je,l as He,U as qe,q as Se,L as Ge,M as Ze}from"./index-281a46b6.js";import{u as Fe}from"./chat-a8dc5bd4.js";import{c as Te,P as Xe}from"./Messages.vue_vue_type_style_index_0_scoped_09e7a26a_lang-278ca561.js";/* empty css                                                             */import Ye from"./Messages-c3f83d8a.js";const xe=z=>(Pe("data-v-b37c7a63"),z=z(),Be(),z),Qe={class:"sidebar-container",style:{position:"relative"}},et={class:"header"},tt=xe(()=>e("strong",null," Notificaciones ",-1)),at=[tt],st=["onClick"],ot={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},it={style:{display:"flex","flex-direction":"column",width:"100%"}},rt=xe(()=>e("h3",null,[e("b",null," Buscar un usuario")],-1)),nt=["onClick"],lt={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},ct={style:{"grid-area":"check",display:"flex","justify-content":"end",gap:".5rem"}},dt={key:0,style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold"}},ut={style:{color:"white"}},mt=xe(()=>e("i",{style:{color:"greenyellow"},class:"fa-solid fa-check-double"},null,-1)),pt={key:2,style:{"text-align":"center",padding:".5rem",color:"#ffffff80"}},ft={class:"flex align-items-center"},_t=["src"],ht={class:"flex align-items-center"},vt=["src"],gt={style:{display:"flex",gap:"1rem"}},yt={style:{color:"white"}},bt={class:"statuses"},xt=["onClick"],wt={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},kt={style:{"grid-area":"check",display:"flex","justify-content":"end",gap:".5rem"}},$t={key:0,style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold"}},St={style:{color:"white"}},Et=xe(()=>e("i",{style:{color:"greenyellow"},class:"fa-solid fa-check-double"},null,-1)),Ct={key:1,style:{"text-align":"center",padding:".5rem",color:"#ffffff80"}},Oe=100,Ae=1e4,ze=20,Tt=1e3,Lt=Me({__name:"Sidebar",props:{restaurant:Object},setup(z){const $=h(!1),H=h(!1),ie=h(""),re=h(""),Q=h(!1);let ee=null;ue(re,t=>{Q.value=!0,ee&&clearTimeout(ee),ee=setTimeout(()=>{ie.value=t,Q.value=!1},1e3)});const F=h(!1),f=h(100),R=h(0),q=t=>{t.target.closest(".notifications")||($.value=!1)},V=Ee(()=>{var t;return(t=k.sidebars[p.value.id])==null?void 0:t.filter(a=>C.value.label==="TODO"?!0:C.value.label==="SIN LEER"?a.unreaded>0:C.value.label==="LEIDOS"?a.unreaded==0:a.clasification===C.value.label).slice(R.value,f.value)}),W=Ee(()=>{var t;return(t=k.sidebars[p.value.id])==null?void 0:t.filter(a=>C.value.label==="TODO"?!0:C.value.label==="SIN LEER"?a.unreaded>0:C.value.label==="LEIDOS"?a.unreaded==0:a.clasification===C.value.label)});me(()=>{document.addEventListener("click",q)}),pe(()=>{document.removeEventListener("click",q)});const E=h(null),te=async()=>{var w;const a=W.value.length-f.value;if(a<=0)return;const c=Math.min(Oe,a);f.value+=c,R.value+=c,await Re(),(w=E.value)==null||w.scrollTo({top:0,behavior:"auto"})},_e=async()=>{var a;if(R.value===0)return;const t=Math.min(Oe,R.value);f.value-=t,R.value-=t,await Re(),(a=E.value)==null||a.scrollTo({top:0,behavior:"auto"})},m=Te(),we=z,k=Fe(),N=[{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"},{id:7,name:"Distrimoster",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"}],p=h(we.restaurant||N[0]);h([{label:"Todos",textColor:"#4CAF50"},{label:"Sin leer",textColor:"#2196F3"},{label:"Favoritos",textColor:"#FFC107"},{label:"Preocupantes",textColor:"#F44336"},{label:"Top",textColor:"#9C27B0"}]);const he=async t=>{k.current_user=t,H.value=!1,$.value=!1;try{await U.post(`${A}/read-message/${t.user_id}/${p.value.id}`,!1)}catch(a){console.error("No se pudo marcar como leído",a)}t.unreaded=0},M=async t=>{var a;k.current_user=t.user_info,$.value=!1;try{await U.post(`${A}/read-message/${t.user_info.user_id}/${p.value.id}`,!1),await U.post(`${A}/view_notification/${t.id}`,!1),k.notifications[p.value.id]=await U.get(`${A}/notifications/${p.value.id}`);const c=(a=k.sidebars[p.value.id])==null?void 0:a.findIndex(w=>w.user_id==t.user_info.user_id);console.log(c),c!==-1&&(k.sidebars[p.value.id][c].unreaded=0)}catch(c){console.error("No se pudo marcar como leído",c)}},ne=[{label:"SIN LEER",bg:"#f39c12",icon:"fa-solid fa-envelope-open"},{label:"LEIDOS",bg:"#16a085",icon:"fa-solid fa-envelope-circle-check"},{label:"TODO",bg:"#34495e",icon:"fa-solid fa-inbox"},{label:"SIN DATOS",bg:"#95a5a6",icon:"fa-solid fa-circle-question"},{label:"PREOCUPANTE",bg:"#e74c3c",icon:"fa-solid fa-triangle-exclamation"},{label:"CASUAL",bg:"#e67e22",icon:"fa-solid fa-person-walking"},{label:"FRECUENTE",bg:"#27ae60",icon:"fa-solid fa-repeat"},{label:"TOP",bg:"#2980b9",icon:"fa-solid fa-ranking-star"},{label:"ESTRELLA",bg:"#8e44ad",icon:"fa-solid fa-star"}],C=h({label:"SIN LEER",bg:"#f39c12",icon:"fa-solid fa-envelope-open"});ue(C,t=>{f.value=100,R.value=0,E.value.scrollTo({top:0,behavior:"auto"})});const ve=h(0);let ae=0;const K=h(!1),P=h(!1),Z=(t="")=>{const a=t.trim().split(" ");return(Array.from(a[0]||"")[0]||"")+(a[1]?Array.from(a[1])[0]:"")};me(async()=>{k.notifications[p.value.id]=await U.get(`${A}/notifications/${p.value.id}`)});const ke=t=>t==="9+"?10:Number(t??0),$e=(t,a)=>{const c=k.sidebars[t]||[];a.forEach(w=>{const d=c.findIndex(y=>y.wa_id===w.wa_id);if(d===-1)c.push(w);else{const y=c[d],J=y.ultimo_mensaje_id!==w.ultimo_mensaje_id,G=y.color!==w.color,X=y.nombre!==w.nombre,Y=w.unreaded!=y.unreaded;(J||Y||G||X)&&(c[d]=w)}}),k.sidebars[t]=c,ve.value=c.reduce((w,d)=>w+ke(d.unreaded),0)},ge=t=>new Promise(a=>setTimeout(a,t)),le=async()=>{if(K.value||P.value)return;k.sidebars[p.value.id].length<100&&(K.value=!0);const t=`${A}/last-contact-messages/${p.value.id}?limit=${Ae}&offset=${ae}`,a=await U.get(t,!1);a.length<Ae&&(P.value=!0);for(let c=0;c<a.length;c+=ze){const w=a.slice(c,c+ze);$e(p.value.id,w),await ge(Tt),console.log(a.length-c,a.length),K.value=!1}ae+=a.length,K.value=!1},i=h(!1),r=()=>{const t=E.value;if(!t||K.value||P.value)return;t.scrollTop+t.clientHeight>=t.scrollHeight-120?i.value=!0:i.value=!1},l=t=>{const a=p.value.id,c=k.sidebars[a]||[],w=c.findIndex(d=>d.wa_id===t.wa_id);w!==-1?(c.splice(w,1),k.sidebars[a]=[t,...c]):k.sidebars[a]=[t,...c],ve.value=k.sidebars[a].reduce((d,y)=>d+Number(y.unreaded||0),0)};let g=null;const j=()=>{const t=`wss://sockets-service.salchimonster.com/ws/salchimonster-${p.value.id}`;g=new WebSocket(t),g.onopen=()=>console.log("WebSocket conectado a",t),g.onerror=a=>console.error("WebSocket error",a),g.onclose=()=>setTimeout(j,5e3),g.onmessage=async a=>{const c=JSON.parse(a.data);c!=null&&c.user_id&&l(c)}};let S=null;const O=()=>{const t=`wss://sockets-service.salchimonster.com/ws/salchimonster-notifications-${p.value.id}`;S=new WebSocket(t),S.onopen=()=>console.log("WebSocket conectado a",t),S.onerror=a=>console.error("WebSocket error",a),S.onclose=()=>setTimeout(O,5e3),S.onmessage=async a=>{k.notifications[p.value.id]=await U.get(`${A}/notifications/${p.value.id}`),F.value=!0,setTimeout(()=>{F.value=!1},1e3),JSON.parse(a.data)}};ue(p,async t=>{ae=0,P.value=!1,k.sidebars[t.id]=[],g&&g.close(),j(),O(),await le(),B.value=!1,setTimeout(()=>{B.value=!0},0)}),me(async()=>{var t;await le(),(t=E.value)==null||t.addEventListener("scroll",r),j(),O()}),pe(()=>{var t;(t=E.value)==null||t.removeEventListener("scroll",r),g&&g.close()});const B=h(!0),se=t=>{C.value=t,B.value=!1,setTimeout(()=>{B.value=!0},0)};return(t,a)=>{var X,Y,ce,oe,De;const c=I("RouterLink"),w=I("InputText"),d=I("ProgressSpinner"),y=I("Button"),J=I("Dialog"),G=I("Dropdown");return u(),T("div",Qe,[e("div",et,[e("div",{class:"notifications",style:n([$.value?{height:"calc(100vh - 8rem)",top:"4rem",boxShadow:"0 1rem 1rem #00000040"}:{height:0,overflow:"hidden",top:"-2rem"},{width:"100%","max-width":"90%","background-color":"#ffffff90","max-height":"90vh",overflow:"auto",position:"absolute","z-index":"9",transition:"all linear .2s","border-radius":".5rem",right:"0","backdrop-filter":"blur(5px)",display:"flex","flex-direction":"column"}])},[e("h4",{class:"my-3 px-3",style:n(o(m).current_chat_theme.text)},at,4),(u(!0),T(ye,null,be((Y=(X=o(k))==null?void 0:X.notifications)==null?void 0:Y[p.value.id],(s,b)=>(u(),D(c,{"active-class":o(m).current_chat_theme.name==="dark"?"active":"active-light",key:b,to:`/chat/chats/messages/${p.value.id}/${s.user_info.wa_id}/${(s.user_info.nombre||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^A-Za-z0-9_-]/g,"")||"n"}/${s.user_info.color}?expirado=${s.user_info.expirado}&expira-en=${s.user_info.tiempo_para_expirar}`},{default:x(()=>[e("div",{class:"chat2",onClick:()=>M(s),style:n(s.resolved?"background-color: #fff":"background-color: #b6f8ff59")},[e("div",ot,[e("div",{style:n([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${s.user_info.color||"black"}`])},_(Z(s.user_info.nombre)),5)]),e("div",{style:n([{"grid-area":"nombre"},`${o(m).current_chat_theme.text} ; ${s.resolved?"":"font-weight: bold;"}`])},_(s.description),5),e("span",{style:n([{"grid-area":"mensaje",color:"#ffffff80",opacity:".5"},o(m).current_chat_theme.text])},_(s.user_info.nombre.slice(0,20))+"... ",5),e("p",{class:"p-0 m-0",style:n([{"grid-area":"fecha","text-align":"end","min-width":"max-content"},o(m).current_chat_theme.text])},_(s.user_info.hora_ultimo_mensaje),5)],12,st)]),_:2},1032,["active-class","to"]))),128))],4),v(J,{closable:!1,header:"Buscar un usuario",visible:H.value,"onUpdate:visible":a[2]||(a[2]=s=>H.value=s),style:{width:"50rem"},modal:""},{header:x(()=>[e("div",it,[rt,v(w,{modelValue:re.value,"onUpdate:modelValue":a[0]||(a[0]=s=>re.value=s),style:{width:"100%"},placeholder:"Escriba el nombre o numero del usuario"},null,8,["modelValue"])])]),default:x(()=>{var s;return[e("div",{class:fe(["",B.value?"chats active-new":"chats"]),style:{height:"67vh"},ref_key:"chatsContainer",ref:E,onScroll:r},[Q.value?(u(),T("div",{key:0,style:n(`bottom:0;padding-bottom:1rem; background:linear-gradient(to bottom , transparent 3%, ${o(m).current_chat_theme.gradient});display:flex;  z-index: 100;width:100%; color: white`)},[(u(),D(d,{key:0,style:{width:"50px",height:"50px"},strokeWidth:"8",fill:"transparent",animationDuration:".3s","aria-label":"Custom ProgressSpinner"}))],4)):L("",!0),(u(!0),T(ye,null,be(((s=o(k).sidebars[p.value.id])==null?void 0:s.filter(b=>{var Ne,je,Ue,Ie;const de=((je=(Ne=ie.value)==null?void 0:Ne.toLowerCase())==null?void 0:je.trim())||"";if(de==="")return!1;const We=((Ue=b.nombre)==null?void 0:Ue.toLowerCase())||"",Ke=((Ie=b.wa_id)==null?void 0:Ie.toLowerCase())||"";return We.includes(de)||Ke.includes(de)}))||[],(b,de)=>(u(),D(c,{"active-class":o(m).current_chat_theme.name=="dark"?"active":"active-light",key:de,to:`/chat/chats/messages/${p.value.id}/${b.wa_id}/${b.nombre}/${b.color}?expirado=${b.expirado}&?expira-en?=${b.tiempo_para_expirar}`},{default:x(()=>[e("div",{class:"chat",onClick:()=>he(b)},[e("div",lt,[e("div",{style:n([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${b.color||"black"}`])},_(Z(b.nombre)),5)]),e("div",{style:n([{"grid-area":"nombre","text-transform":"capitalize","font-weight":"500"},o(m).current_chat_theme.text])},_(b.nombre),5),e("div",{style:n([{"grid-area":"numero","text-transform":"capitalize",opacity:".7"},o(m).current_chat_theme.text])},"+"+_(b.wa_id),5),e("span",{style:n([{"grid-area":"mensaje",color:"#ffffff80",opacity:".5"},o(m).current_chat_theme.text])},_(b.mensaje_truncado),5),e("span",{style:n([{"grid-area":"fecha","text-align":"end"},o(m).current_chat_theme.text])},_(b.abreviatura||b.fecha_ultimo_mensaje),5),e("span",{style:n([{"grid-area":"hora",color:"#ffffff80",opacity:".5","text-align":"end"},o(m).current_chat_theme.text])},_(b.hora_ultimo_mensaje),5),e("div",ct,[b.unreaded>0?(u(),T("div",dt,[e("span",ut,_(b.unreaded),1)])):L("",!0),mt])],8,nt)]),_:2},1032,["active-class","to"]))),128)),K.value?(u(),T("div",{key:1,style:n(`bottom:0;padding-bottom:1rem; background:linear-gradient(to bottom , transparent 3%, ${o(m).current_chat_theme.gradient});display:flex; position: absolute; z-index: 100;width:100%; color: white`)},[(u(),D(d,{key:0,style:{width:"50px",height:"50px"},strokeWidth:"8",fill:"transparent",animationDuration:".3s","aria-label":"Custom ProgressSpinner"}))],4)):L("",!0),P.value?(u(),T("div",pt,"No hay más chats.")):L("",!0)],34),v(y,{rounded:"",onClick:a[1]||(a[1]=b=>H.value=!1),icon:"pi pi-times  text-xl",style:{position:"absolute",top:"-1rem",right:"-1rem"},severity:"danger"})]}),_:1},8,["visible"]),v(G,{modelValue:p.value,"onUpdate:modelValue":a[3]||(a[3]=s=>p.value=s),options:N,optionLabel:"name",style:n([{"background-color":"#ffffff20",outline:"none","box-shadow":"none"},o(m).current_chat_theme.border])},{option:x(s=>[e("div",ft,[e("img",{src:s.option.img,alt:"Logo",style:{width:"24px",height:"24px","margin-right":"8px","object-fit":"contain"}},null,8,_t),e("span",null,[e("b",null,_(s.option.name),1)])])]),value:x(s=>[e("div",ht,[s.value?(u(),T("img",{key:0,src:s.value.img,alt:"Logo",style:{width:"24px",height:"24px","margin-right":"8px","object-fit":"contain"}},null,8,vt)):L("",!0),e("span",{style:n(o(m).current_chat_theme.text)},_(s.value?s.value.name:"Selecciona"),5)])]),_:1},8,["modelValue","style"]),e("div",gt,[v(y,{class:"options",text:""},{default:x(()=>[e("i",{class:"pi pi-search text-2xl",onClick:a[4]||(a[4]=s=>H.value=!0),style:n(o(m).current_chat_theme.text)},null,4)]),_:1}),e("div",{class:"notifications",style:{position:"relative",cursor:"pointer"},onClick:a[5]||(a[5]=s=>$.value=!$.value)},[v(y,{class:"options",text:"",style:{opacity:".5"}},{default:x(()=>[e("i",{class:"pi pi-bell text-2xl notifications",style:n(o(m).current_chat_theme.text)},null,4)]),_:1}),e("div",{class:fe(F.value?"load":""),style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",position:"absolute",top:"-1rem",right:"-.7rem",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold",padding:".8rem"}},[e("span",yt,_(((De=(oe=(ce=o(k))==null?void 0:ce.notifications)==null?void 0:oe[p.value.id])==null?void 0:De.length)||0),1)],2)]),v(y,{class:"options",text:""},{default:x(()=>[e("i",{class:"pi pi-bars text-2xl",style:n(o(m).current_chat_theme.text)},null,4)]),_:1})])]),e("div",bt,[(u(),T(ye,null,be(ne,(s,b)=>v(y,{style:n([{"border-radius":".3rem",padding:"0.3rem","text-transform":"capitalize"},s.label===C.value.label?{backgroundColor:s.bg,color:"#fff"}:{backgroundColor:"#ffffff20",color:s.bg}]),text:"",icon:s.icon,key:b,onClick:()=>se(s),class:"status",label:s.label.toLowerCase()},null,8,["icon","onClick","label","style"])),64))]),e("div",{class:fe(["",B.value?"chats active-new":"chats"]),ref_key:"chatsContainer",ref:E,onScroll:r},[(u(!0),T(ye,null,be(V.value,(s,b)=>(u(),D(c,{"active-class":o(m).current_chat_theme.name=="dark"?"active":"active-light",key:b,to:`/chat/chats/messages/${p.value.id}/${s.wa_id}/${s.nombre}/${s.color}?expirado=${s.expirado}&?expira-en?=${s.tiempo_para_expirar}`},{default:x(()=>[e("div",{class:"chat",onClick:()=>he(s)},[e("div",wt,[e("div",{style:n([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${s.color||"black"}`])},_(Z(s.nombre)),5)]),e("div",{style:n([{"grid-area":"nombre","text-transform":"capitalize","font-weight":"500"},o(m).current_chat_theme.text])},_(s.nombre),5),e("div",{style:n([{"grid-area":"numero","text-transform":"capitalize",opacity:".7"},o(m).current_chat_theme.text])},"+"+_(s.wa_id),5),e("span",{style:n([{"grid-area":"mensaje",color:"#ffffff80",opacity:".5"},o(m).current_chat_theme.text])},_(s.mensaje_truncado),5),e("span",{style:n([{"grid-area":"fecha","text-align":"end"},o(m).current_chat_theme.text])},_(s.abreviatura||s.fecha_ultimo_mensaje),5),e("span",{style:n([{"grid-area":"hora",color:"#ffffff80",opacity:".5","text-align":"end"},o(m).current_chat_theme.text])},_(s.hora_ultimo_mensaje),5),e("div",kt,[s.unreaded>0?(u(),T("div",$t,[e("span",St,_(s.unreaded),1)])):L("",!0),Et])],8,xt)]),_:2},1032,["active-class","to"]))),128)),K.value?(u(),T("div",{key:0,style:n(`bottom:0;padding-bottom:1rem; background:linear-gradient(to bottom , transparent 3%, ${o(m).current_chat_theme.gradient});display:flex; position: absolute; z-index: 100;width:100%; color: white`)},[(u(),D(d,{key:0,style:{width:"50px",height:"50px"},strokeWidth:"8",fill:"transparent",animationDuration:".3s","aria-label":"Custom ProgressSpinner"}))],4)):L("",!0),e("div",{style:n([{width:"100",display:"flex",gap:"1rem","justify-content":"center"},`bottom:0;padding-bottom:1rem; background:linear-gradient(to bottom , transparent 3%, ${o(m).current_chat_theme.gradient});display:flex; z-index: 100;width:100%; color: white`])},[R.value>0?(u(),D(y,{key:0,icon:"pi pi-step-backward-alt",severity:"help",label:"Volver 100 atrás",onClick:_e})):L("",!0),f.value<W.value.length?(u(),D(y,{key:1,iconPos:"right",icon:"pi pi-step-forward",severity:"help",label:"Cargar 100 más",onClick:te})):L("",!0)],4),P.value?(u(),T("div",Ct,"No hay más chats.")):L("",!0)],34)])}}}),Ve=Ce(Lt,[["__scopeId","data-v-b37c7a63"]]),Le=z=>(Pe("data-v-ed74fb8a"),z=z(),Be(),z),Dt={class:"top-bar-left"},Nt={style:{height:"3rem",width:"3rem",display:"flex","align-items":"center"}},jt={class:"top-bar-info"},Ut={style:{display:"flex","flex-direction":"column"}},It={style:{display:"flex","align-items":"center",gap:"1rem"}},Rt={style:{height:"100%",overflow:"auto"}},Ot={class:"message-area"},At=Le(()=>e("i",{class:"fas fa-laugh-wink emoji-picker"},null,-1)),zt=["onKeydown"],Vt=["src"],Mt={style:{position:"relative",transition:".2s"}},Pt=Le(()=>e("i",{class:"pi pi-send text-2xl"},null,-1)),Bt={style:{display:"flex",gap:"1rem"}},Ft=["src"],Wt={class:"flex gap-2"},Kt=Le(()=>e("div",{style:{width:"100%",display:"flex","justify-content":"end"}},null,-1)),Jt=Me({__name:"Main",setup(z){const $=Te();function H(i){return{APPROVED:"success",PENDING:"warning",REJECTED:"danger"}[i]||"info"}const ie=i=>{re(i),F.value=!1};async function re(i){const r=i,l=new FormData;l.append("messaging_product","whatsapp"),l.append("employer_id",R.rawUserData.id.toString()),l.append("context_message_id",""),l.append("restaurant_id",f.params.restaurant_id),l.append("to",f.params.user_id),l.append("type","template"),l.append("template",JSON.stringify(r));try{N.sending=!0,await U.post(`${A}/webhook/send/template/`,l,!1),console.log(`✅ Template enviado a ${to}`)}catch(g){console.error(`✗ Error al enviar template a ${to}`,g)}finally{N.sending=!1}}const Q=h([{}]),ee=i=>{i.target.closest(".emoji-picker")||(q.value=!1)};me(()=>{document.addEventListener("click",ee),le()}),pe(()=>{document.removeEventListener("click",ee)});const F=h(!1);h([]);const f=Je(),R=He(),q=h(!1),V=h(""),W=h(!1),E=h(null),te=h(!1),_e=h(!0),m=Ee(()=>{var i,r;return _e.value&&(((i=f.query)==null?void 0:i.expirado)==="true"||((r=f.query)==null?void 0:r.expirado)===!0)}),we=i=>{_e.value=i};ue(()=>{var i;return(i=f.params)==null?void 0:i.restaurant_id},()=>{le()}),ue(m,i=>{V.value=i?"Conversación expirada":""},{immediate:!0});const k={"SIN DATOS":{bg:"#7f8c8d",icon:"fa-circle-question"},PREOCUPANTE:{bg:"#e74c3c",icon:"fa-triangle-exclamation"},CASUAL:{bg:"#e67e22",icon:"fa-person-walking"},FRECUENTE:{bg:"#27ae60",icon:"fa-repeat"},TOP:{bg:"#2980b9",icon:"fa-ranking-star"},ESTRELLA:{bg:"#8e44ad",icon:"fa-star"}},N=Fe();h([{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"},{id:7,name:"Distrimoster",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"}]);const p=(i="")=>{const r=i.trim().split(" ");return(Array.from(r[0]||"")[0]||"")+(r[1]?Array.from(r[1])[0]:"")},he=i=>{V.value+=i.i,q.value=!1};let M=null,ne=[],C=null;const ve=async()=>{if(W.value&&M){M.stop();return}try{C=await navigator.mediaDevices.getUserMedia({audio:!0});const i=MediaRecorder.isTypeSupported("audio/ogg;codecs=opus")?"audio/ogg;codecs=opus":"audio/webm;codecs=opus";M=new MediaRecorder(C,{mimeType:i}),M.ondataavailable=r=>r.data.size&&ne.push(r.data),M.onstop=()=>{const r=new Blob(ne,{type:i.split(";")[0]});ne=[],C.getTracks().forEach(g=>g.stop());const l=i.startsWith("audio/ogg")?"ogg":"webm";E.value={file:new File([r],`audio_${Date.now()}.${l}`,{type:r.type}),url:URL.createObjectURL(r)},W.value=!1},M.start(),W.value=!0}catch(i){console.error("No se pudo abrir el micrófono:",i.name,i.message),W.value=!1,C&&C.getTracks().forEach(r=>r.stop())}},ae=()=>{E.value&&URL.revokeObjectURL(E.value.url),E.value=null};pe(()=>{M&&W.value&&M.stop(),C&&C.getTracks().forEach(i=>i.stop())});const K={messaging_product:"whatsapp",employer_id:R.rawUserData.id,context_message_id:null},P=async(i,r=null)=>{var g,j;if(m.value||!i.trim())return;const l=new FormData;l.append("messaging_product","whatsapp"),l.append("employer_id",R.rawUserData.id),l.append("context_message_id",((g=r==null?void 0:r.message_data)==null?void 0:g.wa_id)||null),l.append("restaurant_id",(j=f.params.restaurant_id)==null?void 0:j.toString()),l.append("to",f.params.user_id),l.append("type","text"),l.append("text",JSON.stringify({body:i})),V.value="";try{N.sending=!0,await U.post(`${A}/webhook/send/text/`,l,!1)}catch(S){console.error("Error al enviar texto",S)}N.sending=!1},Z=async()=>{var g;if(m.value||!E.value||te.value)return;const i=E.value;ae(),te.value=!0;const r=new FormData;r.append("files",i.file);const l={...K,restaurant_id:(g=f.params.restaurant_id)==null?void 0:g.toString(),to:f.params.user_id,type:"audio",text:{body:""},file_index:0};r.append("payloads",JSON.stringify(l));try{await U.post(`${A}/webhook/send`,r,!1)}catch(j){console.error("Error al enviar audio",j)}te.value=!1},ke=async i=>{var j;if(m.value||!(i!=null&&i.length))return;const r=new FormData,l={restaurant_id:(j=f.params.restaurant_id)==null?void 0:j.toString(),to:f.params.user_id,messaging_product:"whatsapp",employer_id:R.rawUserData.id,context_message_id:null},g=S=>{var t;const{type:O,name:B}=S;if(O.startsWith("image/"))return"image";if(O.startsWith("audio/"))return"audio";if(O.startsWith("video/"))return"video";if(O==="application/pdf")return"document";const se=(t=B.split(".").pop())==null?void 0:t.toLowerCase();return["jpg","jpeg","png","webp"].includes(se)?"image":["mp3","wav","ogg","opus"].includes(se)?"audio":"document"};i.forEach((S,O)=>{r.append("files",S.file),r.append("payloads",JSON.stringify({...l,type:g(S.file),text:{body:S.caption||""},file_index:O}))}),N.sending=!0;try{await U.post(`${A}/webhook/send`,r,!1)}catch(S){console.error("Error al enviar archivos",S)}N.sending=!1},$e=i=>{i.key==="Enter"&&(i.preventDefault(),V.value.trim()&&P(V.value))},ge=i=>{i.key==="Enter"&&E.value&&(i.preventDefault(),Z())};me(()=>window.addEventListener("keydown",ge)),pe(()=>window.removeEventListener("keydown",ge));async function le(){if(f.params.restaurant_id){const r=(await U.get(`${qe}/restaurants`)||[]).find(l=>{var g;return l.id==((g=f.params)==null?void 0:g.restaurant_id)})||null;r&&(Q.value=await U.get(`${A}/wabas/${r.waba_id}/templates/`))}}return(i,r)=>{var t,a,c,w;const l=I("Button"),g=I("RouterView"),j=I("Textarea"),S=I("Column"),O=I("Tag"),B=I("DataTable"),se=I("Dialog");return u(),T("div",{class:"main-container",style:n([o($).current_chat_theme.bg_image,{}])},[(t=o(f).params)!=null&&t.user_id?(u(),T("div",{key:0,tabindex:"0",class:"top-bar",style:n([{"border-radius":".5rem",gap:"1rem"},o($).current_chat_theme.bg_bars])},[e("div",Dt,[e("div",Nt,[e("div",{class:"cliente-img",style:n([`background-color:${o(f).params.color}`,{height:"100%",color:"white",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"}])},_(p(o(f).params.user_name)),5)]),e("div",jt,[e("div",Ut,[e("strong",null,[e("h5",{style:n([{"text-transform":"capitalize",margin:"0"},o($).current_chat_theme.text])},_((a=o(f).params.user_name)==null?void 0:a.substring(0,20)),5)]),e("span",null,"+"+_(o(f).params.user_id),1)]),e("div",null,[o(N).current_user.clasification?(u(),D(l,{key:0,style:n({height:"2.3rem",display:"flex",alignItems:"center",textTransform:"capitalize",gap:"0.35rem",backgroundColor:((c=k[o(N).current_user.clasification])==null?void 0:c.bg)||"#7f8c8d",color:"#fff"})},{default:x(()=>{var d,y;return[e("i",{class:fe(["fa-solid",(d=k[o(N).current_user.clasification])==null?void 0:d.icon]),"aria-hidden":"true",style:{"font-size":"0.9rem"}},null,2),Se(" "+_((y=o(N).current_user.clasification)==null?void 0:y.toLowerCase())+" "+_(o(N).current_user.times_purchased)+" compras ",1)]}),_:1},8,["style"])):L("",!0)])])]),e("div",It,[v(l,{icon:"pi pi-shopping-cart",class:"p-2",style:{color:"white","min-width":"max-content"},severity:"warning",label:"Ing. Ped"}),v(l,{text:"",class:"p-2"},{default:x(()=>[e("i",{style:n(o($).current_chat_theme.text),class:"pi pi-search text-2xl"},null,4)]),_:1}),v(l,{text:"",class:"p-2"},{default:x(()=>[e("i",{style:n(o($).current_chat_theme.text),class:"pi pi-bars text-2xl"},null,4)]),_:1})])],4)):L("",!0),e("div",Rt,[v(g,null,{default:x(()=>[o(f).params.user_id?(u(),D(Ye,{key:0,send_function:ke,send_text:P,change_expiration:we,ref:"Messages_element"},null,512)):L("",!0)]),_:1})]),(w=o(f).params)!=null&&w.user_id?(u(),T("div",{key:1,class:"chat-bar",tabindex:"0",style:n(o($).current_chat_theme.bg_bars)},[q.value?(u(),D(o(Xe),{key:0,native:!0,style:{position:"absolute",bottom:"4rem","z-index":"1000"},onSelect:he,class:"emoji-picker"})):L("",!0),e("div",Ot,[v(l,{text:"",style:{"font-size":"2rem","padding-left":"0"},onClick:r[0]||(r[0]=d=>q.value=!q.value)},{default:x(()=>[At]),_:1}),E.value?(u(),T("div",{key:1,class:"audio-chip",onKeydown:Ge(Ze(Z,["prevent"]),["enter"])},[e("audio",{style:{width:"100%","min-width":"28rem","max-width":"42rem"},src:E.value.url,controls:""},null,8,Vt),v(l,{text:"",class:"btn-audio-trash p-2",onClick:ae},{default:x(()=>[e("i",{style:n(o($).current_chat_theme.text),class:"pi pi-trash text-2xl p-0"},null,4)]),_:1})],40,zt)):(u(),D(j,{key:0,modelValue:V.value,"onUpdate:modelValue":r[1]||(r[1]=d=>V.value=d),autoResize:"",class:"message",disabled:m.value,onKeydown:$e,style:n(`${o($).current_chat_theme.text} ; ${o($).current_chat_theme.border} `)},null,8,["modelValue","disabled","style"]))]),e("div",Mt,[!E.value&&V.value.trim()===""?(u(),D(l,{key:0,text:"",style:{height:"100%"},onClick:ve},{default:x(()=>[e("i",{style:n(o($).current_chat_theme.text),class:fe(W.value?"pi pi-stop text-2xl text-red-500":"pi pi-microphone text-2xl ")},null,6)]),_:1})):E.value?(u(),D(l,{key:1,disabled:te.value,text:"",onClick:Z},{default:x(()=>[e("i",{style:n(o($).current_chat_theme.text),class:"pi pi-send text-2xl"},null,4)]),_:1},8,["disabled"])):(u(),D(l,{key:2,style:n(o($).current_chat_theme.text),text:"",onClick:r[2]||(r[2]=d=>P(V.value))},{default:x(()=>[Pt]),_:1},8,["style"]))]),e("div",Bt,[v(l,{severity:"danger",style:{},icon:"pi pi-clock",class:"p-2",onClick:r[3]||(r[3]=()=>F.value=!0)}),o(f).query.expirado?(u(),D(l,{key:0,icon:"pi pi-bolt",severity:"warning",style:{},class:"p-2",onClick:r[4]||(r[4]=()=>F.value=!0)})):L("",!0)])],4)):L("",!0),v(se,{visible:F.value,"onUpdate:visible":r[5]||(r[5]=d=>F.value=d),modal:"",header:"Envio de plantilla",style:{width:"90rem"}},{default:x(()=>[v(B,{value:Q.value,dataKey:"id",paginator:"",rows:10,responsiveLayout:"scroll",class:"shadow-md rounded-xl overflow-hidden"},{default:x(()=>[v(S,{class:"my-1 py-1",field:"name",header:"Nombre",bodyClass:"font-medium"}),v(S,{class:"my-1 py-1",header:"Texto"},{body:x(({data:d})=>{var y,J;return[Se(_((J=(y=d==null?void 0:d.components)==null?void 0:y.find(G=>G.type=="BODY"))==null?void 0:J.text),1)]}),_:1}),v(S,{class:"my-1 py-1",header:"Imagen"},{body:x(({data:d})=>{var y,J,G,X,Y,ce;return[(G=(J=(y=d==null?void 0:d.components)==null?void 0:y.find(oe=>oe.type=="HEADER"))==null?void 0:J.example)!=null&&G.header_handle[0]?(u(),T("img",{key:0,style:{height:"10rem",width:"10rem","aspect-ratio":"1 / 1","object-fit":"cover","border-radius":".5rem",border:"1px solid"},src:(ce=(Y=(X=d==null?void 0:d.components)==null?void 0:X.find(oe=>oe.type=="HEADER"))==null?void 0:Y.example)==null?void 0:ce.header_handle[0],alt:""},null,8,Ft)):L("",!0)]}),_:1}),v(S,{class:"my-1 py-1",header:"Estado"},{body:x(({data:d})=>[v(O,{severity:H(d.status)},{default:x(()=>[Se(_(d.status),1)]),_:2},1032,["severity"])]),_:1}),v(S,{class:"my-1 py-1",headerStyle:"width:8rem",header:"Acciones"},{body:x(({data:d})=>[e("div",Wt,[v(l,{icon:"pi pi-send",label:"Enviar",severity:"help",onClick:y=>ie(d)},null,8,["onClick"])])]),_:1})]),_:1},8,["value"]),Kt]),_:1},8,["visible"])],4)}}}),Ht=Ce(Jt,[["__scopeId","data-v-ed74fb8a"]]);const qt={__name:"chats",setup(z){const $=Te();return(H,ie)=>(u(),T("div",{class:"chat-container",style:n(o($).current_chat_theme.bg)},[v(Ve,{style:{"box-shadow":".5rem 0 1rem #00000010"},class:"sidebar-left",restaurant:{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"}}),v(Ht),v(Ve,{style:{"box-shadow":"-.5rem 0 1rem #00000010"},class:"sidebar-right",restaurant:{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"}})],4))}},ea=Ce(qt,[["__scopeId","data-v-ef52e81a"]]);export{ea as default};
