import{H as Te,j as _,D as ue,k as me,I as pe,m as N,J as R,r as U,o as m,c as $,a as e,n as l,u as n,F as he,b as ve,g as z,f as b,t as g,e as h,d as ge,i as D,p as je,q as De,_ as ke,C as Ne,l as Ue,G as Ie,U as Re,K as ze,L as Ve,h as Ce}from"./index-b159ff9c.js";import{u as Le}from"./chat-c4943053.js";import{c as $e,P as Be}from"./Messages.vue_vue_type_style_index_0_scoped_09e7a26a_lang-05e076f2.js";/* empty css                                                             */import Me from"./Messages-15702b7b.js";const ye=V=>(je("data-v-4791e879"),V=V(),De(),V),Oe={class:"sidebar-container",style:{position:"relative"}},Ae={class:"header"},Fe=ye(()=>e("strong",null," Notificaciones ",-1)),We=[Fe],Pe=["onClick"],Je={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},Ke={style:{display:"flex","flex-direction":"column",width:"100%"}},qe=ye(()=>e("h3",null,[e("b",null," Buscar un usuario")],-1)),He=["onClick"],Ge={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},Xe={style:{"grid-area":"check",display:"flex","justify-content":"end",gap:".5rem"}},Ye={key:0,style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold"}},Ze={style:{color:"white"}},Qe=ye(()=>e("i",{style:{color:"greenyellow"},class:"fa-solid fa-check-double"},null,-1)),et={key:1,style:{"text-align":"center",padding:".5rem",color:"#ffffff80"}},tt={class:"flex align-items-center"},at=["src"],st={class:"flex align-items-center"},ot=["src"],it={style:{display:"flex",gap:"1rem"}},nt={style:{color:"white"}},rt={class:"statuses"},lt={key:0,style:{display:"flex","justify-content":"end",margin:"0rem 0",gap:"1rem",padding:"1rem 1rem"}},ct=["onClick"],dt={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},ut={style:{"grid-area":"check",display:"flex","justify-content":"end",gap:".5rem"}},mt={key:0,style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold"}},pt={style:{color:"white"}},ft=ye(()=>e("i",{style:{color:"greenyellow"},class:"fa-solid fa-check-double"},null,-1)),_t={style:{display:"flex","justify-content":"center",margin:"2rem 0",gap:"1rem"}},ht={key:1,style:{"text-align":"center",padding:".5rem",color:"#ffffff80"}},Ee=100,vt=Te({__name:"Sidebar",props:{restaurant:Object},setup(V){const x=_(!1),F=_(!1),Y=_(""),oe=_(!1),Z=_([]);let Q=null;const L=_(100),v=_(0);ue(Y,s=>{Q&&clearTimeout(Q),Q=setTimeout(()=>{const i=s.trim().toLowerCase();if(!i){Z.value=[];return}const y=(u.sidebars[p.value.id]??[]).filter(S=>{const w=(S.nombre??"").toLowerCase(),f=(S.wa_id??"").toLowerCase();return w.includes(i)||f.includes(i)});Z.value=y,y.length===0&&alert("Buscando en la base de datos")},100)});const ee=()=>{L.value>=100&&(L.value-=100,v.value-=100)},W=s=>{s.target.closest(".notifications")||(x.value=!1)};me(()=>{document.addEventListener("click",W)}),pe(()=>{document.removeEventListener("click",W)});const d=$e(),P=V,u=Le(),H=[{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"},{id:7,name:"Distrimoster",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"},{id:8,name:"Pruebas",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"}],p=_(P.restaurant||H[0]);_([{label:"Todos",textColor:"#4CAF50"},{label:"Sin leer",textColor:"#2196F3"},{label:"Favoritos",textColor:"#FFC107"},{label:"Preocupantes",textColor:"#F44336"},{label:"Top",textColor:"#9C27B0"}]);const J=async s=>{u.current_user=s,F.value=!1,x.value=!1;try{await N.post(`${R}/read-message/${s.user_id}/${p.value.id}`,!1)}catch(i){console.error("No se pudo marcar como leído",i)}s.unreaded=0},xe=async s=>{var i;u.current_user=s.user_info,x.value=!1;try{await N.post(`${R}/read-message/${s.user_info.user_id}/${p.value.id}`,!1),await N.post(`${R}/view_notification/${s.id}`,!1),u.notifications[p.value.id]=await N.get(`${R}/notifications/${p.value.id}`);const c=(i=u.sidebars[p.value.id])==null?void 0:i.findIndex(y=>y.user_id==s.user_info.user_id);console.log(c),c!==-1&&(u.sidebars[p.value.id][c].unreaded=0)}catch(c){console.error("No se pudo marcar como leído",c)}},K=[{label:"SIN LEER",bg:"#f39c12",icon:"fa-solid fa-envelope-open"},{label:"LEIDOS",bg:"#16a085",icon:"fa-solid fa-envelope-circle-check"}],O=_({label:"SIN LEER",bg:"#f39c12",icon:"fa-solid fa-envelope-open"}),fe=_(0);let I=0;const E=_(!1),j=_(!1),q=_(null),te=(s="")=>{const i=s.trim().split(" ");return(Array.from(i[0]||"")[0]||"")+(i[1]?Array.from(i[1])[0]:"")};me(async()=>{u.notifications[p.value.id]=await N.get(`${R}/notifications/${p.value.id}`)});const we=s=>s==="9+"?10:Number(s??0),ie=(s,i)=>{const c=u.sidebars[s]||[];i.forEach(y=>{const S=c.findIndex(w=>w.wa_id===y.wa_id);if(S===-1)c.push(y);else{const w=c[S],f=w.ultimo_mensaje_id!==y.ultimo_mensaje_id,B=w.color!==y.color,M=w.nombre!==y.nombre,A=y.unreaded!=w.unreaded;(f||A||B||M)&&(c[S]=y)}}),u.sidebars[s]=c,fe.value=c.reduce((y,S)=>y+we(S.unreaded),0)},ne=_(!1),re=async()=>{if(E.value||j.value)return;E.value=!0;const s=`${R}/last-contact-messages/${p.value.id}?limit=${Ee}&offset=${I}&clasificacion=${O.value.label}`,i=await N.get(s,!1);i.length<Ee&&(j.value=!0),I+=i.length,ie(p.value.id,i),E.value=!1};let ae=_(!0);const G=async()=>{var c;const s=q.value;if(!s||E.value||j.value||!ae)return;if(s.scrollTop+s.clientHeight>=s.scrollHeight-100){if(ne.value=!0,L.value,ae.value)if(v.value+100>=((c=u.sidebars[p.value])==null?void 0:c.length)){L.value=1e3;return}else L.value+=100,ae.value=!1;setTimeout(()=>{ae.value=!0},1e3)}};ue(O,()=>{q.value.scrollTo({top:0}),L.value=100});const _e=s=>{const i=p.value.id,c=u.sidebars[i]||[],y=c.findIndex(S=>S.wa_id===s.wa_id);y!==-1?(c.splice(y,1),u.sidebars[i]=[s,...c]):u.sidebars[i]=[s,...c],fe.value=u.sidebars[i].reduce((S,w)=>S+Number(w.unreaded||0),0)};let a=null;const o=()=>{const s=`wss://sockets-service.salchimonster.com/ws/salchimonster-${p.value.id}`;a=new WebSocket(s),a.onopen=()=>console.log("WebSocket conectado a",s),a.onerror=i=>console.error("WebSocket error",i),a.onclose=()=>setTimeout(o,5e3),a.onmessage=async i=>{const c=JSON.parse(i.data);c!=null&&c.user_id&&_e(c)}};let r=null;const k=()=>{const s=`wss://sockets-service.salchimonster.com/ws/salchimonster-notifications-${p.value.id}`;r=new WebSocket(s),r.onopen=()=>console.log("WebSocket conectado a",s),r.onerror=i=>console.error("WebSocket error",i),r.onclose=()=>setTimeout(k,5e3),r.onmessage=async i=>{u.notifications[p.value.id]=await N.get(`${R}/notifications/${p.value.id}`),oe.value=!0,setTimeout(()=>{oe.value=!1},1e3),JSON.parse(i.data)}};ue(p,async s=>{I=0,j.value=!1,u.sidebars[s.id]=[],a&&a.close(),o(),k(),await re(),T.value=!1,setTimeout(()=>{T.value=!0},0)}),me(async()=>{var s;await re(),(s=q.value)==null||s.addEventListener("scroll",G),o(),k()}),pe(()=>{var s;(s=q.value)==null||s.removeEventListener("scroll",G),a&&a.close()});const T=_(!0),C=s=>{O.value=s,T.value=!1,setTimeout(()=>{T.value=!0},0)};return(s,i)=>{var M,A,le,ce,de,se,Se;const c=U("RouterLink"),y=U("InputText"),S=U("ProgressSpinner"),w=U("Button"),f=U("Dialog"),B=U("Dropdown");return m(),$("div",Oe,[e("div",Ae,[e("div",{class:"notifications",style:l([x.value?{height:"calc(100vh - 8rem)",top:"4rem",boxShadow:"0 1rem 1rem #00000040"}:{height:0,overflow:"hidden",top:"-2rem"},{width:"100%","max-width":"90%","background-color":"#ffffff90","max-height":"90vh",overflow:"auto",position:"absolute","z-index":"9",transition:"all linear .2s","border-radius":".5rem",right:"0","backdrop-filter":"blur(5px)",display:"flex","flex-direction":"column"}])},[e("h4",{class:"my-3 px-3",style:l(n(d).current_chat_theme.text)},We,4),(m(!0),$(he,null,ve((A=(M=n(u))==null?void 0:M.notifications)==null?void 0:A[p.value.id],(t,X)=>(m(),z(c,{"active-class":n(d).current_chat_theme.name==="dark"?"active":"active-light",key:X,to:`/chat/chats/messages/${p.value.id}/${t.user_info.wa_id}/${(t.user_info.nombre||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^A-Za-z0-9_-]/g,"")||"n"}/${t.user_info.color}?expirado=${t.user_info.expirado}&expira-en=${t.user_info.tiempo_para_expirar}`},{default:b(()=>[e("div",{class:"chat2",onClick:()=>xe(t),style:l(t.resolved?"background-color: #fff":"background-color: #b6f8ff59")},[e("div",Je,[e("div",{style:l([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${t.user_info.color||"black"}`])},g(te(t.user_info.nombre)),5)]),e("div",{style:l([{"grid-area":"nombre"},`${n(d).current_chat_theme.text} ; ${t.resolved?"":"font-weight: bold;"}`])},g(t.description),5),e("span",{style:l([{"grid-area":"mensaje",color:"#ffffff80",opacity:".5"},n(d).current_chat_theme.text])},g(t.user_info.nombre.slice(0,20))+"... ",5),e("p",{class:"p-0 m-0",style:l([{"grid-area":"fecha","text-align":"end","min-width":"max-content"},n(d).current_chat_theme.text])},g(t.user_info.hora_ultimo_mensaje),5)],12,Pe)]),_:2},1032,["active-class","to"]))),128))],4),h(f,{closable:!1,header:"Buscar un usuario",visible:F.value,"onUpdate:visible":i[2]||(i[2]=t=>F.value=t),style:{width:"50rem"},modal:""},{header:b(()=>[e("div",Ke,[qe,h(y,{modelValue:Y.value,"onUpdate:modelValue":i[0]||(i[0]=t=>Y.value=t),style:{width:"100%"},placeholder:"Escriba el nombre o numero del usuario"},null,8,["modelValue"])])]),default:b(()=>[e("div",{class:ge(["",T.value?"chats active-new":"chats"]),style:{height:"67vh"},ref_key:"chatsContainer",ref:q,onScroll:G},[(m(!0),$(he,null,ve(Z.value,(t,X)=>(m(),z(c,{"active-class":n(d).current_chat_theme.name=="dark"?"active":"active-light",key:X,to:`/chat/chats/messages/${p.value.id}/${t.wa_id}/${t.nombre}/${t.color}?expirado=${t.expirado}&?expira-en?=${t.tiempo_para_expirar}`},{default:b(()=>[e("div",{class:"chat",onClick:()=>J(t)},[e("div",Ge,[e("div",{style:l([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${t.color||"black"}`])},g(te(t.nombre)),5)]),e("div",{style:l([{"grid-area":"nombre","text-transform":"capitalize","font-weight":"500"},n(d).current_chat_theme.text])},g(t.nombre),5),e("div",{style:l([{"grid-area":"numero","text-transform":"capitalize",opacity:".7"},n(d).current_chat_theme.text])},"+"+g(t.wa_id),5),e("span",{style:l([{"grid-area":"mensaje",color:"#ffffff80",opacity:".5"},n(d).current_chat_theme.text])},g(t.mensaje_truncado),5),e("span",{style:l([{"grid-area":"fecha","text-align":"end"},n(d).current_chat_theme.text])},g(t.abreviatura||t.fecha_ultimo_mensaje),5),e("span",{style:l([{"grid-area":"hora",color:"#ffffff80",opacity:".5","text-align":"end"},n(d).current_chat_theme.text])},g(t.hora_ultimo_mensaje),5),e("div",Xe,[t.unreaded>0?(m(),$("div",Ye,[e("span",Ze,g(t.unreaded),1)])):D("",!0),Qe])],8,He)]),_:2},1032,["active-class","to"]))),128)),E.value?(m(),$("div",{key:0,style:l(`bottom:0;padding-bottom:1rem; background:linear-gradient(to bottom , transparent 3%, ${n(d).current_chat_theme.gradient});display:flex; position: absolute; z-index: 100;width:100%; color: white`)},[(m(),z(S,{key:0,style:{width:"50px",height:"50px"},strokeWidth:"8",fill:"transparent",animationDuration:".3s","aria-label":"Custom ProgressSpinner"}))],4)):D("",!0),j.value?(m(),$("div",et,"No hay más chats.")):D("",!0)],34),h(w,{rounded:"",onClick:i[1]||(i[1]=t=>F.value=!1),icon:"pi pi-times  text-xl",style:{position:"absolute",top:"-1rem",right:"-1rem"},severity:"danger"})]),_:1},8,["visible"]),h(B,{modelValue:p.value,"onUpdate:modelValue":i[3]||(i[3]=t=>p.value=t),options:H,optionLabel:"name",style:l([{"background-color":"#ffffff20",outline:"none","box-shadow":"none"},n(d).current_chat_theme.border])},{option:b(t=>[e("div",tt,[e("img",{src:t.option.img,alt:"Logo",style:{width:"24px",height:"24px","margin-right":"8px","object-fit":"contain"}},null,8,at),e("span",null,[e("b",null,g(t.option.name),1)])])]),value:b(t=>[e("div",st,[t.value?(m(),$("img",{key:0,src:t.value.img,alt:"Logo",style:{width:"24px",height:"24px","margin-right":"8px","object-fit":"contain"}},null,8,ot)):D("",!0),e("span",{style:l(n(d).current_chat_theme.text)},g(t.value?t.value.name:"Selecciona"),5)])]),_:1},8,["modelValue","style"]),e("div",it,[h(w,{class:"options",text:""},{default:b(()=>[e("i",{class:"pi pi-search text-2xl",onClick:i[4]||(i[4]=t=>F.value=!0),style:l(n(d).current_chat_theme.text)},null,4)]),_:1}),e("div",{class:"notifications",style:{position:"relative",cursor:"pointer"},onClick:i[5]||(i[5]=t=>x.value=!x.value)},[h(w,{class:"options",text:"",style:{opacity:".5"}},{default:b(()=>[e("i",{class:"pi pi-bell text-2xl notifications",style:l(n(d).current_chat_theme.text)},null,4)]),_:1}),e("div",{class:ge(oe.value?"load":""),style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",position:"absolute",top:"-1rem",right:"-.7rem",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold",padding:".8rem"}},[e("span",nt,g(((de=(ce=(le=n(u))==null?void 0:le.notifications)==null?void 0:ce[p.value.id])==null?void 0:de.length)||0),1)],2)]),h(w,{class:"options",text:""},{default:b(()=>[e("i",{class:"pi pi-bars text-2xl",style:l(n(d).current_chat_theme.text)},null,4)]),_:1})])]),e("div",rt,[(m(),$(he,null,ve(K,(t,X)=>h(w,{style:l([{"border-radius":".3rem",padding:"0.3rem","text-transform":"capitalize"},t.label===O.value.label?{backgroundColor:t.bg,color:"#fff"}:{backgroundColor:"#ffffff20",color:t.bg}]),text:"",icon:t.icon,key:X,onClick:()=>C(t),class:"status",label:t.label.toLowerCase()},null,8,["icon","onClick","label","style"])),64))]),v.value>0?(m(),$("div",lt,[h(w,{disabled:E.value,icon:E.value?"pi pi-spin pi-spinner":"pi pi-angle-left",onClick:ee,severity:"help",label:E.value?"cargando...":"atras"},null,8,["disabled","icon","label"])])):D("",!0),e("div",{class:ge(["",T.value?"chats active-new":"chats"]),ref_key:"chatsContainer",ref:q,onScroll:G},[(m(!0),$(he,null,ve(((se=n(u).sidebars[p.value.id])==null?void 0:se.filter(t=>{if(O.value.label==="TODO")return!0;if(O.value.label==="SIN LEER")return t.unreaded>0;if(O.value.label==="LEIDOS")return t.unreaded==0}).slice(v.value,L.value))||[],(t,X)=>(m(),z(c,{"active-class":n(d).current_chat_theme.name=="dark"?"active":"active-light",key:X,to:`/chat/chats/messages/${p.value.id}/${t.wa_id}/${t.nombre}/${t.color}?expirado=${t.expirado}&?expira-en?=${t.tiempo_para_expirar}`},{default:b(()=>[e("div",{class:"chat",onClick:()=>J(t)},[e("div",dt,[e("div",{style:l([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${t.color||"black"}`])},g(te(t.nombre)),5)]),e("div",{style:l([{"grid-area":"nombre","text-transform":"capitalize","font-weight":"500"},n(d).current_chat_theme.text])},g(t.nombre),5),e("div",{style:l([{"grid-area":"numero","text-transform":"capitalize",opacity:".7"},n(d).current_chat_theme.text])},"+"+g(t.wa_id),5),e("span",{style:l([{"grid-area":"mensaje",color:"#ffffff80",opacity:".5"},n(d).current_chat_theme.text])},g(t.mensaje_truncado),5),e("span",{style:l([{"grid-area":"fecha","text-align":"end"},n(d).current_chat_theme.text])},g(t.abreviatura||t.fecha_ultimo_mensaje),5),e("span",{style:l([{"grid-area":"hora",color:"#ffffff80",opacity:".5","text-align":"end"},n(d).current_chat_theme.text])},g(t.hora_ultimo_mensaje),5),e("div",ut,[t.unreaded>0?(m(),$("div",mt,[e("span",pt,g(t.unreaded),1)])):D("",!0),ft])],8,ct)]),_:2},1032,["active-class","to"]))),128)),E.value&&((Se=n(u).sidebars[p.value.id])==null?void 0:Se.length)<2?(m(),$("div",{key:0,style:l(`bottom:0;padding-bottom:1rem; background:linear-gradient(to bottom , transparent 3%, ${n(d).current_chat_theme.gradient});display:flex; position: absolute; z-index: 100;width:100%; color: white`)},[(m(),z(S,{key:0,style:{width:"50px",height:"50px"},strokeWidth:"8",fill:"transparent",animationDuration:".3s","aria-label":"Custom ProgressSpinner"}))],4)):D("",!0),e("div",_t,[h(w,{disabled:E.value,icon:E.value?"pi pi-spin pi-spinner":"",onClick:re,severity:"help",label:E.value?"cargando...":"Cargar mas"},null,8,["disabled","icon","label"])]),j.value?(m(),$("div",ht,"No hay más chats.")):D("",!0)],34)])}}}),gt=ke(vt,[["__scopeId","data-v-4791e879"]]),be=V=>(je("data-v-8589f3d5"),V=V(),De(),V),yt={class:"top-bar-left"},bt={style:{height:"3rem",width:"3rem",display:"flex","align-items":"center"}},xt={class:"top-bar-info"},wt={style:{display:"flex","flex-direction":"column"}},kt=be(()=>e("div",null,null,-1)),$t={style:{display:"flex","align-items":"center",gap:"1rem"}},St={style:{height:"100%",overflow:"auto"}},Ct={class:"message-area"},Et=be(()=>e("i",{class:"fas fa-laugh-wink emoji-picker"},null,-1)),Tt=["onKeydown"],jt=["src"],Dt={style:{position:"relative",transition:".2s"}},Lt=be(()=>e("i",{class:"pi pi-send text-2xl"},null,-1)),Nt={style:{display:"flex",gap:"1rem"}},Ut=["src"],It={class:"flex gap-2"},Rt=be(()=>e("div",{style:{width:"100%",display:"flex","justify-content":"end"}},null,-1)),zt=Te({__name:"Main",setup(V){const x=$e();function F(a){return{APPROVED:"success",PENDING:"warning",REJECTED:"danger"}[a]||"info"}const Y=a=>{oe(a),L.value=!1};async function oe(a){const o=a,r=new FormData;r.append("messaging_product","whatsapp"),r.append("employer_id",ee.rawUserData.id.toString()),r.append("context_message_id",""),r.append("restaurant_id",v.params.restaurant_id),r.append("to",v.params.user_id),r.append("type","template"),r.append("template",JSON.stringify(o));try{K.sending=!0,await N.post(`${R}/webhook/send/template/`,r,!1),console.log(`✅ Template enviado a ${to}`)}catch(k){console.error(`✗ Error al enviar template a ${to}`,k)}finally{K.sending=!1}}const Z=_([{}]),Q=a=>{a.target.closest(".emoji-picker")||(W.value=!1)};me(()=>{document.addEventListener("click",Q),_e()}),pe(()=>{document.removeEventListener("click",Q)});const L=_(!1);_([]);const v=Ne(),ee=Ue(),W=_(!1),d=_(""),P=_(!1),u=_(null),H=_(!1),p=_(!0),J=Ie(()=>{var a,o;return p.value&&(((a=v.query)==null?void 0:a.expirado)==="true"||((o=v.query)==null?void 0:o.expirado)===!0)}),xe=a=>{p.value=a};ue(()=>{var a;return(a=v.params)==null?void 0:a.restaurant_id},()=>{_e()}),ue(J,a=>{d.value=a?"Conversación expirada":""},{immediate:!0});const K=Le();_([{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"},{id:7,name:"Distrimoster",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"}]);const O=(a="")=>{const o=a.trim().split(" ");return(Array.from(o[0]||"")[0]||"")+(o[1]?Array.from(o[1])[0]:"")},fe=a=>{d.value+=a.i,W.value=!1};let I=null,E=[],j=null;const q=async()=>{if(P.value&&I){I.stop();return}try{j=await navigator.mediaDevices.getUserMedia({audio:!0});const a=MediaRecorder.isTypeSupported("audio/ogg;codecs=opus")?"audio/ogg;codecs=opus":"audio/webm;codecs=opus";I=new MediaRecorder(j,{mimeType:a}),I.ondataavailable=o=>o.data.size&&E.push(o.data),I.onstop=()=>{const o=new Blob(E,{type:a.split(";")[0]});E=[],j.getTracks().forEach(k=>k.stop());const r=a.startsWith("audio/ogg")?"ogg":"webm";u.value={file:new File([o],`audio_${Date.now()}.${r}`,{type:o.type}),url:URL.createObjectURL(o)},P.value=!1},I.start(),P.value=!0}catch(a){console.error("No se pudo abrir el micrófono:",a.name,a.message),P.value=!1,j&&j.getTracks().forEach(o=>o.stop())}},te=()=>{u.value&&URL.revokeObjectURL(u.value.url),u.value=null};pe(()=>{I&&P.value&&I.stop(),j&&j.getTracks().forEach(a=>a.stop())});const we={messaging_product:"whatsapp",employer_id:ee.rawUserData.id,context_message_id:null},ie=async(a,o=null)=>{var k,T;if(J.value||!a.trim())return;const r=new FormData;r.append("messaging_product","whatsapp"),r.append("employer_id",ee.rawUserData.id),r.append("context_message_id",((k=o==null?void 0:o.message_data)==null?void 0:k.wa_id)||null),r.append("restaurant_id",(T=v.params.restaurant_id)==null?void 0:T.toString()),r.append("to",v.params.user_id),r.append("type","text"),r.append("text",JSON.stringify({body:a})),d.value="";try{K.sending=!0,await N.post(`${R}/webhook/send/text/`,r,!1)}catch(C){console.error("Error al enviar texto",C)}K.sending=!1},ne=async()=>{var k;if(J.value||!u.value||H.value)return;const a=u.value;te(),H.value=!0;const o=new FormData;o.append("files",a.file);const r={...we,restaurant_id:(k=v.params.restaurant_id)==null?void 0:k.toString(),to:v.params.user_id,type:"audio",text:{body:""},file_index:0};o.append("payloads",JSON.stringify(r));try{await N.post(`${R}/webhook/send`,o,!1)}catch(T){console.error("Error al enviar audio",T)}H.value=!1},re=async a=>{var T;if(J.value||!(a!=null&&a.length))return;const o=new FormData,r={restaurant_id:(T=v.params.restaurant_id)==null?void 0:T.toString(),to:v.params.user_id,messaging_product:"whatsapp",employer_id:ee.rawUserData.id,context_message_id:null},k=C=>{var y;const{type:s,name:i}=C;if(s.startsWith("image/"))return"image";if(s.startsWith("audio/"))return"audio";if(s.startsWith("video/"))return"video";if(s==="application/pdf")return"document";const c=(y=i.split(".").pop())==null?void 0:y.toLowerCase();return["jpg","jpeg","png","webp"].includes(c)?"image":["mp3","wav","ogg","opus"].includes(c)?"audio":"document"};a.forEach((C,s)=>{o.append("files",C.file),o.append("payloads",JSON.stringify({...r,type:k(C.file),text:{body:C.caption||""},file_index:s}))}),K.sending=!0;try{await N.post(`${R}/webhook/send`,o,!1)}catch(C){console.error("Error al enviar archivos",C)}K.sending=!1},ae=a=>{a.key==="Enter"&&(a.preventDefault(),d.value.trim()&&ie(d.value))},G=a=>{a.key==="Enter"&&u.value&&(a.preventDefault(),ne())};me(()=>window.addEventListener("keydown",G)),pe(()=>window.removeEventListener("keydown",G));async function _e(){if(v.params.restaurant_id){const o=(await N.get(`${Re}/restaurants`)||[]).find(r=>{var k;return r.id==((k=v.params)==null?void 0:k.restaurant_id)})||null;o&&(Z.value=await N.get(`${R}/wabas/${o.waba_id}/templates/`))}}return(a,o)=>{var y,S,w;const r=U("Button"),k=U("RouterView"),T=U("Textarea"),C=U("Column"),s=U("Tag"),i=U("DataTable"),c=U("Dialog");return m(),$("div",{class:"main-container",style:l([n(x).current_chat_theme.bg_image,{}])},[(y=n(v).params)!=null&&y.user_id?(m(),$("div",{key:0,tabindex:"0",class:"top-bar",style:l([{"border-radius":".5rem",gap:"1rem"},n(x).current_chat_theme.bg_bars])},[e("div",yt,[e("div",bt,[e("div",{class:"cliente-img",style:l([`background-color:${n(v).params.color}`,{height:"100%",color:"white",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"}])},g(O(n(v).params.user_name)),5)]),e("div",xt,[e("div",wt,[e("strong",null,[e("h5",{style:l([{"text-transform":"capitalize",margin:"0"},n(x).current_chat_theme.text])},g((S=n(v).params.user_name)==null?void 0:S.substring(0,20)),5)]),e("span",null,"+"+g(n(v).params.user_id),1)]),kt])]),e("div",$t,[h(r,{text:"",class:"p-2"},{default:b(()=>[e("i",{style:l(n(x).current_chat_theme.text),class:"pi pi-search text-2xl"},null,4)]),_:1}),h(r,{text:"",class:"p-2"},{default:b(()=>[e("i",{style:l(n(x).current_chat_theme.text),class:"pi pi-bars text-2xl"},null,4)]),_:1})])],4)):D("",!0),e("div",St,[h(k,null,{default:b(()=>[n(v).params.user_id?(m(),z(Me,{key:0,send_function:re,send_text:ie,change_expiration:xe,ref:"Messages_element"},null,512)):D("",!0)]),_:1})]),(w=n(v).params)!=null&&w.user_id?(m(),$("div",{key:1,class:"chat-bar",tabindex:"0",style:l(n(x).current_chat_theme.bg_bars)},[W.value?(m(),z(n(Be),{key:0,native:!0,style:{position:"absolute",bottom:"4rem","z-index":"1000"},onSelect:fe,class:"emoji-picker"})):D("",!0),e("div",Ct,[h(r,{text:"",style:{"font-size":"2rem","padding-left":"0"},onClick:o[0]||(o[0]=f=>W.value=!W.value)},{default:b(()=>[Et]),_:1}),u.value?(m(),$("div",{key:1,class:"audio-chip",onKeydown:ze(Ve(ne,["prevent"]),["enter"])},[e("audio",{style:{width:"100%","min-width":"28rem","max-width":"42rem"},src:u.value.url,controls:""},null,8,jt),h(r,{text:"",class:"btn-audio-trash p-2",onClick:te},{default:b(()=>[e("i",{style:l(n(x).current_chat_theme.text),class:"pi pi-trash text-2xl p-0"},null,4)]),_:1})],40,Tt)):(m(),z(T,{key:0,modelValue:d.value,"onUpdate:modelValue":o[1]||(o[1]=f=>d.value=f),autoResize:"",class:"message",disabled:J.value,onKeydown:ae,style:l(`${n(x).current_chat_theme.text} ; ${n(x).current_chat_theme.border} `)},null,8,["modelValue","disabled","style"]))]),e("div",Dt,[!u.value&&d.value.trim()===""?(m(),z(r,{key:0,text:"",style:{height:"100%"},onClick:q},{default:b(()=>[e("i",{style:l(n(x).current_chat_theme.text),class:ge(P.value?"pi pi-stop text-2xl text-red-500":"pi pi-microphone text-2xl ")},null,6)]),_:1})):u.value?(m(),z(r,{key:1,disabled:H.value,text:"",onClick:ne},{default:b(()=>[e("i",{style:l(n(x).current_chat_theme.text),class:"pi pi-send text-2xl"},null,4)]),_:1},8,["disabled"])):(m(),z(r,{key:2,style:l(n(x).current_chat_theme.text),text:"",onClick:o[2]||(o[2]=f=>ie(d.value))},{default:b(()=>[Lt]),_:1},8,["style"]))]),e("div",Nt,[h(r,{severity:"danger",style:{},icon:"pi pi-clock",class:"p-2",onClick:o[3]||(o[3]=()=>L.value=!0)}),n(v).query.expirado?(m(),z(r,{key:0,icon:"pi pi-bolt",severity:"warning",style:{},class:"p-2",onClick:o[4]||(o[4]=()=>L.value=!0)})):D("",!0)])],4)):D("",!0),h(c,{visible:L.value,"onUpdate:visible":o[5]||(o[5]=f=>L.value=f),modal:"",header:"Envio de plantilla",style:{width:"90rem"}},{default:b(()=>[h(i,{value:Z.value,dataKey:"id",paginator:"",rows:10,responsiveLayout:"scroll",class:"shadow-md rounded-xl overflow-hidden"},{default:b(()=>[h(C,{class:"my-1 py-1",field:"name",header:"Nombre",bodyClass:"font-medium"}),h(C,{class:"my-1 py-1",header:"Texto"},{body:b(({data:f})=>{var B,M;return[Ce(g((M=(B=f==null?void 0:f.components)==null?void 0:B.find(A=>A.type=="BODY"))==null?void 0:M.text),1)]}),_:1}),h(C,{class:"my-1 py-1",header:"Imagen"},{body:b(({data:f})=>{var B,M,A,le,ce,de;return[(A=(M=(B=f==null?void 0:f.components)==null?void 0:B.find(se=>se.type=="HEADER"))==null?void 0:M.example)!=null&&A.header_handle[0]?(m(),$("img",{key:0,style:{height:"10rem",width:"10rem","aspect-ratio":"1 / 1","object-fit":"cover","border-radius":".5rem",border:"1px solid"},src:(de=(ce=(le=f==null?void 0:f.components)==null?void 0:le.find(se=>se.type=="HEADER"))==null?void 0:ce.example)==null?void 0:de.header_handle[0],alt:""},null,8,Ut)):D("",!0)]}),_:1}),h(C,{class:"my-1 py-1",header:"Estado"},{body:b(({data:f})=>[h(s,{severity:F(f.status)},{default:b(()=>[Ce(g(f.status),1)]),_:2},1032,["severity"])]),_:1}),h(C,{class:"my-1 py-1",headerStyle:"width:8rem",header:"Acciones"},{body:b(({data:f})=>[e("div",It,[h(r,{icon:"pi pi-send",label:"Enviar",severity:"help",onClick:B=>Y(f)},null,8,["onClick"])])]),_:1})]),_:1},8,["value"]),Rt]),_:1},8,["visible"])],4)}}}),Vt=ke(zt,[["__scopeId","data-v-8589f3d5"]]);const Bt={__name:"chats",setup(V){const x=$e();return(F,Y)=>(m(),$("div",{class:"chat-container",style:l(n(x).current_chat_theme.bg)},[h(gt,{style:{"box-shadow":".5rem 0 1rem #00000010"},class:"sidebar-left",restaurant:{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"}}),h(Vt)],4))}},Pt=ke(Bt,[["__scopeId","data-v-eb4832e3"]]);export{Pt as default};
