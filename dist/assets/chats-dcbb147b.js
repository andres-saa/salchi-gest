import{H as Le,h as v,D as de,i as ue,I as me,j as U,J as z,g as I,o as m,c as E,a as t,n as l,u as o,F as ge,r as ye,d as N,e as y,t as h,f as _,b as pe,k as T,p as je,m as De,_ as $e,C as Ue,l as Ie,G as Re,U as ze,q as ke,K as Ve,L as Oe}from"./index-2e8d2194.js";import{u as Ne}from"./chat-d83abbdb.js";import{c as Se,P as Ae}from"./Messages.vue_vue_type_style_index_0_scoped_09e7a26a_lang-2a3a70a9.js";/* empty css                                                             */import Me from"./Messages-7eb0dcdb.js";const be=V=>(je("data-v-c6f0039f"),V=V(),De(),V),Be={class:"sidebar-container",style:{position:"relative"}},Fe={class:"header"},Pe=be(()=>t("strong",null," Notificaciones ",-1)),We=[Pe],Je=["onClick"],Ke={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},qe={style:{display:"flex","flex-direction":"column",width:"100%"}},He=be(()=>t("h3",null,[t("b",null," Buscar un usuario")],-1)),Ge=["onClick"],Xe={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},Ye={style:{"grid-area":"check",display:"flex","justify-content":"end",gap:".5rem"}},Ze={key:0,style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold"}},Qe={style:{color:"white"}},et=be(()=>t("i",{style:{color:"greenyellow"},class:"fa-solid fa-check-double"},null,-1)),tt={key:1,style:{"text-align":"center",padding:".5rem",color:"#ffffff80"}},at={class:"flex align-items-center"},st=["src"],ot={class:"flex align-items-center"},it=["src"],rt={style:{display:"flex",gap:"1rem"}},nt={style:{color:"white"}},lt={class:"statuses"},ct={key:0,style:{display:"flex","justify-content":"end",margin:"0rem 0",gap:"1rem",padding:"1rem 1rem"}},dt=["onClick"],ut={class:"avatar",style:{"grid-area":"imagen",height:"100%",width:"100%",display:"flex","align-items":"center"}},mt={style:{"grid-area":"check",display:"flex","justify-content":"end",gap:".5rem"}},pt={key:0,style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold"}},ft={style:{color:"white"}},_t=be(()=>t("i",{style:{color:"greenyellow"},class:"fa-solid fa-check-double"},null,-1)),ht={style:{display:"flex","justify-content":"center",margin:"2rem 0",gap:"1rem"}},vt={key:1,style:{"text-align":"center",padding:".5rem",color:"#ffffff80"}},Ee=1e3,gt=Le({__name:"Sidebar",props:{restaurant:Object},setup(V){const w=v(!1),M=v(!1),X=v(""),se=v(!1),Y=v([]);let Z=null;const D=v(100),g=v(0);de(X,a=>{Z&&clearTimeout(Z),Z=setTimeout(()=>{const s=a.trim().toLowerCase();if(!s){Y.value=[];return}const b=(u.sidebars[p.value.id]??[]).filter($=>{const S=($.nombre??"").toLowerCase(),W=($.wa_id??"").toLowerCase();return S.includes(s)||W.includes(s)});Y.value=b,b.length===0&&alert("Buscando en la base de datos")},100)});const Q=()=>{D.value>=100&&(D.value-=100,g.value-=100)},B=a=>{a.target.closest(".notifications")||(w.value=!1)};ue(()=>{document.addEventListener("click",B)}),me(()=>{document.removeEventListener("click",B)});const c=Se(),F=V,u=Ne(),K=[{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"},{id:7,name:"Distrimoster",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"},{id:8,name:"Pruebas",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"}],p=v(F.restaurant||K[0]);v([{label:"Todos",textColor:"#4CAF50"},{label:"Sin leer",textColor:"#2196F3"},{label:"Favoritos",textColor:"#FFC107"},{label:"Preocupantes",textColor:"#F44336"},{label:"Top",textColor:"#9C27B0"}]);const P=async a=>{u.current_user=a,M.value=!1,w.value=!1;try{await U.post(`${z}/read-message/${a.user_id}/${p.value.id}`,!1)}catch(s){console.error("No se pudo marcar como leído",s)}a.unreaded=0},xe=async a=>{var s;u.current_user=a.user_info,w.value=!1;try{await U.post(`${z}/read-message/${a.user_info.user_id}/${p.value.id}`,!1),await U.post(`${z}/view_notification/${a.id}`,!1),u.notifications[p.value.id]=await U.get(`${z}/notifications/${p.value.id}`);const d=(s=u.sidebars[p.value.id])==null?void 0:s.findIndex(b=>b.user_id==a.user_info.user_id);console.log(d),d!==-1&&(u.sidebars[p.value.id][d].unreaded=0)}catch(d){console.error("No se pudo marcar como leído",d)}},fe=[{label:"SIN LEER",bg:"#f39c12",icon:"fa-solid fa-envelope-open"},{label:"LEIDOS",bg:"#16a085",icon:"fa-solid fa-envelope-circle-check"}],C=v({label:"SIN LEER",bg:"#f39c12",icon:"fa-solid fa-envelope-open"}),_e=v(0);let oe=0;const k=v(!1),A=v(!1),L=v(null),ie=(a="")=>{const s=a.trim().split(" ");return(Array.from(s[0]||"")[0]||"")+(s[1]?Array.from(s[1])[0]:"")};ue(async()=>{u.notifications[p.value.id]=await U.get(`${z}/notifications/${p.value.id}`)});const he=a=>a==="9+"?10:Number(a??0),we=(a,s)=>{const d=u.sidebars[a]||[];s.forEach(b=>{const $=d.findIndex(S=>S.wa_id===b.wa_id);if($===-1)d.push(b);else{const S=d[$],W=S.ultimo_mensaje_id!==b.ultimo_mensaje_id,ae=S.color!==b.color,f=S.nombre!==b.nombre,j=b.unreaded!=S.unreaded;(W||j||ae||f)&&(d[$]=b)}}),u.sidebars[a]=d,_e.value=d.reduce((b,$)=>b+he($.unreaded),0)},re=v(!1),q=async()=>{if(k.value||A.value)return;k.value=!0;const a=`${z}/last-contact-messages/${p.value.id}?limit=${Ee}&offset=${oe}&clasificacion=${C.value.label}`,s=await U.get(a,!1);s.length<Ee&&(A.value=!0),oe+=s.length,we(p.value.id,s),k.value=!1};let ee=v(!0);const te=async()=>{var d;const a=L.value;if(!a||k.value||A.value||!ee)return;if(a.scrollTop+a.clientHeight>=a.scrollHeight-100){if(re.value=!0,D.value,ee.value)if(g.value+100>=((d=u.sidebars[p.value])==null?void 0:d.length)){D.value=1e3;return}else D.value+=100,ee.value=!1;setTimeout(()=>{ee.value=!0},1e3)}};de(C,()=>{L.value.scrollTo({top:0}),D.value=100});const ve=a=>{const s=p.value.id,d=u.sidebars[s]||[],b=d.findIndex($=>$.wa_id===a.wa_id);b!==-1?(d.splice(b,1),u.sidebars[s]=[a,...d]):u.sidebars[s]=[a,...d],_e.value=u.sidebars[s].reduce(($,S)=>$+Number(S.unreaded||0),0)};let R=null;const i=()=>{const a=`wss://sockets-service.salchimonster.com/ws/salchimonster-${p.value.id}`;R=new WebSocket(a),R.onopen=()=>console.log("WebSocket conectado a",a),R.onerror=s=>console.error("WebSocket error",s),R.onclose=()=>setTimeout(i,5e3),R.onmessage=async s=>{const d=JSON.parse(s.data);d!=null&&d.user_id&&ve(d)}};let r=null;const n=()=>{const a=`wss://sockets-service.salchimonster.com/ws/salchimonster-notifications-${p.value.id}`;r=new WebSocket(a),r.onopen=()=>console.log("WebSocket conectado a",a),r.onerror=s=>console.error("WebSocket error",s),r.onclose=()=>setTimeout(n,5e3),r.onmessage=async s=>{u.notifications[p.value.id]=await U.get(`${z}/notifications/${p.value.id}`),se.value=!0,setTimeout(()=>{se.value=!1},1e3),JSON.parse(s.data)}};de(p,async a=>{oe=0,A.value=!1,u.sidebars[a.id]=[],R&&R.close(),i(),n(),await q(),x.value=!1,setTimeout(()=>{x.value=!0},0)}),ue(async()=>{var a;await q(),(a=L.value)==null||a.addEventListener("scroll",te),i(),n()}),me(()=>{var a;(a=L.value)==null||a.removeEventListener("scroll",te),R&&R.close()});const x=v(!0),O=a=>{C.value=a,x.value=!1,setTimeout(()=>{x.value=!0},0)};return(a,s)=>{var f,j,J,H,ne,le,ce;const d=I("RouterLink"),b=I("InputText"),$=I("ProgressSpinner"),S=I("Button"),W=I("Dialog"),ae=I("Dropdown");return m(),E("div",Be,[t("div",Fe,[t("div",{class:"notifications",style:l([w.value?{height:"calc(100vh - 8rem)",top:"4rem",boxShadow:"0 1rem 1rem #00000040"}:{height:0,overflow:"hidden",top:"-2rem"},{width:"100%","max-width":"90%","background-color":"#ffffff90","max-height":"90vh",overflow:"auto",position:"absolute","z-index":"9",transition:"all linear .2s","border-radius":".5rem",right:"0","backdrop-filter":"blur(5px)",display:"flex","flex-direction":"column"}])},[t("h4",{class:"my-3 px-3",style:l(o(c).current_chat_theme.text)},We,4),(m(!0),E(ge,null,ye((j=(f=o(u))==null?void 0:f.notifications)==null?void 0:j[p.value.id],(e,G)=>(m(),N(d,{"active-class":o(c).current_chat_theme.name==="dark"?"active":"active-light",key:G,to:`/chat/chats/messages/${p.value.id}/${e.user_info.wa_id}/${(e.user_info.nombre||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^A-Za-z0-9_-]/g,"")||"n"}/${e.user_info.color}?expirado=${e.user_info.expirado}&expira-en=${e.user_info.tiempo_para_expirar}`},{default:y(()=>[t("div",{class:"chat2",onClick:()=>xe(e),style:l(e.resolved?"background-color: #fff":"background-color: #b6f8ff59")},[t("div",Ke,[t("div",{style:l([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${e.user_info.color||"black"}`])},h(ie(e.user_info.nombre)),5)]),t("div",{style:l([{"grid-area":"nombre"},`${o(c).current_chat_theme.text} ; ${e.resolved?"":"font-weight: bold;"}`])},h(e.description),5),t("span",{style:l([{"grid-area":"mensaje",color:"#ffffff80",opacity:".5"},o(c).current_chat_theme.text])},h(e.user_info.nombre.slice(0,20))+"... ",5),t("p",{class:"p-0 m-0",style:l([{"grid-area":"fecha","text-align":"end","min-width":"max-content"},o(c).current_chat_theme.text])},h(e.user_info.hora_ultimo_mensaje),5)],12,Je)]),_:2},1032,["active-class","to"]))),128))],4),_(W,{closable:!1,header:"Buscar un usuario",visible:M.value,"onUpdate:visible":s[2]||(s[2]=e=>M.value=e),style:{width:"50rem"},modal:""},{header:y(()=>[t("div",qe,[He,_(b,{modelValue:X.value,"onUpdate:modelValue":s[0]||(s[0]=e=>X.value=e),style:{width:"100%"},placeholder:"Escriba el nombre o numero del usuario"},null,8,["modelValue"])])]),default:y(()=>[t("div",{class:pe(["",x.value?"chats active-new":"chats"]),style:{height:"67vh"},ref_key:"chatsContainer",ref:L,onScroll:te},[(m(!0),E(ge,null,ye(Y.value,(e,G)=>(m(),N(d,{"active-class":o(c).current_chat_theme.name=="dark"?"active":"active-light",key:G,to:`/chat/chats/messages/${p.value.id}/${e.wa_id}/${e.nombre}/${e.color}?expirado=${e.expirado}&?expira-en?=${e.tiempo_para_expirar}`},{default:y(()=>[t("div",{class:"chat",onClick:()=>P(e)},[t("div",Xe,[t("div",{style:l([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${e.color||"black"}`])},h(ie(e.nombre)),5)]),t("div",{style:l([{"grid-area":"nombre","text-transform":"capitalize","font-weight":"500"},o(c).current_chat_theme.text])},h(e.nombre),5),t("div",{style:l([{"grid-area":"numero","text-transform":"capitalize",opacity:".7"},o(c).current_chat_theme.text])},"+"+h(e.wa_id),5),t("span",{style:l([{"grid-area":"mensaje",color:"#ffffff80",opacity:".5"},o(c).current_chat_theme.text])},h(e.mensaje_truncado),5),t("span",{style:l([{"grid-area":"fecha","text-align":"end"},o(c).current_chat_theme.text])},h(e.abreviatura||e.fecha_ultimo_mensaje),5),t("span",{style:l([{"grid-area":"hora",color:"#ffffff80",opacity:".5","text-align":"end"},o(c).current_chat_theme.text])},h(e.hora_ultimo_mensaje),5),t("div",Ye,[e.unreaded>0?(m(),E("div",Ze,[t("span",Qe,h(e.unreaded),1)])):T("",!0),et])],8,Ge)]),_:2},1032,["active-class","to"]))),128)),k.value?(m(),E("div",{key:0,style:l(`bottom:0;padding-bottom:1rem; background:linear-gradient(to bottom , transparent 3%, ${o(c).current_chat_theme.gradient});display:flex; position: absolute; z-index: 100;width:100%; color: white`)},[(m(),N($,{key:0,style:{width:"50px",height:"50px"},strokeWidth:"8",fill:"transparent",animationDuration:".3s","aria-label":"Custom ProgressSpinner"}))],4)):T("",!0),A.value?(m(),E("div",tt,"No hay más chats.")):T("",!0)],34),_(S,{rounded:"",onClick:s[1]||(s[1]=e=>M.value=!1),icon:"pi pi-times  text-xl",style:{position:"absolute",top:"-1rem",right:"-1rem"},severity:"danger"})]),_:1},8,["visible"]),_(ae,{modelValue:p.value,"onUpdate:modelValue":s[3]||(s[3]=e=>p.value=e),options:K,optionLabel:"name",style:l([{"background-color":"#ffffff20",outline:"none","box-shadow":"none"},o(c).current_chat_theme.border])},{option:y(e=>[t("div",at,[t("img",{src:e.option.img,alt:"Logo",style:{width:"24px",height:"24px","margin-right":"8px","object-fit":"contain"}},null,8,st),t("span",null,[t("b",null,h(e.option.name),1)])])]),value:y(e=>[t("div",ot,[e.value?(m(),E("img",{key:0,src:e.value.img,alt:"Logo",style:{width:"24px",height:"24px","margin-right":"8px","object-fit":"contain"}},null,8,it)):T("",!0),t("span",{style:l(o(c).current_chat_theme.text)},h(e.value?e.value.name:"Selecciona"),5)])]),_:1},8,["modelValue","style"]),t("div",rt,[_(S,{class:"options",text:""},{default:y(()=>[t("i",{class:"pi pi-search text-2xl",onClick:s[4]||(s[4]=e=>M.value=!0),style:l(o(c).current_chat_theme.text)},null,4)]),_:1}),t("div",{class:"notifications",style:{position:"relative",cursor:"pointer"},onClick:s[5]||(s[5]=e=>w.value=!w.value)},[_(S,{class:"options",text:"",style:{opacity:".5"}},{default:y(()=>[t("i",{class:"pi pi-bell text-2xl notifications",style:l(o(c).current_chat_theme.text)},null,4)]),_:1}),t("div",{class:pe(se.value?"load":""),style:{height:"1.5rem",width:"1.5rem","border-radius":"50%","background-color":"rgb(156,39,176)",position:"absolute",top:"-1rem",right:"-.7rem",display:"flex","align-items":"center","justify-content":"center","font-weight":"bold",padding:".8rem"}},[t("span",nt,h(((ne=(H=(J=o(u))==null?void 0:J.notifications)==null?void 0:H[p.value.id])==null?void 0:ne.length)||0),1)],2)]),_(S,{class:"options",text:""},{default:y(()=>[t("i",{class:"pi pi-bars text-2xl",style:l(o(c).current_chat_theme.text)},null,4)]),_:1})])]),t("div",lt,[(m(),E(ge,null,ye(fe,(e,G)=>_(S,{style:l([{"border-radius":".3rem",padding:"0.3rem","text-transform":"capitalize"},e.label===C.value.label?{backgroundColor:e.bg,color:"#fff"}:{backgroundColor:"#ffffff20",color:e.bg}]),text:"",icon:e.icon,key:G,onClick:()=>O(e),class:"status",label:e.label.toLowerCase()},null,8,["icon","onClick","label","style"])),64))]),g.value>0?(m(),E("div",ct,[_(S,{disabled:k.value,icon:k.value?"pi pi-spin pi-spinner":"pi pi-angle-left",onClick:Q,severity:"help",label:k.value?"cargando...":"atras"},null,8,["disabled","icon","label"])])):T("",!0),t("div",{class:pe(["",x.value?"chats active-new":"chats"]),ref_key:"chatsContainer",ref:L,onScroll:te},[(m(!0),E(ge,null,ye(((le=o(u).sidebars[p.value.id])==null?void 0:le.filter(e=>{if(C.value.label==="TODO")return!0;if(C.value.label==="SIN LEER")return e.unreaded>0;if(C.value.label==="LEIDOS")return e.unreaded==0}).slice(g.value,D.value))||[],(e,G)=>(m(),N(d,{"active-class":o(c).current_chat_theme.name=="dark"?"active":"active-light",key:G,to:`/chat/chats/messages/${p.value.id}/${e.wa_id}/${e.nombre}/${e.color}?expirado=${e.expirado}&?expira-en?=${e.tiempo_para_expirar}`},{default:y(()=>[t("div",{class:"chat",onClick:()=>P(e)},[t("div",ut,[t("div",{style:l([{height:"3rem",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"},`background-color:${e.color||"black"}`])},h(ie(e.nombre)),5)]),t("div",{style:l([{"grid-area":"nombre","text-transform":"capitalize","font-weight":"500"},o(c).current_chat_theme.text])},h(e.nombre),5),t("div",{style:l([{"grid-area":"numero","text-transform":"capitalize",opacity:".7"},o(c).current_chat_theme.text])},"+"+h(e.wa_id),5),t("span",{style:l([{"grid-area":"mensaje",color:"#ffffff80",opacity:".5"},o(c).current_chat_theme.text])},h(e.mensaje_truncado),5),t("span",{style:l([{"grid-area":"fecha","text-align":"end"},o(c).current_chat_theme.text])},h(e.abreviatura||e.fecha_ultimo_mensaje),5),t("span",{style:l([{"grid-area":"hora",color:"#ffffff80",opacity:".5","text-align":"end"},o(c).current_chat_theme.text])},h(e.hora_ultimo_mensaje),5),t("div",mt,[e.unreaded>0?(m(),E("div",pt,[t("span",ft,h(e.unreaded),1)])):T("",!0),_t])],8,dt)]),_:2},1032,["active-class","to"]))),128)),k.value&&((ce=o(u).sidebars[p.value.id])==null?void 0:ce.length)<2?(m(),E("div",{key:0,style:l(`bottom:0;padding-bottom:1rem; background:linear-gradient(to bottom , transparent 3%, ${o(c).current_chat_theme.gradient});display:flex; position: absolute; z-index: 100;width:100%; color: white`)},[(m(),N($,{key:0,style:{width:"50px",height:"50px"},strokeWidth:"8",fill:"transparent",animationDuration:".3s","aria-label":"Custom ProgressSpinner"}))],4)):T("",!0),t("div",ht,[_(S,{disabled:k.value,icon:k.value?"pi pi-spin pi-spinner":"",onClick:q,severity:"help",label:k.value?"cargando...":"Cargar mas"},null,8,["disabled","icon","label"])]),A.value?(m(),E("div",vt,"No hay más chats.")):T("",!0)],34)])}}}),Te=$e(gt,[["__scopeId","data-v-c6f0039f"]]),Ce=V=>(je("data-v-ed74fb8a"),V=V(),De(),V),yt={class:"top-bar-left"},bt={style:{height:"3rem",width:"3rem",display:"flex","align-items":"center"}},xt={class:"top-bar-info"},wt={style:{display:"flex","flex-direction":"column"}},kt={style:{display:"flex","align-items":"center",gap:"1rem"}},$t={style:{height:"100%",overflow:"auto"}},St={class:"message-area"},Ct=Ce(()=>t("i",{class:"fas fa-laugh-wink emoji-picker"},null,-1)),Et=["onKeydown"],Tt=["src"],Lt={style:{position:"relative",transition:".2s"}},jt=Ce(()=>t("i",{class:"pi pi-send text-2xl"},null,-1)),Dt={style:{display:"flex",gap:"1rem"}},Nt=["src"],Ut={class:"flex gap-2"},It=Ce(()=>t("div",{style:{width:"100%",display:"flex","justify-content":"end"}},null,-1)),Rt=Le({__name:"Main",setup(V){const w=Se();function M(i){return{APPROVED:"success",PENDING:"warning",REJECTED:"danger"}[i]||"info"}const X=i=>{se(i),D.value=!1};async function se(i){const r=i,n=new FormData;n.append("messaging_product","whatsapp"),n.append("employer_id",Q.rawUserData.id.toString()),n.append("context_message_id",""),n.append("restaurant_id",g.params.restaurant_id),n.append("to",g.params.user_id),n.append("type","template"),n.append("template",JSON.stringify(r));try{C.sending=!0,await U.post(`${z}/webhook/send/template/`,n,!1),console.log(`✅ Template enviado a ${to}`)}catch(x){console.error(`✗ Error al enviar template a ${to}`,x)}finally{C.sending=!1}}const Y=v([{}]),Z=i=>{i.target.closest(".emoji-picker")||(B.value=!1)};ue(()=>{document.addEventListener("click",Z),R()}),me(()=>{document.removeEventListener("click",Z)});const D=v(!1);v([]);const g=Ue(),Q=Ie(),B=v(!1),c=v(""),F=v(!1),u=v(null),K=v(!1),p=v(!0),P=Re(()=>{var i,r;return p.value&&(((i=g.query)==null?void 0:i.expirado)==="true"||((r=g.query)==null?void 0:r.expirado)===!0)}),xe=i=>{p.value=i};de(()=>{var i;return(i=g.params)==null?void 0:i.restaurant_id},()=>{R()}),de(P,i=>{c.value=i?"Conversación expirada":""},{immediate:!0});const fe={"SIN DATOS":{bg:"#7f8c8d",icon:"fa-circle-question"},PREOCUPANTE:{bg:"#e74c3c",icon:"fa-triangle-exclamation"},CASUAL:{bg:"#e67e22",icon:"fa-person-walking"},FRECUENTE:{bg:"#27ae60",icon:"fa-repeat"},TOP:{bg:"#2980b9",icon:"fa-ranking-star"},ESTRELLA:{bg:"#8e44ad",icon:"fa-star"}},C=Ne();v([{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"},{id:7,name:"Distrimoster",img:"https://backend.salchimonster.com/read-photo-product/iX6UiE6e"}]);const _e=(i="")=>{const r=i.trim().split(" ");return(Array.from(r[0]||"")[0]||"")+(r[1]?Array.from(r[1])[0]:"")},oe=i=>{c.value+=i.i,B.value=!1};let k=null,A=[],L=null;const ie=async()=>{if(F.value&&k){k.stop();return}try{L=await navigator.mediaDevices.getUserMedia({audio:!0});const i=MediaRecorder.isTypeSupported("audio/ogg;codecs=opus")?"audio/ogg;codecs=opus":"audio/webm;codecs=opus";k=new MediaRecorder(L,{mimeType:i}),k.ondataavailable=r=>r.data.size&&A.push(r.data),k.onstop=()=>{const r=new Blob(A,{type:i.split(";")[0]});A=[],L.getTracks().forEach(x=>x.stop());const n=i.startsWith("audio/ogg")?"ogg":"webm";u.value={file:new File([r],`audio_${Date.now()}.${n}`,{type:r.type}),url:URL.createObjectURL(r)},F.value=!1},k.start(),F.value=!0}catch(i){console.error("No se pudo abrir el micrófono:",i.name,i.message),F.value=!1,L&&L.getTracks().forEach(r=>r.stop())}},he=()=>{u.value&&URL.revokeObjectURL(u.value.url),u.value=null};me(()=>{k&&F.value&&k.stop(),L&&L.getTracks().forEach(i=>i.stop())});const we={messaging_product:"whatsapp",employer_id:Q.rawUserData.id,context_message_id:null},re=async(i,r=null)=>{var x,O;if(P.value||!i.trim())return;const n=new FormData;n.append("messaging_product","whatsapp"),n.append("employer_id",Q.rawUserData.id),n.append("context_message_id",((x=r==null?void 0:r.message_data)==null?void 0:x.wa_id)||null),n.append("restaurant_id",(O=g.params.restaurant_id)==null?void 0:O.toString()),n.append("to",g.params.user_id),n.append("type","text"),n.append("text",JSON.stringify({body:i})),c.value="";try{C.sending=!0,await U.post(`${z}/webhook/send/text/`,n,!1)}catch(a){console.error("Error al enviar texto",a)}C.sending=!1},q=async()=>{var x;if(P.value||!u.value||K.value)return;const i=u.value;he(),K.value=!0;const r=new FormData;r.append("files",i.file);const n={...we,restaurant_id:(x=g.params.restaurant_id)==null?void 0:x.toString(),to:g.params.user_id,type:"audio",text:{body:""},file_index:0};r.append("payloads",JSON.stringify(n));try{await U.post(`${z}/webhook/send`,r,!1)}catch(O){console.error("Error al enviar audio",O)}K.value=!1},ee=async i=>{var O;if(P.value||!(i!=null&&i.length))return;const r=new FormData,n={restaurant_id:(O=g.params.restaurant_id)==null?void 0:O.toString(),to:g.params.user_id,messaging_product:"whatsapp",employer_id:Q.rawUserData.id,context_message_id:null},x=a=>{var $;const{type:s,name:d}=a;if(s.startsWith("image/"))return"image";if(s.startsWith("audio/"))return"audio";if(s.startsWith("video/"))return"video";if(s==="application/pdf")return"document";const b=($=d.split(".").pop())==null?void 0:$.toLowerCase();return["jpg","jpeg","png","webp"].includes(b)?"image":["mp3","wav","ogg","opus"].includes(b)?"audio":"document"};i.forEach((a,s)=>{r.append("files",a.file),r.append("payloads",JSON.stringify({...n,type:x(a.file),text:{body:a.caption||""},file_index:s}))}),C.sending=!0;try{await U.post(`${z}/webhook/send`,r,!1)}catch(a){console.error("Error al enviar archivos",a)}C.sending=!1},te=i=>{i.key==="Enter"&&(i.preventDefault(),c.value.trim()&&re(c.value))},ve=i=>{i.key==="Enter"&&u.value&&(i.preventDefault(),q())};ue(()=>window.addEventListener("keydown",ve)),me(()=>window.removeEventListener("keydown",ve));async function R(){if(g.params.restaurant_id){const r=(await U.get(`${ze}/restaurants`)||[]).find(n=>{var x;return n.id==((x=g.params)==null?void 0:x.restaurant_id)})||null;r&&(Y.value=await U.get(`${z}/wabas/${r.waba_id}/templates/`))}}return(i,r)=>{var $,S,W,ae;const n=I("Button"),x=I("RouterView"),O=I("Textarea"),a=I("Column"),s=I("Tag"),d=I("DataTable"),b=I("Dialog");return m(),E("div",{class:"main-container",style:l([o(w).current_chat_theme.bg_image,{}])},[($=o(g).params)!=null&&$.user_id?(m(),E("div",{key:0,tabindex:"0",class:"top-bar",style:l([{"border-radius":".5rem",gap:"1rem"},o(w).current_chat_theme.bg_bars])},[t("div",yt,[t("div",bt,[t("div",{class:"cliente-img",style:l([`background-color:${o(g).params.color}`,{height:"100%",color:"white",width:"3rem","aspect-ratio":"1/1","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","text-transform":"uppercase","font-size":"1.3rem"}])},h(_e(o(g).params.user_name)),5)]),t("div",xt,[t("div",wt,[t("strong",null,[t("h5",{style:l([{"text-transform":"capitalize",margin:"0"},o(w).current_chat_theme.text])},h((S=o(g).params.user_name)==null?void 0:S.substring(0,20)),5)]),t("span",null,"+"+h(o(g).params.user_id),1)]),t("div",null,[o(C).current_user.clasification?(m(),N(n,{key:0,style:l({height:"2.3rem",display:"flex",alignItems:"center",textTransform:"capitalize",gap:"0.35rem",backgroundColor:((W=fe[o(C).current_user.clasification])==null?void 0:W.bg)||"#7f8c8d",color:"#fff"})},{default:y(()=>{var f,j;return[t("i",{class:pe(["fa-solid",(f=fe[o(C).current_user.clasification])==null?void 0:f.icon]),"aria-hidden":"true",style:{"font-size":"0.9rem"}},null,2),ke(" "+h((j=o(C).current_user.clasification)==null?void 0:j.toLowerCase())+" "+h(o(C).current_user.times_purchased)+" compras ",1)]}),_:1},8,["style"])):T("",!0)])])]),t("div",kt,[_(n,{icon:"pi pi-shopping-cart",class:"p-2",style:{color:"white","min-width":"max-content"},severity:"warning",label:"Ing. Ped"}),_(n,{text:"",class:"p-2"},{default:y(()=>[t("i",{style:l(o(w).current_chat_theme.text),class:"pi pi-search text-2xl"},null,4)]),_:1}),_(n,{text:"",class:"p-2"},{default:y(()=>[t("i",{style:l(o(w).current_chat_theme.text),class:"pi pi-bars text-2xl"},null,4)]),_:1})])],4)):T("",!0),t("div",$t,[_(x,null,{default:y(()=>[o(g).params.user_id?(m(),N(Me,{key:0,send_function:ee,send_text:re,change_expiration:xe,ref:"Messages_element"},null,512)):T("",!0)]),_:1})]),(ae=o(g).params)!=null&&ae.user_id?(m(),E("div",{key:1,class:"chat-bar",tabindex:"0",style:l(o(w).current_chat_theme.bg_bars)},[B.value?(m(),N(o(Ae),{key:0,native:!0,style:{position:"absolute",bottom:"4rem","z-index":"1000"},onSelect:oe,class:"emoji-picker"})):T("",!0),t("div",St,[_(n,{text:"",style:{"font-size":"2rem","padding-left":"0"},onClick:r[0]||(r[0]=f=>B.value=!B.value)},{default:y(()=>[Ct]),_:1}),u.value?(m(),E("div",{key:1,class:"audio-chip",onKeydown:Ve(Oe(q,["prevent"]),["enter"])},[t("audio",{style:{width:"100%","min-width":"28rem","max-width":"42rem"},src:u.value.url,controls:""},null,8,Tt),_(n,{text:"",class:"btn-audio-trash p-2",onClick:he},{default:y(()=>[t("i",{style:l(o(w).current_chat_theme.text),class:"pi pi-trash text-2xl p-0"},null,4)]),_:1})],40,Et)):(m(),N(O,{key:0,modelValue:c.value,"onUpdate:modelValue":r[1]||(r[1]=f=>c.value=f),autoResize:"",class:"message",disabled:P.value,onKeydown:te,style:l(`${o(w).current_chat_theme.text} ; ${o(w).current_chat_theme.border} `)},null,8,["modelValue","disabled","style"]))]),t("div",Lt,[!u.value&&c.value.trim()===""?(m(),N(n,{key:0,text:"",style:{height:"100%"},onClick:ie},{default:y(()=>[t("i",{style:l(o(w).current_chat_theme.text),class:pe(F.value?"pi pi-stop text-2xl text-red-500":"pi pi-microphone text-2xl ")},null,6)]),_:1})):u.value?(m(),N(n,{key:1,disabled:K.value,text:"",onClick:q},{default:y(()=>[t("i",{style:l(o(w).current_chat_theme.text),class:"pi pi-send text-2xl"},null,4)]),_:1},8,["disabled"])):(m(),N(n,{key:2,style:l(o(w).current_chat_theme.text),text:"",onClick:r[2]||(r[2]=f=>re(c.value))},{default:y(()=>[jt]),_:1},8,["style"]))]),t("div",Dt,[_(n,{severity:"danger",style:{},icon:"pi pi-clock",class:"p-2",onClick:r[3]||(r[3]=()=>D.value=!0)}),o(g).query.expirado?(m(),N(n,{key:0,icon:"pi pi-bolt",severity:"warning",style:{},class:"p-2",onClick:r[4]||(r[4]=()=>D.value=!0)})):T("",!0)])],4)):T("",!0),_(b,{visible:D.value,"onUpdate:visible":r[5]||(r[5]=f=>D.value=f),modal:"",header:"Envio de plantilla",style:{width:"90rem"}},{default:y(()=>[_(d,{value:Y.value,dataKey:"id",paginator:"",rows:10,responsiveLayout:"scroll",class:"shadow-md rounded-xl overflow-hidden"},{default:y(()=>[_(a,{class:"my-1 py-1",field:"name",header:"Nombre",bodyClass:"font-medium"}),_(a,{class:"my-1 py-1",header:"Texto"},{body:y(({data:f})=>{var j,J;return[ke(h((J=(j=f==null?void 0:f.components)==null?void 0:j.find(H=>H.type=="BODY"))==null?void 0:J.text),1)]}),_:1}),_(a,{class:"my-1 py-1",header:"Imagen"},{body:y(({data:f})=>{var j,J,H,ne,le,ce;return[(H=(J=(j=f==null?void 0:f.components)==null?void 0:j.find(e=>e.type=="HEADER"))==null?void 0:J.example)!=null&&H.header_handle[0]?(m(),E("img",{key:0,style:{height:"10rem",width:"10rem","aspect-ratio":"1 / 1","object-fit":"cover","border-radius":".5rem",border:"1px solid"},src:(ce=(le=(ne=f==null?void 0:f.components)==null?void 0:ne.find(e=>e.type=="HEADER"))==null?void 0:le.example)==null?void 0:ce.header_handle[0],alt:""},null,8,Nt)):T("",!0)]}),_:1}),_(a,{class:"my-1 py-1",header:"Estado"},{body:y(({data:f})=>[_(s,{severity:M(f.status)},{default:y(()=>[ke(h(f.status),1)]),_:2},1032,["severity"])]),_:1}),_(a,{class:"my-1 py-1",headerStyle:"width:8rem",header:"Acciones"},{body:y(({data:f})=>[t("div",Ut,[_(n,{icon:"pi pi-send",label:"Enviar",severity:"help",onClick:j=>X(f)},null,8,["onClick"])])]),_:1})]),_:1},8,["value"]),It]),_:1},8,["visible"])],4)}}}),zt=$e(Rt,[["__scopeId","data-v-ed74fb8a"]]);const Vt={__name:"chats",setup(V){const w=Se();return(M,X)=>(m(),E("div",{class:"chat-container",style:l(o(w).current_chat_theme.bg)},[_(Te,{style:{"box-shadow":".5rem 0 1rem #00000010"},class:"sidebar-left",restaurant:{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"}}),_(zt),_(Te,{style:{"box-shadow":"-.5rem 0 1rem #00000010"},class:"sidebar-right",restaurant:{id:1,name:"Salchimonster",img:"https://backend.salchimonster.com/read-photo-product/xai0dVnL"}})],4))}},Pt=$e(Vt,[["__scopeId","data-v-ef52e81a"]]);export{Pt as default};
